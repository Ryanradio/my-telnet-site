<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Vault Analytics | True Physics V6 - Pole Recommendation Engine</title>
    <style>
        :root {
            --primary: #0f172a;
            --accent: #6366f1;
            --danger: #ef4444;  
            --warning: #f59e0b; 
            --success: #10b981; 
            --stall: #64748b;   
            --bg: #f8fafc;
            --card: #ffffff;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            background: var(--card);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 2.5rem 2rem;
            text-align: center;
            position: relative;
        }
        header h1 { margin: 0; font-size: 2rem; font-weight: 800; letter-spacing: -1px; }
        header p { margin: 0.5rem 0 0; opacity: 0.7; font-size: 0.95rem; font-weight: 400; }
        
        .badge-beta {
            background: var(--accent);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            vertical-align: middle;
            margin-left: 10px;
        }

        .content-grid {
            padding: 2.5rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
        }

        /* Inputs */
        .section-label {
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: #94a3b8;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-label::after { content: ''; flex: 1; height: 1px; background: #e2e8f0; }

        .input-row { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .input-group { flex: 1; }

        label { display: block; font-weight: 700; font-size: 0.85rem; margin-bottom: 0.5rem; color: #475569; }
        
        input, select {
            width: 100%;
            padding: 0.85rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            color: var(--primary);
            font-weight: 600;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        /* Toggle Switch */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
        }
        .toggle-label { font-size: 0.9rem; font-weight: 700; }
        .toggle-sub { font-size: 0.75rem; color: #64748b; display: block; }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Action Button */
        .btn-calc {
            grid-column: span 2;
            background: var(--primary);
            color: white;
            padding: 1.2rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 10px 20px -5px rgba(15, 23, 42, 0.3);
        }
        .btn-calc:hover { transform: translateY(-2px); }
        .btn-calc:active { transform: translateY(0); }

        /* Results Dashboard */
        .results-container {
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            padding: 3rem;
            display: none;
        }

        /* Kinetic Slider Component */
        .kinetic-panel {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px -2px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }

        .k-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .k-title { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; color: #64748b; }
        
        .speed-display { text-align: right; }
        .speed-val { font-size: 2.2rem; font-weight: 800; color: var(--primary); line-height: 1; }
        .speed-unit { font-size: 1rem; color: var(--accent); font-weight: 600; }

        /* Slider Track */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 16px;
            border-radius: 8px;
            outline: none;
            margin: 1.5rem 0;
            background: #e2e8f0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 32px;
            height: 32px;
            background: white;
            border: 5px solid var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-top: -8px;
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }

        /* Legend */
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .legend-item {
            background: white;
            padding: 0.8rem;
            text-align: center;
            font-size: 0.75rem;
        }
        .li-val { display: block; font-weight: 800; font-size: 0.9rem; margin-top: 4px; }

        /* Physics Cards */
        .physics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .p-card {
            background: white;
            padding: 1.5rem;
            border-radius: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.04);
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        .p-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: #94a3b8; letter-spacing: 0.5px; }
        .p-value { font-size: 1.8rem; font-weight: 800; color: var(--primary); margin: 0.5rem 0; }
        .p-sub { font-size: 0.8rem; color: var(--accent); font-weight: 600; }

        /* Status Banner */
        .status-pill {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        /* NEW: Pole Recommendation Section */
        .recommendation-panel {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px -2px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
            border: 2px solid var(--accent);
        }
        
        .rec-header {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rec-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .rec-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.2rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .rec-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .rec-card.best {
            border-color: var(--success);
            background: #ecfdf5;
        }
        
        .rec-card.blow {
            border-color: var(--danger);
            background: #fef2f2;
        }
        
        .rec-card.stall {
            border-color: var(--stall);
            background: #f1f5f9;
        }
        
        .rec-pole {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.3rem;
        }
        
        .rec-height {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--success);
            margin: 0.5rem 0;
        }
        
        .rec-diff {
            font-size: 0.8rem;
            font-weight: 600;
            color: #64748b;
        }
        
        .rec-status {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 4px 8px;
            border-radius: 20px;
            margin-top: 0.5rem;
            display: inline-block;
        }

        /* NEW: Grip Optimizer */
        .grip-panel {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-top: 1.5rem;
        }
        
        .grip-optimizer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }
        
        .grip-current, .grip-optimal {
            flex: 1;
            text-align: center;
        }
        
        .grip-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 700;
        }
        
        .grip-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin: 0.3rem 0;
        }
        
        .grip-arrow {
            font-size: 2rem;
            color: var(--accent);
        }

        @media (max-width: 800px) {
            .content-grid { grid-template-columns: 1fr; padding: 1.5rem; gap: 1.5rem; }
            .physics-grid { grid-template-columns: 1fr; }
            .legend-grid { grid-template-columns: 1fr 1fr; gap: 10px; background: transparent; }
            .legend-item { border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
            header h1 { font-size: 1.5rem; }
            .btn-calc { grid-column: span 1; }
            .rec-grid { grid-template-columns: 1fr; }
            .grip-optimizer { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Vault Mechanics <span class="badge-beta">Physics Core V6</span></h1>
        <p>Stiffness ($k \propto 1/flex$) & Kinetic Energy ($E \propto v^2$) Simulator with Pole Recommendations</p>
    </header>

    <div class="content-grid">
        
        <!-- SECTION 1: ATHLETE -->
        <div>
            <div class="section-label">Athlete Biometrics</div>
            <div class="input-row">
                <div class="input-group">
                    <label>Mass (lbs)</label>
                    <input type="number" id="weight" placeholder="150" value="148">
                </div>
                <div class="input-group">
                    <label>Height</label>
                    <div style="display:flex; gap:8px;">
                        <input type="number" id="hFt" placeholder="Ft" value="5">
                        <input type="number" id="hIn" placeholder="In" value="9">
                    </div>
                </div>
            </div>

            <div class="section-label">Grip Height</div>
            <div class="input-row">
                <div class="input-group">
                    <label>Feet</label>
                    <select id="gripFt"></select>
                </div>
                <div class="input-group">
                    <label>Inches</label>
                    <select id="gripIn"></select>
                </div>
                <div class="input-group">
                    <label>Fract</label>
                    <select id="gripFrac">
                        <option value="0">0"</option>
                        <option value="0.125">1/8"</option>
                        <option value="0.25">1/4"</option>
                        <option value="0.375">3/8"</option>
                        <option value="0.5">1/2"</option>
                        <option value="0.625">5/8"</option>
                        <option value="0.75">3/4"</option>
                    </select>
                </div>
            </div>

            <div class="toggle-row">
                <div>
                    <span class="toggle-label">Technical Efficiency</span>
                    <span class="toggle-sub">Free Takeoff / Plant Angle</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="effToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- SECTION 2: POLE PHYSICS -->
        <div>
            <div class="section-label">Stiffness Parameters</div>
            <div class="input-row">
                <div class="input-group">
                    <label>Manufacturer</label>
                    <select id="brand" onchange="estimateFlex()">
                        <option value="UCS">UCS Spirit</option>
                        <option value="Essx">Essx</option>
                        <option value="Pacer">Gill Pacer</option>
                        <option value="Altius">Altius</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Length</label>
                    <select id="length" onchange="estimateFlex()"></select>
                </div>
            </div>
            <div class="input-row">
                <div class="input-group">
                    <label>Rating (lbs)</label>
                    <select id="rating" onchange="estimateFlex()"></select>
                </div>
                <div class="input-group">
                    <label>Flex (cm)</label>
                    <input type="number" id="flex" step="0.1" placeholder="20.0">
                    <small style="display:block; color:#ef4444; font-size:0.7rem; margin-top:2px;">*Primary Stiffness Variable</small>
                </div>
            </div>
            
            <!-- NEW: Current PR Input -->
            <div class="input-row" style="margin-top: 1rem;">
                <div class="input-group">
                    <label>Current PR (ft)</label>
                    <input type="number" id="currentPR" step="0.1" placeholder="15.0" value="15.0">
                    <small style="display:block; color:#64748b; font-size:0.7rem; margin-top:2px;">For comparison calculations</small>
                </div>
                <div class="input-group">
                    <label>Standing Reach (ft)</label>
                    <input type="number" id="standingReach" step="0.1" placeholder="7.5">
                    <small style="display:block; color:#64748b; font-size:0.7rem; margin-top:2px;">Auto-calculated if empty</small>
                </div>
            </div>
        </div>

        <button class="btn-calc" onclick="initPhysics()">Initialize Physics Engine & Find Better Poles</button>
    </div>

    <!-- RESULTS -->
    <div id="results" class="results-container">
        
        <!-- KINETIC SLIDER -->
        <div class="kinetic-panel">
            <div class="k-header">
                <div>
                    <div class="k-title">Approach Velocity</div>
                    <div id="statusPill" class="status-pill" style="background:#e2e8f0; color:#64748b;">--</div>
                </div>
                <div class="speed-display">
                    <div class="speed-val" id="dispMph">--</div>
                    <div class="speed-unit">MPH</div>
                    <div style="font-size:0.8rem; color:#94a3b8;" id="dispMs">-- m/s</div>
                </div>
            </div>

            <input type="range" id="kSlider" min="5.0" max="11.5" step="0.05" oninput="updateSimulation()">
            
            <div class="legend-grid">
                <div class="legend-item" style="color: var(--stall);">
                    STALL
                    <span class="li-val" id="lStall">--</span>
                </div>
                <div class="legend-item" style="color: var(--warning);">
                    UNDER
                    <span class="li-val" id="lWarn">--</span>
                </div>
                <div class="legend-item" style="color: var(--success);">
                    OPTIMAL
                    <span class="li-val" id="lOpt">--</span>
                </div>
                <div class="legend-item" style="color: var(--danger);">
                    BLOW THRU
                    <span class="li-val" id="lBlow">--</span>
                </div>
            </div>
        </div>

        <!-- NEW: GRIP OPTIMIZER -->
        <div class="grip-panel">
            <div class="section-label" style="margin-top:0;">Grip Optimization</div>
            <div class="grip-optimizer">
                <div class="grip-current">
                    <div class="grip-label">Current Grip</div>
                    <div class="grip-value" id="currentGripDisplay">--</div>
                    <div style="font-size:0.75rem; color:#64748b;">Selected above</div>
                </div>
                <div class="grip-arrow">‚Üí</div>
                <div class="grip-optimal">
                    <div class="grip-label">Recommended Grip</div>
                    <div class="grip-value" id="optimalGripDisplay" style="color:var(--success);">--</div>
                    <div style="font-size:0.75rem; color:#64748b;" id="gripReason">Based on your speed</div>
                </div>
            </div>
        </div>

        <!-- NEW: POLE RECOMMENDATIONS -->
        <div class="recommendation-panel">
            <div class="rec-header">
                <span>üèÜ</span>
                <span>Pole Recommendations (Ranked by Projected Height)</span>
            </div>
            <div id="recContainer" class="rec-grid">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- METRICS -->
        <div class="physics-grid">
            <div class="p-card">
                <div class="p-label">True Energy Ceiling</div>
                <div class="p-value" id="hCeiling">--</div>
                <div class="p-sub">Lift + COM (Theoretical)</div>
            </div>
            <div class="p-card" style="border-color: var(--accent); background: #f5f7ff;">
                <div class="p-label" style="color:var(--accent);">Projected Height</div>
                <div class="p-value" id="hProj" style="color:var(--accent);">--</div>
                <div class="p-sub">Realized Potential</div>
            </div>
            <div class="p-card">
                <div class="p-label">Stiffness Load</div>
                <div class="p-value" id="loadVal">--</div>
                <div class="p-sub">Relative to Mass</div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 3rem;">
            <button onclick="resetAll()" style="background:none; border:1px solid #cbd5e1; padding: 10px 24px; border-radius: 30px; color:#64748b; font-weight:700; cursor:pointer;">Reset Simulation</button>
        </div>

    </div>
</div>

<script>
    // --- Physics Constants ---
    const G = 9.81;
    let zStall, zWarn, zOpt, zBlow;
    let currentPoleData = {};

    document.addEventListener("DOMContentLoaded", () => {
        initUI();
        estimateFlex();
    });

    function initUI() {
        const lenSel = document.getElementById('length');
        const rateSel = document.getElementById('rating');
        const gFt = document.getElementById('gripFt');
        const gIn = document.getElementById('gripIn');

        // Lengths
        for(let f = 10; f <= 18; f++) {
            [0, 6].forEach(i => {
                if(f===18 && i===6) return;
                let val = f + (i/12);
                let opt = document.createElement('option');
                opt.value = val;
                opt.text = `${f}' ${i}"`;
                if(val === 15) opt.selected = true;
                lenSel.appendChild(opt);
            });
        }

        // Ratings
        for(let w = 90; w <= 230; w += 5) {
            let opt = document.createElement('option');
            opt.value = w;
            opt.text = `${w} lbs`;
            if(w === 165) opt.selected = true;
            rateSel.appendChild(opt);
        }

        // Grip
        for(let f=10; f<=17; f++){
            let opt = document.createElement('option');
            opt.value = f; opt.text = `${f}'`;
            if(f===14) opt.selected = true; gFt.appendChild(opt);
        }
        for(let i=0; i<=11; i++){
            let opt = document.createElement('option');
            opt.value = i; opt.text = `${i}"`;
            if(i===9) opt.selected = true; gIn.appendChild(opt);
        }
    }

    function estimateFlex() {
        const L = parseFloat(document.getElementById('length').value);
        const W = parseInt(document.getElementById('rating').value);
        const brand = document.getElementById('brand').value;
        
        // Heuristic Flex Estimation (Start point only)
        let base = 19.0;
        base -= (W - 150) * 0.05;
        base += (L - 14) * 1.3; 
        
        if(brand === 'Essx') base -= 0.5;
        if(brand === 'Pacer') base += 0.4;

        // Only set if empty to allow user override
        const fInput = document.getElementById('flex');
        if(!fInput.value) fInput.value = base.toFixed(1);
    }

    // --- IMPROVED STIFFNESS CALCULATION ---
    function calculateTrueStiffness(rating, flex, length) {
        // Normalize to standard 14' 150lb reference
        const lengthFactor = Math.pow(length / 14, 3); // Stiffness ‚àù L¬≥
        const flexFactor = Math.pow(20.0 / flex, 1.5); // Non-linear flex response
        const ratingFactor = rating / 150;
        
        return lengthFactor * flexFactor * ratingFactor;
    }

    // --- GRIP OPTIMIZATION ---
    function calculateOptimalGrip(vaulterHeight, standingReach, currentSpeed, poleLength, stiffness) {
        // Max functional grip is standing reach + 18-22 inches for elite vaulters
        // But must have speed to rotate the pole
        
        const standingReachM = standingReach ? standingReach * 0.3048 : vaulterHeight * 0.3048 * 1.25;
        const maxFunctionalGrip = standingReachM + 0.55; // ~22" max
        
        // Speed requirement increases with grip height
        // Base speed needed for a grip
        const gripFt = Math.floor(poleLength);
        const baseGripM = gripFt * 0.3048;
        
        // Can he grip higher?
        let optimalGrip = baseGripM;
        
        // If he has excess speed, recommend gripping up
        const speedBuffer = currentSpeed - zOpt;
        if (speedBuffer > 0.3) {
            // Every 0.1 m/s excess allows ~1.5" higher grip
            const extraInches = speedBuffer * 10 * 0.0254; // Convert to meters
            optimalGrip = Math.min(baseGripM + extraInches, maxFunctionalGrip);
        }
        
        return optimalGrip;
    }

    // --- POLE RECOMMENDATION ENGINE ---
    function generatePoleRecommendations(weight, height, currentSpeed, currentPole) {
        const recommendations = [];
        const currentStiffness = calculateTrueStiffness(
            currentPole.rating, 
            currentPole.flex, 
            currentPole.length
        );
        
        // Generate candidate poles
        const candidates = [];
        
        // Same length, different ratings/flexes
        const currentRating = parseInt(currentPole.rating);
        const currentLen = parseFloat(currentPole.length);
        
        // Stiffer same length (if blowing through)
        if (currentSpeed > zBlow) {
            candidates.push({
                length: currentLen,
                rating: currentRating + 10,
                flex: Math.max(15, currentPole.flex - 1.0),
                type: 'Stiffer Same Length'
            });
        }
        
        // Longer poles (primary path to height)
        const longerLengths = [15.5, 16, 16.5, 17].filter(l => l > currentLen);
        longerLengths.forEach(len => {
            // Calculate ideal flex for this length at his weight/speed
            const targetStiffness = currentStiffness * 0.95; // Slightly softer for longer
            const idealFlex = 20.0 / Math.pow(targetStiffness / Math.pow(len/14, 3) / (currentRating/150), 1/1.5);
            
            candidates.push({
                length: len,
                rating: currentRating,
                flex: Math.round(idealFlex * 10) / 10,
                type: `Longer ${len}'`
            });
            
            // Also try one rating up on longer pole
            candidates.push({
                length: len,
                rating: currentRating + 5,
                flex: Math.round((idealFlex - 0.5) * 10) / 10,
                type: `Longer ${len}' Stiffer`
            });
        });
        
        // Calculate projected height for each
        candidates.forEach(pole => {
            const proj = simulatePole(pole, weight, height, currentSpeed);
            recommendations.push({
                ...pole,
                ...proj
            });
        });
        
        // Sort by projected height
        recommendations.sort((a, b) => b.projectedHeight - a.projectedHeight);
        
        return recommendations.slice(0, 4); // Top 4
    }

    function simulatePole(pole, weight, height, v) {
        const mass = weight * 0.453592;
        const bodyH = height;
        const com = bodyH * 0.57;
        
        // Calculate stiffness for this pole
        const stiffness = calculateTrueStiffness(pole.rating, pole.flex, pole.length);
        const massIndex = weight / 150;
        const kIndex = stiffness / 1.0; // Normalized
        
        // Optimal speed for this pole
        let vOpt = 7.8 * Math.sqrt(kIndex / massIndex);
        vOpt -= (pole.length - 14) * 0.1;
        
        // Determine zone
        const zStallPole = vOpt - 1.0;
        const zWarnPole = vOpt - 0.3;
        const zBlowPole = vOpt + 0.8;
        
        let status, projectedHeight, efficiency;
        const effTech = document.getElementById('effToggle').checked ? 0.96 : 0.88;
        
        // Calculate grip for this pole length
        const gripM = Math.floor(pole.length) * 0.3048;
        
        if (v < zStallPole) {
            status = 'STALL';
            projectedHeight = gripM * 0.8;
            efficiency = 0.6;
        } else if (v < zWarnPole) {
            status = 'UNDER';
            projectedHeight = gripM;
            efficiency = 0.85;
        } else if (v > zBlowPole) {
            status = 'BLOW';
            projectedHeight = gripM + 0.2;
            efficiency = 0.75;
        } else {
            status = 'OPTIMAL';
            const lift = (v * v) / (2 * G);
            projectedHeight = (lift * effTech) + com;
            if (projectedHeight > gripM + 1.25) projectedHeight = gripM + 1.25;
            efficiency = effTech;
        }
        
        return {
            projectedHeight,
            status,
            efficiency,
            vOptimal: vOpt
        };
    }

    // --- CORE PHYSICS ENGINE V6 ---
    function initPhysics() {
        const weight = parseFloat(document.getElementById('weight').value);
        const rating = parseFloat(document.getElementById('rating').value);
        const flex = parseFloat(document.getElementById('flex').value);
        const length = parseFloat(document.getElementById('length').value);
        
        // Store current pole data
        currentPoleData = { weight, rating, flex, length };
        
        // 1. TRUE STIFFNESS (k)
        const k_index = calculateTrueStiffness(rating, flex, length);
        
        // 2. ENERGY REQUIREMENT (v_opt)
        const mass_index = weight / 150;
        let v_optimal = 7.8 * Math.sqrt(k_index / mass_index);
        v_optimal -= (length - 14) * 0.1;
        
        if(v_optimal < 6.0) v_optimal = 6.0;
        if(v_optimal > 10.8) v_optimal = 10.8;

        // 3. ZONES
        zStall = v_optimal - 1.0; 
        zWarn = v_optimal - 0.3;  
        zOpt = v_optimal;         
        zBlow = v_optimal + 0.8; 

        // 4. RENDER LEGEND
        const toMph = (ms) => (ms * 2.237).toFixed(1);
        document.getElementById('lStall').innerText = `< ${toMph(zStall)}`;
        document.getElementById('lWarn').innerText = `${toMph(zStall)} - ${toMph(zWarn)}`;
        document.getElementById('lOpt').innerText = `${toMph(zWarn)} - ${toMph(zBlow)}`;
        document.getElementById('lBlow').innerText = `> ${toMph(zBlow)}`;

        paintGradient();

        // Set slider to calculated optimal (not fixed 8.5)
        document.getElementById('kSlider').value = v_optimal.toFixed(2);
        
        document.getElementById('results').style.display = 'block';
        document.getElementById('results').scrollIntoView({behavior:'smooth'});
        
        updateSimulation();
    }

    function paintGradient() {
        const s = document.getElementById('kSlider');
        const min = parseFloat(s.min);
        const max = parseFloat(s.max);
        const range = max - min;
        
        const pStall = Math.max(0, Math.min(100, ((zStall - min)/range)*100));
        const pWarn = Math.max(0, Math.min(100, ((zWarn - min)/range)*100));
        const pBlow = Math.max(0, Math.min(100, ((zBlow - min)/range)*100));

        const g = `linear-gradient(to right, 
            #64748b 0%, #64748b ${pStall}%, 
            #f59e0b ${pStall}%, #f59e0b ${pWarn}%, 
            #10b981 ${pWarn}%, #10b981 ${pBlow}%, 
            #ef4444 ${pBlow}%, #ef4444 100%)`;
        s.style.background = g;
    }

    function updateSimulation() {
        const v = parseFloat(document.getElementById('kSlider').value);
        const mph = v * 2.23694;
        
        document.getElementById('dispMph').innerText = mph.toFixed(1);
        document.getElementById('dispMs').innerText = v.toFixed(2) + " m/s";

        // Efficiency Toggle
        const effTech = document.getElementById('effToggle').checked ? 0.96 : 0.88;

        // Body metrics
        const hFt = parseFloat(document.getElementById('hFt').value);
        const hIn = parseFloat(document.getElementById('hIn').value);
        const bodyH_m = (hFt * 0.3048) + (hIn * 0.0254);
        const com_m = bodyH_m * 0.57;

        // Energy Ceiling
        const lift_m = (v * v) / (2 * G);
        const ceiling_m = lift_m + com_m;

        // Grip Data
        const gFt = parseInt(document.getElementById('gripFt').value);
        const gIn = parseInt(document.getElementById('gripIn').value);
        const gFr = parseFloat(document.getElementById('gripFrac').value);
        const grip_m = (gFt + ((gIn + gFr)/12)) * 0.3048;
        
        // Update grip displays
        document.getElementById('currentGripDisplay').innerText = toFtIn(grip_m);

        // Standing reach calculation
        const standingReachInput = document.getElementById('standingReach').value;
        const standingReach = standingReachInput ? parseFloat(standingReachInput) : (hFt + hIn/12) * 1.25;

        // Calculate optimal grip
        const optimalGrip = calculateOptimalGrip(bodyH_m, standingReach, v, currentPoleData.length, currentPoleData.flex);
        document.getElementById('optimalGripDisplay').innerText = toFtIn(optimalGrip);
        
        // Grip reason
        const speedBuffer = v - zOpt;
        if (speedBuffer > 0.5) {
            document.getElementById('gripReason').innerText = 'Speed surplus - grip up!';
        } else if (speedBuffer < -0.3) {
            document.getElementById('gripReason').innerText = 'Need more speed to grip higher';
        } else {
            document.getElementById('gripReason').innerText = 'Current grip appropriate';
        }

        // Realized Height Logic
        let projM = 0;
        const status = document.getElementById('statusPill');
        
        if (v < zStall) {
            status.style.background = "var(--stall)";
            status.innerText = "STALL / REJECT";
            projM = grip_m * 0.8;
        } else if (v < zWarn) {
            status.style.background = "var(--warning)";
            status.innerText = "UNDER POWERED";
            projM = grip_m;
        } else if (v > zBlow) {
            status.style.background = "var(--danger)";
            status.innerText = "BLOW THROUGH";
            projM = grip_m + 0.2;
        } else {
            status.style.background = "var(--success)";
            status.innerText = "OPTIMAL LOCK";
            
            projM = (lift_m * effTech) + com_m;
            if (projM > grip_m + 1.25) projM = grip_m + 1.25;
        }
        
        // Update Cards
        document.getElementById('hCeiling').innerText = toFtIn(ceiling_m);
        document.getElementById('hProj').innerText = toFtIn(projM);
        
        // Stiffness Load
        const weight = parseFloat(document.getElementById('weight').value);
        const rating = parseFloat(document.getElementById('rating').value);
        const ratio = (weight/rating) * 100;
        document.getElementById('loadVal').innerText = ratio.toFixed(0) + "%";
        
        // Generate and display pole recommendations
        displayRecommendations(weight, hFt + hIn/12, v);
    }

    function displayRecommendations(weight, height, v) {
        const recs = generatePoleRecommendations(weight, height, v, currentPoleData);
        const container = document.getElementById('recContainer');
        const currentPR = parseFloat(document.getElementById('currentPR').value) || 0;
        
        container.innerHTML = '';
        
        recs.forEach((rec, index) => {
            const card = document.createElement('div');
            card.className = 'rec-card';
            
            // Determine styling based on status
            if (rec.status === 'OPTIMAL') card.classList.add('best');
            else if (rec.status === 'BLOW') card.classList.add('blow');
            else if (rec.status === 'STALL') card.classList.add('stall');
            
            // Calculate height difference from PR
            const prM = currentPR * 0.3048;
            const diffM = rec.projectedHeight - prM;
            const diffStr = diffM > 0 ? `+${(diffM * 3.28084 * 12).toFixed(0)}"` : `${(diffM * 3.28084 * 12).toFixed(0)}"`;
            const diffColor = diffM > 0 ? 'var(--success)' : (diffM < 0 ? 'var(--danger)' : '#64748b');
            
            card.innerHTML = `
                <div class="rec-pole">${rec.length}' ${rec.rating}lbs <span style="font-size:0.8rem;color:#64748b;">(${rec.flex})</span></div>
                <div style="font-size:0.75rem;color:#64748b;margin-bottom:0.5rem;">${rec.type}</div>
                <div class="rec-height">${toFtIn(rec.projectedHeight)}</div>
                <div class="rec-diff" style="color:${diffColor};">${diffStr} from PR</div>
                <span class="rec-status" style="background:${getStatusColor(rec.status)}20;color:${getStatusColor(rec.status)};">
                    ${rec.status}
                </span>
            `;
            
            container.appendChild(card);
        });
    }

    function getStatusColor(status) {
        switch(status) {
            case 'OPTIMAL': return 'var(--success)';
            case 'BLOW': return 'var(--danger)';
            case 'STALL': return 'var(--stall)';
            case 'UNDER': return 'var(--warning)';
            default: return '#64748b';
        }
    }

    function toFtIn(m) {
        let ft = Math.floor(m * 3.28084);
        let inc = Math.round((m * 3.28084 - ft)*12);
        if(inc===12){ft++; inc=0;}
        return `${ft}' ${inc}"`;
    }

    function resetAll() {
        document.getElementById('results').style.display = 'none';
        window.scrollTo({top:0, behavior:'smooth'});
    }
</script>

</body>
</html>