<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>âš” Dungeon Development Environment</title>
<style>
:root {
    --bg:      #0d0d0d;
    --panel:   #111417;
    --border:  #2a2f35;
    --accent:  #00c896;
    --gold:    #e8b84a;
    --red:     #e84a4a;
    --purple:  #a855f7;
    --blue:    #4a8ee8;
    --orange:  #e8874a;
    --dim:     #666;
    --text:    #cdd1d6;
    --bright:  #f0f3f6;
}
* { box-sizing: border-box; margin: 0; padding: 0; }

/* â”€â”€ ENEMY EDITOR OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#enemyEditorOverlay {
    display: none; position: fixed; inset: 0; z-index: 9000;
    background: rgba(0,0,0,0.82); backdrop-filter: blur(3px);
    align-items: center; justify-content: center;
}
#enemyEditorOverlay.open { display: flex; }
#enemyEditorModal {
    background: #111417; border: 2px solid var(--orange);
    border-radius: 8px; width: 96vw; max-width: 1100px;
    height: 90vh; display: flex; flex-direction: column;
    box-shadow: 0 0 60px rgba(232,135,74,0.25);
    overflow: hidden;
}
#eeHeader {
    background: #0d1008; border-bottom: 2px solid var(--orange);
    padding: 10px 16px; display: flex; align-items: center; gap: 10px;
    flex-shrink: 0;
}
#eeHeader h2 { font-size: 14px; color: var(--orange); letter-spacing: 2px; text-transform: uppercase; flex: 1; }
#eeBody { display: flex; flex: 1; overflow: hidden; }
#eeList {
    width: 280px; min-width: 280px; border-right: 1px solid var(--border);
    display: flex; flex-direction: column; overflow: hidden;
}
#eeListSearch {
    padding: 8px; border-bottom: 1px solid var(--border); flex-shrink: 0;
}
#eeListSearch input {
    width: 100%; background: #0a0e11; border: 1px solid var(--border);
    color: var(--text); padding: 5px 8px; font-family: 'Courier New',monospace;
    font-size: 12px; border-radius: 3px; outline: none;
}
#eeListSearch input:focus { border-color: var(--orange); }
#eeListItems { flex: 1; overflow-y: auto; }
#eeListItems::-webkit-scrollbar { width: 5px; }
#eeListItems::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
.ee-list-item {
    padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #1a1f24;
    display: flex; flex-direction: column; gap: 2px; transition: background 0.1s;
}
.ee-list-item:hover { background: #1a1f24; }
.ee-list-item.active { background: rgba(232,135,74,.15); border-left: 3px solid var(--orange); }
.ee-list-item .ee-item-name { font-size: 12px; color: var(--bright); }
.ee-list-item .ee-item-sub { font-size: 10px; color: var(--dim); }
#eeListActions { padding: 8px; border-top: 1px solid var(--border); flex-shrink: 0; }
#eeForm {
    flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px;
}
#eeForm::-webkit-scrollbar { width: 5px; }
#eeForm::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
#eeFormPlaceholder { color: var(--dim); font-size: 13px; margin: auto; text-align: center; }
.ee-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.ee-form-grid.three { grid-template-columns: 1fr 1fr 1fr; }
.ee-field label { display: block; font-size: 10px; color: var(--dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px; }
.ee-field input, .ee-field textarea, .ee-field select {
    width: 100%; background: #0a0e11; border: 1px solid var(--border);
    color: var(--text); padding: 6px 8px; font-family: 'Courier New',monospace;
    font-size: 12px; border-radius: 3px; outline: none;
}
.ee-field input:focus, .ee-field textarea:focus, .ee-field select:focus { border-color: var(--orange); }
.ee-section-title {
    font-size: 11px; color: var(--orange); text-transform: uppercase;
    letter-spacing: 1px; border-bottom: 1px solid #1a2010; padding-bottom: 5px; margin-top: 6px;
}
#eeFormActions {
    display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--border);
    flex-shrink: 0; background: #0d1008;
}
#eeStatus { font-size: 11px; color: var(--dim); margin-left: auto; align-self: center; }
#eeDropsEditor { display: flex; flex-direction: column; gap: 4px; }
.ee-drop-row { display: flex; gap: 6px; align-items: center; }
.ee-drop-row input { flex: 1; }
.ee-drop-remove { padding: 2px 8px; font-size: 10px; flex-shrink: 0; }
body {
    display: flex; height: 100vh;
    font-family: 'Courier New', monospace;
    background: var(--bg); color: var(--text); overflow: hidden;
}
#sidebar {
    width: 300px; min-width: 300px;
    background: var(--panel);
    border-right: 2px solid var(--border);
    display: flex; flex-direction: column; overflow: hidden;
}
#sidebarHeader {
    background: #0a1a14; border-bottom: 2px solid var(--accent);
    padding: 10px 14px; display: flex; align-items: center; gap: 8px;
}
#sidebarHeader h2 { font-size: 13px; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; }
#sidebarScroll { flex: 1; overflow-y: auto; padding: 12px; }
#sidebarScroll::-webkit-scrollbar { width: 6px; }
#sidebarScroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
.section { margin-bottom: 12px; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
.section-title {
    background: #1a1f24; padding: 6px 10px; font-size: 11px;
    letter-spacing: 1px; color: var(--dim); text-transform: uppercase;
    font-weight: bold; display: flex; justify-content: space-between;
    align-items: center; cursor: pointer; user-select: none;
}
.section-title:hover { color: var(--text); }
.section-body { padding: 10px; background: #0f1316; }
label {
    display: block; font-size: 11px; color: var(--dim);
    margin-bottom: 3px; margin-top: 8px;
    text-transform: uppercase; letter-spacing: 0.5px;
}
label:first-child { margin-top: 0; }
input[type=text], input[type=number], select, textarea {
    width: 100%; background: #0a0e11; border: 1px solid var(--border);
    color: var(--text); padding: 6px 8px;
    font-family: 'Courier New', monospace; font-size: 12px;
    border-radius: 3px; outline: none;
}
input:focus, select:focus, textarea:focus { border-color: var(--accent); }
textarea { resize: vertical; min-height: 50px; }
button {
    font-family: 'Courier New', monospace; font-size: 12px;
    cursor: pointer; border: 1px solid var(--border);
    background: #1a1f24; color: var(--text); padding: 5px 10px;
    border-radius: 3px; transition: all 0.15s;
}
button:hover { border-color: var(--accent); color: var(--accent); }
.btn-a  { border-color: var(--accent); color: var(--accent); background: rgba(0,200,150,.05); }
.btn-a:hover { background: rgba(0,200,150,.15); }
.btn-d  { border-color: var(--red); color: var(--red); background: rgba(232,74,74,.05); }
.btn-d:hover { background: rgba(232,74,74,.15); }
.btn-g  { border-color: var(--gold); color: var(--gold); background: rgba(232,184,74,.05); }
.btn-g:hover { background: rgba(232,184,74,.15); }
.btn-p  { border-color: var(--purple); color: var(--purple); background: rgba(168,85,247,.05); }
.btn-p:hover { background: rgba(168,85,247,.15); }
.btn-row { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
#toolbar {
    background: #0a0e11; border-bottom: 2px solid var(--border);
    padding: 7px 10px; display: flex; gap: 6px; align-items: center; flex-shrink: 0;
}
#modeLabel { margin-left: auto; font-size: 11px; color: var(--accent); letter-spacing: 1px; }
#mapContainer { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
#mapArea {
    flex: 1; overflow: auto; position: relative; background: #090c0e;
    background-image: radial-gradient(circle, #1a1f24 1px, transparent 1px);
    background-size: 50px 50px;
}
#grid { display: grid; position: relative; }
#connections {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 50; overflow: visible;
}
.cell { border: 1px solid #141a1f; position: relative; }
.room {
    position: absolute; width: 100%; height: 100%;
    background: #1a2228; border: 2px solid var(--accent);
    box-sizing: border-box; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    font-weight: bold; color: var(--bright); z-index: 20;
    font-size: 10px; cursor: pointer; transition: border-color 0.1s;
}
.room:hover { border-color: white; }
.room.selected { border-color: var(--gold) !important; background: #1e2a1a; }
.room.startRoom { background: #0a2018; }
.room-id { font-size: 9px; color: var(--accent); }
.room-icons { font-size: 11px; }
/* Enemy entries */
.enemy-entry {
    border: 1px solid var(--border); border-radius: 3px;
    padding: 7px 8px; margin-bottom: 6px; background: #0a0e11;
}
.enemy-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.enemy-name { color: var(--bright); font-size: 12px; font-weight: bold; }
.drop-row {
    background: #111518; border: 1px solid #222; border-radius: 3px;
    padding: 4px 8px; margin-top: 4px; display: flex; gap: 6px; align-items: center;
}
.drop-row span { font-size: 11px; color: var(--gold); white-space: nowrap; }
.drop-row select { flex: 1; font-size: 11px; padding: 3px 6px; }
/* Trap entries */
.trap-entry {
    border: 1px solid #3a1515; border-radius: 3px;
    padding: 8px; margin-bottom: 6px; background: #100a0a;
}
.trap-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.trap-name { font-weight: bold; font-size: 12px; }
.trap-desc { font-size: 10px; color: var(--dim); margin-bottom: 6px; }
.trap-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.trap-fields label { font-size: 10px; }
.trap-fields input { padding: 4px 6px; font-size: 11px; }
.trap-rearm { grid-column: 1/-1; display: flex; align-items: center; gap: 6px; margin-top: 4px; }
.trap-rearm input { width: auto; }
.trap-rearm label { display: inline; margin: 0; text-transform: none; font-size: 11px; }
/* Simulator */
#simulatorPanel {
    width: 380px; min-width: 380px; background: #050809;
    color: #00ff88; display: none; flex-direction: column;
    border-left: 2px solid #1a3328; font-size: 13px;
}
#simHeader {
    background: #0a1a14; border-bottom: 2px solid #1a3328;
    padding: 8px 12px; font-size: 11px; letter-spacing: 2px; color: var(--accent);
    display: flex; justify-content: space-between; align-items: center;
}
#terminalOutput { flex: 1; overflow-y: auto; padding: 10px; line-height: 1.7; }
#terminalOutput::-webkit-scrollbar { width: 4px; }
#terminalOutput::-webkit-scrollbar-thumb { background: #1a3328; }
#termInputRow {
    border-top: 1px solid #1a3328; display: flex; align-items: center;
    padding: 0 8px; background: #080d0b;
}
#termInputRow span { color: var(--accent); margin-right: 6px; }
#terminalInput {
    flex: 1; background: transparent; border: none; color: #00ff88;
    padding: 8px 0; font-family: 'Courier New', monospace; font-size: 13px; outline: none;
}
#simControls {
    display: flex; gap: 8px; padding: 8px 10px;
    border-top: 1px solid #1a3328; background: #080d0b;
}
#simHealthLabel { margin-left: auto; font-size: 11px; color: var(--red); }
#statusBar {
    background: #0a0e11; border-top: 1px solid var(--border);
    padding: 5px 14px; font-size: 11px; color: var(--dim);
    display: flex; justify-content: space-between;
}
#statusMsg { color: var(--accent); }
.collapsible-content { overflow: hidden; max-height: 9999px; }
.collapsible-content.collapsed { max-height: 0; }
.floor-tabs { display: flex; gap: 4px; flex-wrap: wrap; }
.floor-tab {
    padding: 4px 12px; border: 1px solid var(--border); border-radius: 3px;
    cursor: pointer; font-size: 11px; color: var(--dim); background: #0a0e11; font-family: monospace;
}
.floor-tab.active { border-color: var(--accent); color: var(--accent); background: rgba(0,200,150,.05); }
hr { border-color: var(--border); margin: 8px 0; }
</style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar">
<div id="sidebarHeader">
    <span style="color:var(--accent);font-size:18px;">âš”</span>
    <h2>Dungeon Editor</h2>
    <span id="dirtyDot" style="color:var(--red);display:none;margin-left:auto;font-size:10px;">â— UNSAVED</span>
</div>
<div id="sidebarScroll">

<div class="section">
    <div class="section-title" onclick="toggleSec(this)">Dungeon Settings <span>â–¾</span></div>
    <div class="section-body collapsible-content">
        <label>Name</label>
        <input id="dungeonName" type="text" value="New Dungeon">
        <label>Description</label>
        <textarea id="dungeonDesc" rows="2"></textarea>
    </div>
</div>

<div class="section">
    <div class="section-title" onclick="toggleSec(this)">Floors <span>â–¾</span></div>
    <div class="section-body collapsible-content">
        <div class="floor-tabs" id="floorTabs"></div>
        <div class="btn-row">
            <button class="btn-a" onclick="addFloor()">+ Floor</button>
            <button class="btn-d" onclick="deleteCurrentFloor()">Ã— Floor</button>
        </div>
    </div>
</div>

<div class="section" id="inspectorSection" style="display:none;">
    <div class="section-title" onclick="toggleSec(this)">
        Room: <span id="inspRoomId">â€”</span> <span>â–¾</span>
    </div>
    <div class="section-body collapsible-content">

        <label>Name</label>
        <input id="roomName" type="text" placeholder="Room name...">
        <label>Description</label>
        <textarea id="roomDesc" rows="2" placeholder="What the player sees..."></textarea>

        <!-- ENEMIES -->
        <hr>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <span style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;">âš” Enemies</span>
            <div style="display:flex;gap:5px;align-items:center;">
                <select id="enemySelect" style="width:130px;padding:3px 5px;font-size:11px;"></select>
                <button class="btn-d" onclick="addEnemyToRoom()" style="padding:3px 7px;font-size:11px;">+</button>
            </div>
        </div>
        <div id="enemyList"></div>

        <!-- TRAPS -->
        <hr>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <span style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;">âš  Traps</span>
            <div style="display:flex;gap:5px;align-items:center;">
                <select id="trapTypeSelect" style="width:130px;padding:3px 5px;font-size:11px;">
                    <option value="spike">ğŸ—¡ Spike Trap</option>
                    <option value="poison">â˜  Poison Trap</option>
                    <option value="stone">ğŸª¨ Stone Trap</option>
                    <option value="fire">ğŸ”¥ Fire Trap</option>
                    <option value="lightning">âš¡ Lightning Trap</option>
                    <option value="freeze">â„ Freeze Trap</option>
                    <option value="alarm">ğŸ”” Alarm Trap</option>
                    <option value="pit">ğŸ•³ Pit Trap</option>
                    <option value="acid">ğŸ§ª Acid Trap</option>
                    <option value="web">ğŸ•¸ Web Trap</option>
                    <option value="curse">ğŸŒ€ Curse Trap</option>
                </select>
                <button class="btn-d" onclick="addTrapToRoom()" style="padding:3px 7px;font-size:11px;">+</button>
            </div>
        </div>
        <div id="trapList"></div>

        <!-- RUNESTONE -->
        <hr>
        <span style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;">âœ¦ Runestone</span>
        <div style="margin-top:6px;">
            <select id="runestoneSelect" style="width:100%;padding:4px 6px;font-size:12px;background:#0a0a0a;border:1px solid var(--border);color:#ccc;">
                <option value="">â€” none â€”</option>
                <option value="white_runestone"  style="color:#FFFFFF;">âœ¦ White Runestone</option>
                <option value="yellow_runestone" style="color:#FFD700;">âœ¦ Yellow Runestone</option>
                <option value="green_runestone"  style="color:#00FF88;">âœ¦ Green Runestone</option>
                <option value="blue_runestone"   style="color:#44AAFF;">âœ¦ Blue Runestone</option>
                <option value="purple_runestone" style="color:#BB66FF;">âœ¦ Purple Runestone</option>
                <option value="brown_runestone"  style="color:#CC8844;">âœ¦ Brown Runestone</option>
                <option value="black_runestone"  style="color:#888888;">âœ¦ Black Runestone</option>
                <option value="red_runestone"    style="color:#FF3333;">âœ¦ Red Runestone</option>
            </select>
            <div style="font-size:10px;color:var(--dim);margin-top:3px;">Player receives this runestone on first visit. Triggers a blinding-light cutscene.</div>
        </div>

        <!-- LADDER -->
        <hr>
        <span style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;">ğŸªœ Ladder</span>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
            <div>
                <label>Direction</label>
                <select id="ladderDirection">
                    <option value="">None</option>
                    <option value="up">â¬† Up</option>
                    <option value="down">â¬‡ Down</option>
                </select>
            </div>
            <div>
                <label>Target Floor</label>
                <select id="ladderFloor" onchange="populateLadderRooms()">
                    <option value="">â€” floor â€”</option>
                </select>
            </div>
        </div>
        <label>Target Room</label>
        <select id="ladderTargetRoom"><option value="">â€” room â€”</option></select>

        <!-- DOORS -->
        <hr>
        <span style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;">ğŸ”’ Locked Doors</span>
        <div id="doorEditor" style="margin-top:6px;"></div>

        <!-- ROOM LOOT / GROUND ITEMS -->
        <hr>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <span style="font-size:11px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;">ğŸ“¦ Ground Items (auto-picked up)</span>
        </div>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;">
            <select id="lootItemSelect" style="flex:1;background:#0a0e11;border:1px solid var(--border);color:var(--text);padding:4px 6px;font-family:'Courier New',monospace;font-size:11px;border-radius:3px;">
                <option value="">â€” pick item â€”</option>
            </select>
            <button onclick="addLootItem()" style="padding:3px 8px;border-color:var(--gold);color:var(--gold);background:rgba(232,184,74,.08);font-size:11px;">+ Add</button>
        </div>
        <div id="lootItemChips" style="display:flex;flex-wrap:wrap;gap:4px;min-height:24px;padding:4px;background:#0a0e11;border:1px solid var(--border);border-radius:3px;margin-bottom:4px;"></div>

        <!-- TELEPORT TRIGGER -->
        <hr>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <span style="font-size:11px;color:#a855f7;text-transform:uppercase;letter-spacing:1px;">ğŸŒ€ Teleport Trigger</span>
            <label style="display:flex;align-items:center;gap:5px;margin:0;font-size:11px;color:var(--dim);text-transform:none;letter-spacing:0;">
                <input type="checkbox" id="staffTriggerEnabled" style="width:auto;" onchange="toggleStaffTriggerUI()">
                Enable
            </label>
        </div>
        <div id="staffTriggerUI" style="display:none;">
            <label>Trigger Condition</label>
            <select id="teleportTriggerType" style="width:100%;padding:4px 6px;font-size:12px;background:#0a0a0a;border:1px solid #a855f7;color:#ccc;margin-bottom:6px;" onchange="updateTeleportTriggerDesc()">
                <option value="enter_room">ğŸš¶ Enter Room â€” teleport on arrival</option>
                <option value="staff_pieces">ğŸª„ All Staff Pieces â€” collect all 8 pieces</option>
                <option value="lever">ğŸ•¹ï¸ Pull Lever â€” player must interact with lever</option>
                <option value="enemies_cleared">âš”ï¸ Enemies Cleared â€” all room enemies defeated</option>
                <option value="item_deposited">ğŸ“¦ Deposit Item â€” player drops specific item</option>
                <option value="full_health">â¤ï¸ Full Health â€” enter at full HP</option>
                <option value="no_keys">ğŸ—ï¸ No Keys Held â€” enter with empty keyring</option>
            </select>
            <div id="triggerDepositRow" style="display:none;">
                <label>Required Item Key</label>
                <input id="teleportDepositItem" type="text" placeholder="e.g. ancient_relic" style="width:100%;padding:4px 6px;font-size:12px;background:#0a0a0a;border:1px solid #a855f7;color:#ccc;font-family:'Courier New',monospace;">
            </div>
            <div id="teleportTriggerDesc" style="font-size:10px;color:#a855f7;margin-bottom:6px;padding:4px 6px;background:#0d080f;border-left:2px solid #a855f7;line-height:1.5;"></div>
            <label>Teleport Target Floor</label>
            <select id="staffTargetFloor" style="width:100%;padding:4px 6px;font-size:12px;background:#0a0a0a;border:1px solid #a855f7;color:#ccc;" onchange="populateStaffTargetRooms()">
                <option value="">â€” select floor â€”</option>
            </select>
            <label>Teleport Target Room</label>
            <select id="staffTargetRoom" style="width:100%;padding:4px 6px;font-size:12px;background:#0a0a0a;border:1px solid #a855f7;color:#ccc;">
                <option value="">â€” select room â€”</option>
            </select>
            <div style="margin-top:6px;font-size:10px;color:var(--dim);">Flash color:
                <select id="teleportFlashColor" style="background:#0a0a0a;border:1px solid var(--border);color:#ccc;font-size:11px;padding:2px 4px;">
                    <option value="white">â¬œ White (default)</option>
                    <option value="purple">ğŸŸ£ Purple (mystical)</option>
                    <option value="gold">ğŸŸ¡ Gold (divine)</option>
                    <option value="red">ğŸ”´ Red (demonic)</option>
                    <option value="blue">ğŸ”µ Blue (arcane)</option>
                    <option value="green">ğŸŸ¢ Green (nature)</option>
                </select>
            </div>
        </div>

        <!-- ACTIONS -->
        <div class="btn-row" style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px;">
            <button class="btn-a" onclick="saveRoom()">ğŸ’¾ Save Room</button>
            <button onclick="setAsStartRoom()">ğŸš© Set Start</button>
            <button class="btn-d" onclick="deleteRoom()">Ã— Delete</button>
        </div>
    </div>
</div>

<div class="section">
    <div class="section-title" onclick="toggleSec(this)">Export / Import <span>â–¾</span></div>
    <div class="section-body collapsible-content">
        <div class="btn-row">
            <button onclick="validateDungeon()">âœ“ Validate</button>
            <button class="btn-g" onclick="exportDungeon()">â†“ Export</button>
            <button onclick="importDungeon()">â†‘ Import</button>
        </div>
    </div>
</div>

</div>
<div id="statusBar">
    <span id="statusMsg">Ready</span>
    <span id="roomCountLbl">0 rooms</span>
</div>
</div>

<!-- MAP -->
<div id="mapContainer">
<div id="toolbar">
    <button class="btn-a" onclick="setMode('add')" id="btn-add">â• Add</button>
    <button onclick="setMode('connect')" id="btn-connect">ğŸ”— Connect</button>
    <button onclick="setMode('edit')" id="btn-edit">âœ Edit</button>
    <button class="btn-g" onclick="openEnemyEditor()" id="btn-enemy-editor" style="border-color:var(--orange);color:var(--orange);background:rgba(232,135,74,.08);">ğŸ‘¹ Add/Edit Enemies</button>
    <button onclick="openVersionEditor()" style="border-color:var(--accent);color:var(--accent);background:rgba(0,200,150,.08);">ğŸ“‹ Versions</button>
    <button onclick="openSpellEditor()" style="border-color:var(--blue);color:var(--blue);background:rgba(74,142,232,.08);">âœ¨ Spells</button>
    <button onclick="openWeaponEditor()" style="border-color:var(--red);color:var(--red);background:rgba(232,74,74,.08);">âš” Weapons</button>
    <button onclick="openArmorEditor()" style="border-color:var(--purple);color:var(--purple);background:rgba(168,85,247,.08);">ğŸ›¡ Armor</button>
    <span style="width:1px;background:var(--border);height:20px;margin:0 2px;"></span>
    <button onclick="undo()" title="Ctrl+Z">â†©</button>
    <button onclick="redo()" title="Ctrl+Y">â†ª</button>
    <span style="width:1px;background:var(--border);height:20px;margin:0 2px;"></span>
    <button class="btn-p" onclick="startSimulation()">â–¶ Simulate</button>
    <span style="width:1px;background:var(--border);height:20px;margin:0 6px;"></span>
    <label style="font-size:11px;color:var(--dim);white-space:nowrap;">Grid:</label>
    <select id="gridSizeSelect"
        style="background:#0a0e11;border:1px solid var(--border);color:var(--dim);font-size:11px;padding:2px 4px;cursor:pointer;"
        onchange="resizeGrid(parseInt(this.value))">
        <option value="16">16Ã—16</option>
        <option value="24">24Ã—24</option>
        <option value="32" selected>32Ã—32 (default)</option>
        <option value="48">48Ã—48</option>
        <option value="64">64Ã—64</option>
    </select>
    <span id="modeLabel">MODE: ADD</span>
</div>
<div id="mapArea">
    <div style="position:relative;">
        <svg id="connections"></svg>
        <div id="grid"></div>
    </div>
</div>
</div>

<!-- SIMULATOR -->
<div id="simulatorPanel">
<div id="simHeader">
    <span>âš” SIMULATOR</span>
    <span id="simFloorLbl">Floor 1</span>
</div>
<div id="terminalOutput"></div>
<div id="termInputRow">
    <span>â€º</span>
    <input id="terminalInput" type="text" placeholder="n s e w ne nw se sw  |  u d  |  pick [key]">
</div>
<div id="simControls">
    <button class="btn-a" onclick="startSimulation()">â–¶ Start</button>
    <button class="btn-d" onclick="stopSimulation()">â–  Stop</button>
    <span id="simHpLbl">HP: 100/100</span>
</div>
</div>

<script src="monsters-expanded.js"></script>
<script src="items.js"></script>
<script>
'use strict';

// â”€â”€ RARITY CONFIG (inline â€” editor is self-contained, no monsters.js dependency) â”€â”€
const RARITY_OPTIONS = [
    { value:'common',   label:'Common',   color:'#FFFFFF' },
    { value:'uncommon', label:'Uncommon', color:'#00FF00' },
    { value:'rare',     label:'Rare',     color:'#0099FF' },
    { value:'epic',     label:'Epic',     color:'#9933FF' },
    { value:'legendary',label:'Legendary',color:'#FF9900' },
    { value:'mythic',   label:'Mythic',   color:'#FF0000' },
];

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let GRID = 32, CELL = 50;   // mutable â€” changed by resizeGrid()
let roomCounter = 0;

const DOOR_TYPES = {
    bronze:   { color:"#cd7f32", label:"Bronze Key"   },
    copper:   { color:"#b87333", label:"Copper Key"   },
    iron:     { color:"#a8a9ad", label:"Iron Key"     },
    brass:    { color:"#b5a642", label:"Brass Key"    },
    silver:   { color:"#c0c0c0", label:"Silver Key"   },
    electrum: { color:"#d4af37", label:"Electrum Key" },
    ruby:     { color:"#e0455b", label:"Ruby Key"     },
    topaz:    { color:"#ffa07a", label:"Topaz Key"    },
    diamond:  { color:"#aef0ff", label:"Diamond Key"  },
    obsidian: { color:"#9b59b6", label:"Obsidian Key" },
    bone:     { color:"#e8dcc8", label:"Bone Key"     },
};

const DROP_ITEMS = {
    "":            "â€” no drop â€”",
    bronze_key:    "ğŸ— Bronze Key",
    copper_key:    "ğŸ— Copper Key",
    iron_key:      "ğŸ— Iron Key",
    brass_key:     "ğŸ— Brass Key",
    silver_key:    "ğŸ— Silver Key",
    electrum_key:  "ğŸ— Electrum Key",
    ruby_key:      "ğŸ— Ruby Key",
    topaz_key:     "ğŸ— Topaz Key",
    diamond_key:   "ğŸ— Diamond Key",
    obsidian_key:  "ğŸ— Obsidian Key",
    bone_key:      "ğŸ— Bone Key",
    ancient_map:   "ğŸ“œ Ancient Map",
    dungeon_note:  "ğŸ“„ Dungeon Note",
    rune_fragment: "âœ¦ Rune Fragment",
    chest_small:   "ğŸ“¦ Small Chest",
    chest_large:   "ğŸ“¦ Large Chest",
    staff_piece_1: "ğŸª„ Staff Piece I â€” The Base",
    staff_piece_2: "ğŸª„ Staff Piece II â€” The Shaft",
    staff_piece_3: "ğŸª„ Staff Piece III â€” The Binding",
    staff_piece_4: "ğŸª„ Staff Piece IV â€” The Rune Ring",
    staff_piece_5: "ğŸª„ Staff Piece V â€” The Conduit",
    staff_piece_6: "ğŸª„ Staff Piece VI â€” The Focus Lens",
    staff_piece_7: "ğŸª„ Staff Piece VII â€” The Collar",
    staff_piece_8: "ğŸª„ Staff Piece VIII â€” The Crown Gem",
};

const TRAP_CONFIG = {
    spike:     { icon:"ğŸ—¡", name:"Spike Trap",     color:"#e84a4a", defaultDmg:15, desc:"Spikes burst from floor on entry.",          dotDuration:0  },
    poison:    { icon:"â˜ ", name:"Poison Trap",    color:"#27ae60", defaultDmg:5,  desc:"Dart fires; poisons for X seconds.",          dotDuration:10 },
    stone:     { icon:"ğŸª¨", name:"Stone Trap",    color:"#95a5a6", defaultDmg:20, desc:"A heavy stone drops on entry.",               dotDuration:0  },
    fire:      { icon:"ğŸ”¥", name:"Fire Trap",     color:"#e67e22", defaultDmg:12, desc:"Flames erupt from the floor.",               dotDuration:0  },
    lightning: { icon:"âš¡", name:"Lightning Trap",color:"#f1c40f", defaultDmg:18, desc:"A bolt strikes on entry.",                    dotDuration:0  },
    freeze:    { icon:"â„", name:"Freeze Trap",   color:"#74b9ff", defaultDmg:8,  desc:"Ice blast slows and deals damage.",           dotDuration:0  },
    alarm:     { icon:"ğŸ””", name:"Alarm Trap",    color:"#dfe6e9", defaultDmg:0,  desc:"Triggers and summons nearby monsters.",       dotDuration:0  },
    pit:       { icon:"ğŸ•³", name:"Pit Trap",      color:"#636e72", defaultDmg:25, desc:"Floor gives way; fall damage.",               dotDuration:0  },
    acid:      { icon:"ğŸ§ª", name:"Acid Trap",     color:"#a8e63d", defaultDmg:10, desc:"Acid spray; corrodes armor and deals damage.", dotDuration:5 },
    web:       { icon:"ğŸ•¸", name:"Web Trap",      color:"#b2bec3", defaultDmg:0,  desc:"Sticky web slows movement (stun 2 rounds).",  dotDuration:0  },
    curse:     { icon:"ğŸŒ€", name:"Curse Trap",    color:"#a855f7", defaultDmg:0,  desc:"Reduces player stats temporarily.",           dotDuration:0  },
};

const editorState = { activeFloor:1, mode:'add', selectedRoomId:null, connectBuffer:[] };
const simulator   = { active:false, floor:1, roomId:null, keys:[], hp:100, maxHp:100 };
const dungeon     = { name:"New Dungeon", description:"", floors:{ 1:{ startRoom:null, rooms:{} } } };
const history     = { undoStack:[], redoStack:[], max:100 };
let hasUnsaved = false, dragData = null;

// â”€â”€ GRID SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const grid = document.getElementById('grid');

function buildGrid() {
    // Clear old cells (keep room divs â€” they're re-rendered by render())
    grid.querySelectorAll('.cell').forEach(c => c.remove());
    grid.style.gridTemplateColumns = `repeat(${GRID},${CELL}px)`;
    grid.style.gridTemplateRows    = `repeat(${GRID},${CELL}px)`;
    grid.style.width  = GRID * CELL + 'px';
    grid.style.height = GRID * CELL + 'px';
    // Update SVG overlay size
    const svg = document.getElementById('connections');
    svg.style.width  = GRID * CELL + 'px';
    svg.style.height = GRID * CELL + 'px';
    for (let y = 0; y < GRID; y++) for (let x = 0; x < GRID; x++) {
        const c = document.createElement('div');
        c.className = 'cell'; c.dataset.x = x; c.dataset.y = y;
        c.onclick = () => handleCellClick(x, y);
        grid.appendChild(c);
    }
}
buildGrid();  // initial build

function resizeGrid(newSize) {
    // Validate rooms still fit
    const floor = dungeon.floors[editorState.activeFloor];
    if (floor) {
        for (const id in floor.rooms) {
            const r = floor.rooms[id];
            if (r.map.x >= newSize || r.map.y >= newSize) {
                updateStatus(`âš  Can't shrink: room ${id} is outside ${newSize}Ã—${newSize}`);
                // Reset dropdown to current size
                document.getElementById('gridSizeSelect').value = String(GRID);
                return;
            }
        }
    }
    GRID = newSize;
    buildGrid();
    render();
    updateStatus(`Grid resized to ${GRID}Ã—${GRID}`);
}

// â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStatus(msg) {
    document.getElementById('statusMsg').textContent = msg;
    const fl = dungeon.floors[editorState.activeFloor];
    document.getElementById('roomCountLbl').textContent = fl ? Object.keys(fl.rooms).length+' rooms' : '0 rooms';
}
function markDirty()  { hasUnsaved=true;  document.getElementById('dirtyDot').style.display='inline'; }
function markClean()  { hasUnsaved=false; document.getElementById('dirtyDot').style.display='none'; }
function toggleSec(el){ const c=el.nextElementSibling; c.classList.toggle('collapsed'); el.querySelector('span:last-child').textContent=c.classList.contains('collapsed')?'â–¸':'â–¾'; }

// â”€â”€ FLOORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateFloorTabs() {
    const tabs = document.getElementById('floorTabs');
    tabs.innerHTML='';
    for (const f in dungeon.floors) {
        const btn=document.createElement('button');
        btn.className='floor-tab'+(parseInt(f)===editorState.activeFloor?' active':'');
        btn.textContent='F'+f; btn.onclick=()=>switchFloor(parseInt(f));
        tabs.appendChild(btn);
    }
    populateLadderFloors();
}
function switchFloor(f) {
    editorState.activeFloor=f; editorState.selectedRoomId=null;
    document.getElementById('inspectorSection').style.display='none';
    updateFloorTabs(); render();
}
function addFloor() {
    const n=Object.keys(dungeon.floors).length+1;
    dungeon.floors[n]={startRoom:null,rooms:{}};
    updateFloorTabs(); markDirty(); updateStatus('Floor '+n+' added.');
}
function deleteCurrentFloor() {
    const f=editorState.activeFloor;
    if (Object.keys(dungeon.floors).length<=1){updateStatus("Can't delete last floor.");return;}
    if (!confirm('Delete Floor '+f+' and all rooms?')) return;
    delete dungeon.floors[f];
    editorState.activeFloor=parseInt(Object.keys(dungeon.floors)[0]);
    updateFloorTabs(); render(); markDirty(); updateStatus('Floor '+f+' deleted.');
}

// â”€â”€ ROOM MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleCellClick(x,y) {
    const floor=dungeon.floors[editorState.activeFloor];
    const entry=Object.entries(floor.rooms).find(([,r])=>r.map.x===x&&r.map.y===y);
    if (entry) {
        const [id]=entry;
        if (editorState.mode==='edit'||editorState.mode==='select') selectRoomForEdit(id);
        else if (editorState.mode==='connect') selectRoomForConnect(id);
        else updateStatus('Cell occupied. Use Edit mode.');
    } else if (editorState.mode==='add') {
        addRoom(x,y);
    }
}

function addRoom(x,y) {
    const floor=dungeon.floors[editorState.activeFloor];
    if (Object.values(floor.rooms).some(r=>r.map.x===x&&r.map.y===y)){updateStatus('Cell occupied.');return;}
    pushHistory();
    const id='R'+(++roomCounter);
    floor.rooms[id]={name:'',description:'',map:{x,y},exits:{},contents:{},flags:{discovered:false}};
    if (!floor.startRoom) floor.startRoom=id;
    markDirty(); render(); selectRoomForEdit(id); updateStatus(id+' created.');
}

function deleteRoom() {
    const floor=dungeon.floors[editorState.activeFloor];
    const id=editorState.selectedRoomId;
    if (!id||!floor.rooms[id]){updateStatus('No room selected.');return;}
    pushHistory();
    for (const rid in floor.rooms){ const ex=floor.rooms[rid].exits; for (const d in ex) if(ex[d]===id) delete ex[d]; }
    delete floor.rooms[id];
    if (floor.startRoom===id){ const rem=Object.keys(floor.rooms); floor.startRoom=rem.length?rem[0]:null; }
    editorState.selectedRoomId=null;
    document.getElementById('inspectorSection').style.display='none';
    markDirty(); render(); updateStatus(id+' deleted.');
}

function setAsStartRoom() {
    const id=editorState.selectedRoomId; if(!id) return;
    dungeon.floors[editorState.activeFloor].startRoom=id;
    markDirty(); render(); updateStatus(id+' set as start room.');
}

function selectRoomForEdit(id) {
    editorState.selectedRoomId=id;
    const r=dungeon.floors[editorState.activeFloor].rooms[id];
    document.getElementById('inspectorSection').style.display='block';
    document.getElementById('inspRoomId').textContent=id;
    document.getElementById('roomName').value=r.name||'';
    document.getElementById('roomDesc').value=r.description||'';
    loadEnemies(r); loadTraps(r); loadDoors(r); loadLadder(r);
    document.querySelectorAll('.room').forEach(el=>el.classList.remove('selected'));
    const el=document.querySelector(`.room[data-room-id="${id}"]`);
    if(el) el.classList.add('selected');
    updateStatus('Editing '+id);
}

// â”€â”€ ENEMIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getEnemyList() {
    // monsters-expanded.js defines ENEMIES as a top-level const â€” available as window.ENEMIES
    return (typeof window.ENEMIES !== 'undefined' && window.ENEMIES)
        || (typeof ENEMIES !== 'undefined' && ENEMIES)
        || null;
}

function populateEnemyDropdown() {
    const sel = document.getElementById('enemySelect');
    if (!sel) return;
    const enemyList = getEnemyList();
    if (!enemyList) {
        // Script still loading â€” retry briefly
        setTimeout(populateEnemyDropdown, 100);
        return;
    }
    sel.innerHTML = '';
    
    // Build array with level info for sorting
    const enemies = [];
    for (const key in enemyList) {
        if (enemyList.hasOwnProperty(key)) {
            const data = enemyList[key];
            enemies.push({
                key: key,
                name: (data && data.name) ? data.name : key,
                level: (data && typeof data.level === 'number') ? data.level : 999
            });
        }
    }
    
    // Sort by level first, then by name
    enemies.sort((a, b) => {
        if (a.level !== b.level) return a.level - b.level;
        return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
    });
    
    enemies.forEach(e => {
        const o = document.createElement('option');
        o.value = e.key;
        o.textContent = e.name + ' [Lvl ' + e.level + ']';
        sel.appendChild(o);
    });
    
    updateStatus('Loaded ' + enemies.length + ' monsters.');
}

function addEnemyToRoom() {
    if(!editorState.selectedRoomId) return;
    const key=document.getElementById('enemySelect').value; if(!key) return;
    const r=dungeon.floors[editorState.activeFloor].rooms[editorState.selectedRoomId];
    if(!r.contents.enemies) r.contents.enemies=[];
    r.contents.enemies.push({key, drop:'', rarity:'common'});
    loadEnemies(r);
}

function makeRaritySelect(currentRarity, onChangeFn) {
    const sel = document.createElement('select');
    sel.style.cssText = 'flex:1;font-size:11px;padding:3px 5px;';
    RARITY_OPTIONS.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        o.style.color = opt.color;
        if (opt.value === (currentRarity || 'common')) o.selected = true;
        sel.appendChild(o);
    });
    // Colour the select itself to match current rarity
    function updateColor() {
        const cfg = RARITY_OPTIONS.find(r => r.value === sel.value);
        sel.style.color = cfg ? cfg.color : '#ccc';
        sel.style.borderColor = cfg ? cfg.color : 'var(--border)';
    }
    updateColor();
    sel.onchange = () => { updateColor(); onChangeFn(sel.value); };
    return sel;
}

function loadEnemies(r) {
    const list = document.getElementById('enemyList');
    list.innerHTML = '';
    const enemies = r.contents?.enemies || [];
    const enemyList = getEnemyList();

    if (!enemies.length) {
        list.innerHTML = '<div style="font-size:11px;color:var(--dim);padding:3px 0;">No enemies.</div>';
        return;
    }

    enemies.forEach((entry, idx) => {
        const key     = typeof entry === 'string' ? entry : entry.key;
        const drop    = typeof entry === 'string' ? '' : (entry.drop || '');
        const rarity  = typeof entry === 'string' ? 'common' : (entry.rarity || 'common');
        
        // Get enemy data to find level
        const enemyData = enemyList && enemyList[key];
        const name    = enemyData ? enemyData.name : key;
        const level   = enemyData && typeof enemyData.level === 'number' ? enemyData.level : '?';
        
        const rarCfg  = RARITY_OPTIONS.find(o => o.value === rarity) || RARITY_OPTIONS[0];

        // Normalise entry to object so rarity persists
        if (typeof r.contents.enemies[idx] === 'string') {
            r.contents.enemies[idx] = { key, drop, rarity };
        }

        const div = document.createElement('div');
        div.className = 'enemy-entry';
        // Highlight border with rarity colour
        div.style.borderColor = rarCfg.color + '55';

        // â”€â”€ Header row: name + level + remove button â”€â”€
        const hdr = document.createElement('div'); hdr.className = 'enemy-header';
        const nm  = document.createElement('span'); nm.className = 'enemy-name';
        nm.style.color = rarCfg.color;
        // Show name with level
        nm.innerHTML = 'ğŸ‘¹ ' + name + ' <span style="color:#888;font-size:10px;">[Lvl ' + level + ']</span>';
        const rm  = document.createElement('button'); rm.className = 'btn-d';
        rm.textContent = 'Ã— Remove'; rm.style.cssText = 'padding:2px 7px;font-size:10px;';
        rm.onclick = () => { enemies.splice(idx, 1); loadEnemies(r); };
        hdr.appendChild(nm); hdr.appendChild(rm); div.appendChild(hdr);

        // â”€â”€ Rarity row â”€â”€
        const rr = document.createElement('div'); rr.className = 'drop-row';
        rr.style.marginBottom = '3px';
        const rlbl = document.createElement('span');
        rlbl.textContent = 'â˜… Rarity:';
        rlbl.style.cssText = 'font-size:11px;color:var(--dim);white-space:nowrap;';
        const rsel = makeRaritySelect(rarity, newRarity => {
            r.contents.enemies[idx].rarity = newRarity;
            // Update border and name colour live
            const cfg = RARITY_OPTIONS.find(o => o.value === newRarity) || RARITY_OPTIONS[0];
            div.style.borderColor = cfg.color + '55';
            nm.style.color = cfg.color;
        });
        rr.appendChild(rlbl); rr.appendChild(rsel); div.appendChild(rr);

        // â”€â”€ Drop row â”€â”€
        const dr   = document.createElement('div'); dr.className = 'drop-row';
        const dlbl = document.createElement('span'); dlbl.textContent = 'â¬¡ Drop:';
        dlbl.style.cssText = 'font-size:11px;color:var(--gold);white-space:nowrap;';
        const dsel = document.createElement('select');
        dsel.style.cssText = 'flex:1;font-size:11px;padding:3px 5px;';
        for (const k in DROP_ITEMS) {
            const o = document.createElement('option');
            o.value = k; o.textContent = DROP_ITEMS[k];
            if (k === drop) o.selected = true;
            dsel.appendChild(o);
        }
        dsel.onchange = () => { r.contents.enemies[idx].drop = dsel.value; };
        dr.appendChild(dlbl); dr.appendChild(dsel); div.appendChild(dr);

        list.appendChild(div);
    });
}
// â”€â”€ TRAPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addTrapToRoom() {
    if(!editorState.selectedRoomId) return;
    const type=document.getElementById('trapTypeSelect').value;
    const r=dungeon.floors[editorState.activeFloor].rooms[editorState.selectedRoomId];
    if(!r.contents.traps) r.contents.traps=[];
    const cfg=TRAP_CONFIG[type]||{defaultDmg:10, dotDuration:0};
    r.contents.traps.push({ type, damage:cfg.defaultDmg, duration:cfg.dotDuration, resetOnLeave:true, triggered:false });
    loadTraps(r);
}

function loadTraps(r) {
    const list=document.getElementById('trapList');
    list.innerHTML='';
    const traps=r.contents?.traps||[];
    if(!traps.length){
        list.innerHTML='<div style="font-size:11px;color:var(--dim);padding:3px 0;">No traps.</div>';
        return;
    }
    traps.forEach((trap,idx)=>{
        const cfg=TRAP_CONFIG[trap.type]||{icon:'?',name:trap.type,color:'#888',desc:'',dotDuration:0};
        const div=document.createElement('div'); div.className='trap-entry';

        // Header
        const hdr=document.createElement('div'); hdr.className='trap-header';
        const nm=document.createElement('span'); nm.className='trap-name'; nm.style.color=cfg.color; nm.textContent=cfg.icon+' '+cfg.name;
        const rm=document.createElement('button'); rm.className='btn-d'; rm.textContent='Ã— Remove';
        rm.style.cssText='padding:2px 7px;font-size:10px;';
        rm.onclick=()=>{ traps.splice(idx,1); loadTraps(r); };
        hdr.appendChild(nm); hdr.appendChild(rm); div.appendChild(hdr);

        const desc=document.createElement('div'); desc.className='trap-desc'; desc.textContent=cfg.desc; div.appendChild(desc);

        const fields=document.createElement('div'); fields.className='trap-fields';

        // Damage field
        const dl=document.createElement('label'); dl.textContent='Damage';
        const di=document.createElement('input'); di.type='number'; di.min='0'; di.max='999';
        di.value=trap.damage||0; di.oninput=()=>{ trap.damage=parseInt(di.value)||0; };

        // Duration / repeat
        const xl=document.createElement('label');
        const xi=document.createElement('input'); xi.type='number'; xi.min='0'; xi.max='120';
        if (cfg.dotDuration>0) {
            xl.textContent='Duration (sec)'; xi.value=trap.duration||cfg.dotDuration;
            xi.oninput=()=>{ trap.duration=parseInt(xi.value)||0; };
        } else {
            xl.textContent='Repeat (0=once)'; xi.value=trap.repeatCount||0;
            xi.oninput=()=>{ trap.repeatCount=parseInt(xi.value)||0; };
        }

        // Re-arm toggle
        const ra=document.createElement('div'); ra.className='trap-rearm';
        const rc=document.createElement('input'); rc.type='checkbox'; rc.style.width='auto';
        rc.checked=trap.resetOnLeave!==false; rc.onchange=()=>{ trap.resetOnLeave=rc.checked; };
        const rl=document.createElement('label'); rl.textContent='Re-arm when player leaves room';
        ra.appendChild(rc); ra.appendChild(rl);

        fields.appendChild(dl); fields.appendChild(di);
        fields.appendChild(xl); fields.appendChild(xi);
        fields.appendChild(ra);
        div.appendChild(fields);
        list.appendChild(div);
    });
}

// â”€â”€ LADDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateLadderFloors() {
    const sel=document.getElementById('ladderFloor'); const cur=sel.value;
    sel.innerHTML='<option value="">â€” floor â€”</option>';
    for (const f in dungeon.floors){
        if(parseInt(f)===editorState.activeFloor) continue;
        const o=document.createElement('option'); o.value=f; o.textContent='Floor '+f;
        sel.appendChild(o);
    }
    if(cur) sel.value=cur;
}

function populateLadderRooms() {
    const fk=document.getElementById('ladderFloor').value;
    const sel=document.getElementById('ladderTargetRoom'); const cur=sel.value;
    sel.innerHTML='<option value="">â€” room â€”</option>';
    if(!fk||!dungeon.floors[fk]) return;
    for (const id in dungeon.floors[fk].rooms){ const o=document.createElement('option'); o.value=id; o.textContent=id; sel.appendChild(o); }
    if(cur) sel.value=cur;
}

function loadLadder(r) {
    const ds=document.getElementById('ladderDirection');
    const fs=document.getElementById('ladderFloor');
    const rs=document.getElementById('ladderTargetRoom');
    if(r.contents?.ladder){
        ds.value=r.contents.ladder.direction||'';
        fs.value=String(r.contents.ladder.leadsTo?.floor||'');
        populateLadderRooms();
        rs.value=r.contents.ladder.leadsTo?.room||'';
    } else { ds.value=''; fs.value=''; rs.innerHTML='<option value="">â€” room â€”</option>'; }

    // Load runestone selection
    const rsel = document.getElementById('runestoneSelect');
    if (rsel) rsel.value = r.contents?.runestone || '';

    // Load ground loot
    populateLootItemSelect();
    roomLootItems = Array.isArray(r.contents?.lootTable) ? [...r.contents.lootTable] : [];
    renderLootChips();

    // Load teleport trigger
    populateStaffFloors();
    const stEn  = document.getElementById('staffTriggerEnabled');
    const stUi  = document.getElementById('staffTriggerUI');
    const st    = r.contents?.staffTrigger;
    if (st?.enabled) {
        stEn.checked = true;
        stUi.style.display = '';
        const ttSel = document.getElementById('teleportTriggerType');
        if (ttSel) ttSel.value = st.triggerType || 'enter_room';
        const fcSel = document.getElementById('teleportFlashColor');
        if (fcSel) fcSel.value = st.flashColor || 'white';
        const depInp = document.getElementById('teleportDepositItem');
        if (depInp) depInp.value = st.depositItem || '';
        const depRow = document.getElementById('triggerDepositRow');
        if (depRow) depRow.style.display = (st.triggerType === 'item_deposited') ? '' : 'none';
        document.getElementById('staffTargetFloor').value = String(st.targetFloor||'');
        populateStaffTargetRooms();
        document.getElementById('staffTargetRoom').value = st.targetRoom||'';
        updateTeleportTriggerDesc();
    } else {
        stEn.checked = false;
        stUi.style.display = 'none';
        document.getElementById('staffTargetFloor').value = '';
        document.getElementById('staffTargetRoom').innerHTML = '<option value="">â€” select room â€”</option>';
    }
}

// â”€â”€ DOORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadDoors(r) {
    const con=document.getElementById('doorEditor'); con.innerHTML='';
    const exits=r.exits||{};
    const DNAMES={n:'North',ne:'NE',e:'East',se:'SE',s:'South',sw:'SW',w:'West',nw:'NW'};
    const keys=Object.keys(exits);
    if(!keys.length){ con.innerHTML='<div style="font-size:11px;color:var(--dim);">Connect exits first.</div>'; return; }
    keys.forEach(dir=>{
        const wrap=document.createElement('div'); wrap.style.cssText='display:flex;align-items:center;gap:8px;margin-bottom:5px;';
        const lbl=document.createElement('span'); lbl.style.cssText='font-size:11px;color:var(--dim);width:52px;'; lbl.textContent=(DNAMES[dir]||dir.toUpperCase())+':';
        const sel=document.createElement('select'); sel.dataset.dir=dir; sel.style.cssText='flex:1;padding:4px 6px;font-size:11px;';
        const emp=document.createElement('option'); emp.value=''; emp.textContent='â€” none â€”'; sel.appendChild(emp);
        for (const t in DOOR_TYPES){ const o=document.createElement('option'); o.value=t; o.textContent=DOOR_TYPES[t].label; o.style.color=DOOR_TYPES[t].color; sel.appendChild(o); }
        const ex=r.contents?.doors?.[dir]; if(ex) sel.value=ex.type;
        wrap.appendChild(lbl); wrap.appendChild(sel); con.appendChild(wrap);
    });
}

// â”€â”€ LOOT TABLE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let roomLootItems = [];

function populateLootItemSelect() {
    const sel = document.getElementById('lootItemSelect');
    if (!sel) return;
    const prev = sel.value;
    sel.innerHTML = '<option value="">â€” pick item â€”</option>';
    const items = Object.keys(ieWorkingCopy).length ? ieWorkingCopy :
                  (typeof ITEMS !== 'undefined' ? ITEMS : {});
    const sorted = Object.entries(items).sort((a,b)=>(a[1].name||a[0]).localeCompare(b[1].name||b[0]));
    sorted.forEach(([k,v]) => {
        const o = document.createElement('option');
        o.value = k;
        o.textContent = (v.icon||'ğŸ“¦') + ' ' + (v.name||k);
        sel.appendChild(o);
    });
    if (prev) sel.value = prev;
}

function addLootItem() {
    const sel = document.getElementById('lootItemSelect');
    const key = sel?.value;
    if (!key) return;
    roomLootItems.push(key);
    renderLootChips();
    sel.value = '';
}

function removeLootItem(idx) {
    roomLootItems.splice(idx, 1);
    renderLootChips();
}

function renderLootChips() {
    const container = document.getElementById('lootItemChips');
    if (!container) return;
    container.innerHTML = '';
    const allItems = Object.keys(ieWorkingCopy).length ? ieWorkingCopy :
                     (typeof ITEMS !== 'undefined' ? ITEMS : {});
    roomLootItems.forEach((key, idx) => {
        const d = allItems[key];
        const label = d ? (d.icon||'ğŸ“¦') + ' ' + d.name : key;
        const chip = document.createElement('span');
        chip.className = 'drop-chip';
        chip.innerHTML = `${label} <button class="chip-remove" onclick="removeLootItem(${idx})" title="Remove">Ã—</button>`;
        container.appendChild(chip);
    });
}

// â”€â”€ STAFF TRIGGER HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateStaffFloors() {
    const sel = document.getElementById('staffTargetFloor');
    const cur = sel.value;
    sel.innerHTML = '<option value="">â€” select floor â€”</option>';
    for (const f in dungeon.floors) {
        const o = document.createElement('option');
        o.value = f; o.textContent = 'Floor ' + f;
        sel.appendChild(o);
    }
    if (cur) sel.value = cur;
}

function populateStaffTargetRooms() {
    const fk  = document.getElementById('staffTargetFloor').value;
    const sel = document.getElementById('staffTargetRoom');
    const cur = sel.value;
    sel.innerHTML = '<option value="">â€” select room â€”</option>';
    if (!fk || !dungeon.floors[fk]) return;
    const fl = dungeon.floors[fk];
    // Exclude the current room from being target of itself
    const curRoom = editorState.selectedRoomId;
    for (const id in fl.rooms) {
        if (id === curRoom && String(fk) === String(editorState.activeFloor)) continue;
        const o = document.createElement('option');
        const name = fl.rooms[id].name;
        o.value = id; o.textContent = id + (name ? ' â€” ' + name : '');
        sel.appendChild(o);
    }
    if (cur) sel.value = cur;
}

function toggleStaffTriggerUI() {
    const enabled = document.getElementById('staffTriggerEnabled').checked;
    const ui = document.getElementById('staffTriggerUI');
    ui.style.display = enabled ? '' : 'none';
    if (enabled) { populateStaffFloors(); updateTeleportTriggerDesc(); }
}

function updateTeleportTriggerDesc() {
    const sel   = document.getElementById('teleportTriggerType');
    const desc  = document.getElementById('teleportTriggerDesc');
    const depRow = document.getElementById('triggerDepositRow');
    if (!sel || !desc) return;
    const DESCS = {
        enter_room:      'Player is teleported the moment they step into this room.',
        staff_pieces:    'Player must carry all 8 Staff Pieces. Pieces are consumed on teleport.',
        lever:           'A lever appears in the room. Player must type "pull lever" to trigger.',
        enemies_cleared: 'Teleport fires once all enemies in this room have been defeated.',
        item_deposited:  'Player must drop a specific item in this room (type "deposit [item]").',
        full_health:     'Player must enter the room at full HP to trigger the teleport.',
        no_keys:         'Player must enter the room holding no dungeon keys.'
    };
    desc.textContent = DESCS[sel.value] || '';
    if (depRow) depRow.style.display = (sel.value === 'item_deposited') ? '' : 'none';
}

// â”€â”€ SAVE ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveRoom() {
    const id=editorState.selectedRoomId; if(!id) return;
    pushHistory();
    const r=dungeon.floors[editorState.activeFloor].rooms[id];
    r.name       =document.getElementById('roomName').value;
    r.description=document.getElementById('roomDesc').value;
    if(!r.contents) r.contents={};

    // Ladder
    const ld=document.getElementById('ladderDirection').value;
    const lf=document.getElementById('ladderFloor').value;
    const lr=document.getElementById('ladderTargetRoom').value;
    if(ld&&lf&&lr){ r.contents.ladder={direction:ld,leadsTo:{floor:parseInt(lf),room:lr}}; }
    else delete r.contents.ladder;

    // Doors
    const sels=document.querySelectorAll('#doorEditor select');
    let doors={};
    sels.forEach(s=>{ if(s.value) doors[s.dataset.dir]={type:s.value,locked:true}; });
    if(Object.keys(doors).length) r.contents.doors=doors; else delete r.contents.doors;

    // Clean empty
    if(r.contents.enemies&&!r.contents.enemies.length) delete r.contents.enemies;
    if(r.contents.traps&&!r.contents.traps.length)     delete r.contents.traps;

    // Runestone â€” save color key or remove if none selected
    const rsVal = document.getElementById('runestoneSelect')?.value || '';
    if (rsVal) r.contents.runestone = rsVal;
    else       delete r.contents.runestone;

    // Ground loot table
    const lootItems = [...roomLootItems];
    if (lootItems.length) r.contents.lootTable = lootItems;
    else delete r.contents.lootTable;

    // Teleport Trigger
    const staffEnabled = document.getElementById('staffTriggerEnabled')?.checked;
    const staffFloor   = document.getElementById('staffTargetFloor')?.value;
    const staffRoom    = document.getElementById('staffTargetRoom')?.value;
    const trigType     = document.getElementById('teleportTriggerType')?.value || 'enter_room';
    const flashColor   = document.getElementById('teleportFlashColor')?.value || 'white';
    const depositItem  = document.getElementById('teleportDepositItem')?.value.trim() || '';
    if (staffEnabled && staffFloor && staffRoom) {
        r.contents.staffTrigger = {
            enabled: true,
            triggerType: trigType,
            targetFloor: parseInt(staffFloor),
            targetRoom: staffRoom,
            flashColor: flashColor,
            depositItem: depositItem || undefined
        };
        const destFloor = dungeon.floors[parseInt(staffFloor)];
        if (destFloor && destFloor.rooms[staffRoom]) {
            if (!destFloor.rooms[staffRoom].contents) destFloor.rooms[staffRoom].contents = {};
            if (!destFloor.rooms[staffRoom].contents.staffTrigger) destFloor.rooms[staffRoom].contents.staffTrigger = {};
            destFloor.rooms[staffRoom].contents.staffTrigger.isDestination = true;
        }
    } else {
        delete r.contents.staffTrigger;
    }

    markDirty(); render(); selectRoomForEdit(id); updateStatus(id+' saved.');
}

// â”€â”€ CONNECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectRoomForConnect(id) {
    if(!editorState.connectBuffer.length){
        editorState.connectBuffer.push(id);
        const el=document.querySelector(`.room[data-room-id="${id}"]`); if(el) el.style.borderColor='var(--purple)';
        updateStatus('Select second room.'); return;
    }
    const first=editorState.connectBuffer[0];
    if(first!==id) connectRooms(first,id);
    editorState.connectBuffer=[]; render();
}

function connectRooms(aId,bId) {
    const rooms=dungeon.floors[editorState.activeFloor].rooms;
    const a=rooms[aId],b=rooms[bId]; if(!a||!b) return;
    const dir=getDir(b.map.x-a.map.x,b.map.y-a.map.y);
    if(!dir){updateStatus('Must be adjacent.');return;}
    pushHistory();
    a.exits[dir]=bId; b.exits[getOpp(dir)]=aId;
    markDirty(); render(); updateStatus(aId+' â†” '+bId);
}

function getDir(dx,dy){
    if(dx===1&&dy===0) return 'e'; if(dx===-1&&dy===0) return 'w';
    if(dx===0&&dy===1) return 's'; if(dx===0&&dy===-1) return 'n';
    if(dx===1&&dy===-1) return 'ne'; if(dx===-1&&dy===-1) return 'nw';
    if(dx===1&&dy===1) return 'se'; if(dx===-1&&dy===1) return 'sw';
    return null;
}
function getOpp(d){ return{n:'s',s:'n',e:'w',w:'e',ne:'sw',sw:'ne',nw:'se',se:'nw'}[d]; }

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
    document.querySelectorAll('.room').forEach(r=>r.remove());
    const floor=dungeon.floors[editorState.activeFloor];
    if(!floor) return;
    const rooms=floor.rooms;
    for (const id in rooms){
        const r=rooms[id];
        const cell=document.querySelector(`.cell[data-x='${r.map.x}'][data-y='${r.map.y}']`);
        if(!cell) continue;
        const div=document.createElement('div'); div.className='room';
        if(id===floor.startRoom) div.classList.add('startRoom');
        if(id===editorState.selectedRoomId) div.classList.add('selected');
        div.dataset.roomId=id;
        const icons=getRoomIcons(r);
        div.innerHTML=`<div class="room-id">${id}</div>${icons?`<div class="room-icons">${icons}</div>`:''}`;
        renderDoorSymbols(r,div);
        div.onmousedown=e=>startDrag(e,id);
        div.onclick=e=>{ e.stopPropagation();
            if(editorState.mode==='edit') selectRoomForEdit(id);
            else if(editorState.mode==='connect') selectRoomForConnect(id);
        };
        cell.appendChild(div);
    }
    drawConnections();
    updateStatus(document.getElementById('statusMsg').textContent);
}

function getRoomIcons(r) {
    let ic=[];
    if(r.contents?.enemies?.length)  ic.push('ğŸ‘¹');
    if(r.contents?.traps?.length)    ic.push('âš ');
    if(r.contents?.doors)            ic.push('ğŸ”’');
    if(r.contents?.ladder)           ic.push(r.contents.ladder.direction==='up'?'â¬†':'â¬‡');
    if(r.flags?.townExit==='town1')  ic.push('ğŸ˜');
    if(r.flags?.townExit==='town2')  ic.push('ğŸŒ‹');
    if(r.contents?.lootTable?.length) ic.push('ğŸ’°');
    if(r.contents?.staffTrigger?.enabled) ic.push('<span style="color:#a855f7;font-size:11px;">ğŸŒ€</span>');
    if(r.contents?.staffTrigger?.isDestination) ic.push('<span style="color:#a855f7;font-size:10px;">âœ¦ğŸª„</span>');
    if(r.contents?.runestone) {
        const RSTONE_COLORS = {
            white_runestone:'#FFFFFF',  yellow_runestone:'#FFD700',
            green_runestone:'#00FF88',  blue_runestone:'#44AAFF',
            purple_runestone:'#BB66FF', brown_runestone:'#CC8844',
            black_runestone:'#888888',  red_runestone:'#FF3333'
        };
        const col = RSTONE_COLORS[r.contents.runestone] || '#FFFFFF';
        ic.push(`<span style="color:${col};font-size:11px;font-weight:bold;">âœ¦</span>`);
    }
    return ic.join('');
}

function renderDoorSymbols(room,div) {
    if(!room.contents?.doors) return;
    const POS={n:{top:'-9px',left:'50%',transform:'translateX(-50%)'},s:{bottom:'-9px',left:'50%',transform:'translateX(-50%)'},e:{right:'-9px',top:'50%',transform:'translateY(-50%)'},w:{left:'-9px',top:'50%',transform:'translateY(-50%)'},ne:{top:'-9px',right:'-9px'},nw:{top:'-9px',left:'-9px'},se:{bottom:'-9px',right:'-9px'},sw:{bottom:'-9px',left:'-9px'}};
    for (const dir in room.contents.doors){
        const cfg=DOOR_TYPES[room.contents.doors[dir].type]; if(!cfg) continue;
        const s=document.createElement('div'); s.textContent='#';
        s.style.cssText=`position:absolute;color:${cfg.color};font-weight:bold;font-size:12px;z-index:30;line-height:1;`;
        Object.assign(s.style,POS[dir]||{}); div.appendChild(s);
    }
}

function drawConnections() {
    const svg=document.getElementById('connections'); svg.innerHTML='';
    const floor=dungeon.floors[editorState.activeFloor]; if(!floor) return;
    const rooms=floor.rooms;
    const gr=grid.getBoundingClientRect();
    const drawn=new Set();
    for (const id in rooms){
        const fr=rooms[id];
        const fe=document.querySelector(`.room[data-room-id="${id}"]`); if(!fe) continue;
        const fr2=fe.getBoundingClientRect();
        const x1=fr2.left+fr2.width/2-gr.left, y1=fr2.top+fr2.height/2-gr.top;
        for (const dir in fr.exits){
            const toId=fr.exits[dir];
            const pk=[id,toId].sort().join(':'); if(drawn.has(pk)) continue; drawn.add(pk);
            const te=document.querySelector(`.room[data-room-id="${toId}"]`); if(!te) continue;
            const tr=te.getBoundingClientRect();
            const x2=tr.left+tr.width/2-gr.left, y2=tr.top+tr.height/2-gr.top;
            const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
            ln.setAttribute('x1',x1); ln.setAttribute('y1',y1); ln.setAttribute('x2',x2); ln.setAttribute('y2',y2);
            ln.setAttribute('stroke','#00c896'); ln.setAttribute('stroke-width','1.5'); ln.setAttribute('stroke-opacity','0.5');
            svg.appendChild(ln);
        }
    }
    // Ladder badges (yellow/blue dots)
    for (const id in rooms){
        const r=rooms[id]; if(!r.contents?.ladder) continue;
        const el=document.querySelector(`.room[data-room-id="${id}"]`); if(!el) continue;
        const rc=el.getBoundingClientRect();
        const cx=rc.left+rc.width/2-gr.left, cy=rc.top+rc.height/2-gr.top;
        const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx',cx); c.setAttribute('cy',cy-18); c.setAttribute('r','6');
        c.setAttribute('fill',r.contents.ladder.direction==='up'?'#e8b84a':'#4a8ee8'); c.setAttribute('fill-opacity','0.8');
        svg.appendChild(c);
    }
}

// â”€â”€ DRAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startDrag(e,id){
    if(editorState.mode!=='edit') return; e.preventDefault();
    dragData={id}; document.addEventListener('mousemove',onDrag); document.addEventListener('mouseup',stopDrag);
}
function onDrag(e){
    if(!dragData) return;
    const rect=grid.getBoundingClientRect();
    const x=Math.floor((e.clientX-rect.left)/CELL), y=Math.floor((e.clientY-rect.top)/CELL);
    if(x<0||y<0||x>=GRID||y>=GRID) return;
    const floor=dungeon.floors[editorState.activeFloor];
    if(Object.entries(floor.rooms).some(([rid,r])=>rid!==dragData.id&&r.map.x===x&&r.map.y===y)) return;
    floor.rooms[dragData.id].map={x,y}; render();
}
function stopDrag(){ if(dragData){pushHistory();markDirty();} dragData=null; document.removeEventListener('mousemove',onDrag); document.removeEventListener('mouseup',stopDrag); }

// â”€â”€ MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMode(m){
    editorState.mode=m; editorState.connectBuffer=[];
    document.getElementById('modeLabel').textContent='MODE: '+m.toUpperCase();
    ['add','connect','edit'].forEach(n=>{ const b=document.getElementById('btn-'+n); if(b) b.className=b.className.replace(' btn-a',''); });
    const ab=document.getElementById('btn-'+m); if(ab&&!ab.className.includes('btn-a')) ab.className+=' btn-a';
    updateStatus('Mode: '+m); render();
}

// â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pushHistory(){ history.undoStack.push(JSON.stringify(dungeon)); if(history.undoStack.length>history.max) history.undoStack.shift(); history.redoStack=[]; }
function undo(){ if(!history.undoStack.length){updateStatus('Nothing to undo.');return;} history.redoStack.push(JSON.stringify(dungeon)); replaceDungeon(JSON.parse(history.undoStack.pop())); render(); updateFloorTabs(); updateStatus('Undo'); }
function redo(){ if(!history.redoStack.length){updateStatus('Nothing to redo.');return;} history.undoStack.push(JSON.stringify(dungeon)); replaceDungeon(JSON.parse(history.redoStack.pop())); render(); updateFloorTabs(); updateStatus('Redo'); }
function replaceDungeon(d){ for(const k in dungeon) delete dungeon[k]; for(const k in d) dungeon[k]=d[k]; }

// â”€â”€ VALIDATE / EXPORT / IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function validateDungeon(){
    const errs=[];
    for(const f in dungeon.floors){
        const fl=dungeon.floors[f]; if(!fl.startRoom) errs.push('Floor '+f+': no startRoom');
        for(const rid in fl.rooms){ const r=fl.rooms[rid]; for(const d in r.exits){ const t=r.exits[d]; if(!fl.rooms[t]) errs.push('F'+f+' '+rid+': exit '+d+' â†’ missing '+t); } }
    }
    if(errs.length){ updateStatus('âš  '+errs[0]); alert('Validation Errors:\n'+errs.join('\n')); }
    else updateStatus('âœ“ Validation passed!');
    return !errs.length;
}

function exportDungeon(){
    dungeon.name       =document.getElementById('dungeonName').value||'NewDungeon';
    dungeon.description=document.getElementById('dungeonDesc').value||'';
    validateDungeon();
    const clean=JSON.parse(JSON.stringify(dungeon));
    const key=dungeon.name.replace(/\s+/g,'');
    const txt=`window.DUNGEONS = window.DUNGEONS || {};\nwindow.DUNGEONS.${key} = ${JSON.stringify(clean,null,2)};`;
    const blob=new Blob([txt],{type:'text/javascript'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=key+'.js'; a.click(); URL.revokeObjectURL(url);
    markClean(); updateStatus('Exported '+key+'.js');
}

function importDungeon(){
    const inp=document.createElement('input'); inp.type='file'; inp.accept='.js,.json';
    inp.onchange=e=>{
        const f=e.target.files[0]; if(!f) return;
        const reader=new FileReader();
        reader.onload=ev=>{
            let text=ev.target.result;
            try {
                if(text.includes('window.DUNGEONS')){ const m=text.match(/=\s*(\{[\s\S]*\});?\s*$/); if(m) text=m[1]; }
                const data=JSON.parse(text);
                let maxR=0;
                for(const fl in data.floors) for(const id in data.floors[fl].rooms){ const n=parseInt(id.replace('R','')); if(!isNaN(n)&&n>maxR) maxR=n; }
                roomCounter=maxR;
                replaceDungeon(data);
                document.getElementById('dungeonName').value=dungeon.name||'';
                document.getElementById('dungeonDesc').value=dungeon.description||'';
                editorState.activeFloor=parseInt(Object.keys(dungeon.floors)[0])||1;
                editorState.selectedRoomId=null;
                document.getElementById('inspectorSection').style.display='none';
                updateFloorTabs(); render(); markClean(); updateStatus('Dungeon imported.');
            } catch(err){ alert('Import failed: '+err.message); console.error(err); }
        };
        reader.readAsText(f);
    };
    inp.click();
}

// â”€â”€ SIMULATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('terminalInput').addEventListener('keydown',function(e){
    if(e.key!=='Enter'||!simulator.active) return;
    const inp=this.value.trim().toLowerCase(); this.value=''; handleSimCmd(inp);
});

function termPrint(html,color){
    const out=document.getElementById('terminalOutput');
    const d=document.createElement('div'); d.innerHTML=html;
    if(color) d.style.color=color; out.appendChild(d); out.scrollTop=out.scrollHeight;
}
function termClear(){ document.getElementById('terminalOutput').innerHTML=''; }
function updateSimHp(){ document.getElementById('simHpLbl').textContent=`HP: ${simulator.hp}/${simulator.maxHp}`; }

function startSimulation(){
    const floor=dungeon.floors[editorState.activeFloor];
    if(!floor?.startRoom){alert('No start room set.');return;}
    simulator.active=true; simulator.floor=editorState.activeFloor;
    simulator.roomId=floor.startRoom; simulator.keys=[]; simulator.hp=simulator.maxHp;
    simulator.inventory=[];
    simulator.leverRoom=null;
    simulator.pickedUpLoot=new Set();
    document.getElementById('simulatorPanel').style.display='flex';
    termClear();
    termPrint('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','var(--accent)');
    termPrint('  DUNGEON SIMULATION','var(--accent)');
    termPrint('  n/s/e/w/ne/nw/se/sw  move','var(--dim)');
    termPrint('  u / d               ladder','var(--dim)');
    termPrint('  pick [item_key]     pick up item','var(--dim)');
    termPrint('  inv                 show inventory','var(--dim)');
    termPrint('  pull lever          activate lever trigger','var(--dim)');
    termPrint('  deposit [item]      place item on pedestal','var(--dim)');
    termPrint('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','var(--accent)');
    updateSimHp(); document.getElementById('simFloorLbl').textContent='Floor '+simulator.floor;
    enterSimRoom();
}
function stopSimulation(){ simulator.active=false; document.getElementById('simulatorPanel').style.display='none'; }

function enterSimRoom(){
    const room=dungeon.floors[simulator.floor]?.rooms?.[simulator.roomId];
    if(!room){termPrint('ERROR: Room not found!','var(--red)');return;}

    termPrint('');
    termPrint(`<strong style="color:var(--accent)">[ ${simulator.roomId} ]</strong> ${room.name||'(Unnamed)'}`);
    if(room.description) termPrint(room.description,'var(--dim)');

    // Enemies
    (room.contents?.enemies||[]).forEach(e=>{
        const key    = typeof e==='string' ? e : e.key;
        const drop   = typeof e==='string' ? null : e.drop;
        const rarity = typeof e==='string' ? 'common' : (e.rarity || 'common');
        const enemyList = getEnemyList();
        const name   = (enemyList && enemyList[key]) ? enemyList[key].name : key;
        const rarCfg = RARITY_OPTIONS.find(o => o.value === rarity) || RARITY_OPTIONS[0];
        let line = `ğŸ‘¹ <span style="color:${rarCfg.color}">[${rarCfg.label}] ${name}</span>`;
        if(drop) line += ` <span style="color:var(--gold)"> [drops: ${DROP_ITEMS[drop]||drop}]</span>`;
        termPrint(line);
    });

    // Traps
    (room.contents?.traps||[]).forEach(trap=>{
        const cfg=TRAP_CONFIG[trap.type]||{icon:'?',name:trap.type,color:'#e88',desc:''};
        if(!trap.triggered||trap.resetOnLeave){
            termPrint(`${cfg.icon} <span style="color:${cfg.color}">TRAP: ${cfg.name}</span>`);
            if(trap.damage>0){
                simulator.hp=Math.max(0,simulator.hp-trap.damage);
                termPrint(`  âš  You take <span style="color:var(--red)">${trap.damage} damage</span>!`);
                if(cfg.dotDuration>0) termPrint(`  â˜  Effect lasts ${trap.duration||cfg.dotDuration}s...`,cfg.color);
                trap.triggered=true; updateSimHp();
            }
            if(trap.type==='alarm') termPrint('  ğŸ”” ALARM TRIGGERED â€” Monsters alerted!','#dfe6e9');
            if(trap.type==='web')   termPrint('  ğŸ•¸ You are slowed (2 rounds)!','#b2bec3');
            if(trap.type==='curse') termPrint('  ğŸŒ€ You feel a dark curse!','#a855f7');
            if(!trap.damage&&trap.type!=='alarm'&&trap.type!=='web'&&trap.type!=='curse')
                termPrint(`  Effect: ${cfg.desc}`,'var(--dim)');
        }
    });

    if(simulator.hp<=0){
        termPrint(''); termPrint('ğŸ’€ YOU HAVE DIED.','var(--red)');
        simulator.hp=simulator.maxHp; updateSimHp();
        simulator.roomId=dungeon.floors[simulator.floor].startRoom;
        termPrint('Respawning at start room...','var(--dim)');
        enterSimRoom(); return;
    }

    // Doors
    const doors=room.contents?.doors||{};
    for(const dir in doors){
        const d=doors[dir]; const cfg=DOOR_TYPES[d.type];
        termPrint(`ğŸ”’ ${dir.toUpperCase()}: <span style="color:${cfg?.color||'#aaa'}">${cfg?.label||d.type}</span> door locked`);
    }

    // Ladder
    if(room.contents?.ladder){
        const lad=room.contents.ladder;
        const ico=lad.direction==='up'?'â¬†':'â¬‡';
        termPrint(`ğŸªœ Ladder ${ico} â†’ Floor ${lad.leadsTo.floor} (${lad.leadsTo.room})`,'#e8b84a');
    }

    // Town exit
    if(room.flags?.townExit){
        const lbl=room.flags.townExitLabel||'Exit to '+room.flags.townExit;
        termPrint(`ğŸŒ€ <span style="color:#a855f7">${lbl}</span>`);
    }

    // â”€â”€ GROUND LOOT AUTO-PICKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const lootTable = room.contents?.lootTable;
    if (lootTable && lootTable.length) {
        const roomKey = simulator.floor + ':' + simulator.roomId;
        if (!simulator.pickedUpLoot) simulator.pickedUpLoot = new Set();
        lootTable.forEach(itemKey => {
            const lootId = roomKey + ':' + itemKey;
            if (!simulator.pickedUpLoot.has(lootId)) {
                simulator.pickedUpLoot.add(lootId);
                if (!simulator.inventory) simulator.inventory = [];
                simulator.inventory.push(itemKey);
                const idata = (typeof ITEMS!=='undefined'&&ITEMS[itemKey]);
                const iname = idata ? ((idata.icon||'ğŸ“¦')+' '+idata.name) : itemKey;
                termPrint(`âœ¨ Found on the ground: <span style="color:#fde68a">${iname}</span> â€” added to inventory!`, '#fde68a');
            }
        });
    }

    // â”€â”€ TELEPORT TRIGGER CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const staffTrigger = room.contents?.staffTrigger;
    if (staffTrigger?.enabled) {
        const trigType = staffTrigger.triggerType || 'staff_pieces';
        const FLASH_COLORS = {white:'255,255,255', purple:'168,85,247', gold:'232,184,74', red:'232,74,74', blue:'74,142,232', green:'0,200,150'};
        const flashRGB = FLASH_COLORS[staffTrigger.flashColor||'white'] || '255,255,255';
        const flashHex = {white:'#ffffff',purple:'#a855f7',gold:'#e8b84a',red:'#e84a4a',blue:'#4a8ee8',green:'#00c896'}[staffTrigger.flashColor||'white']||'#ffffff';

        function doTeleport(msg1, msg2) {
            termPrint('');
            termPrint('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', flashHex);
            termPrint('  ' + msg1, '#ffffff');
            termPrint('  ' + msg2, flashHex);
            termPrint('  You are TELEPORTED...', flashHex);
            termPrint('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', flashHex);
            simFlash(flashRGB);
            setTimeout(() => {
                simulator.floor  = staffTrigger.targetFloor;
                simulator.roomId = staffTrigger.targetRoom;
                document.getElementById('simFloorLbl').textContent = 'Floor ' + simulator.floor;
                enterSimRoom();
            }, 900);
        }

        if (trigType === 'staff_pieces') {
            const STAFF_PIECES = ['staff_piece_1','staff_piece_2','staff_piece_3','staff_piece_4','staff_piece_5','staff_piece_6','staff_piece_7','staff_piece_8'];
            const hasAll = STAFF_PIECES.every(p => (simulator.inventory||[]).includes(p));
            if (hasAll) {
                STAFF_PIECES.forEach(p => { const i=(simulator.inventory||[]).indexOf(p); if(i!==-1) simulator.inventory.splice(i,1); });
                doTeleport('âš¡ THE STAFF PIECES RESONATE! âš¡','The staff is consumed in a blinding flash!');
                return;
            } else {
                const missing = STAFF_PIECES.filter(p => !(simulator.inventory||[]).includes(p));
                termPrint(`ğŸª„ <span style="color:${flashHex}">Staff Pedestal</span> â€” ${missing.length} piece${missing.length!==1?'s':''} still missing...`, flashHex);
            }
        } else if (trigType === 'enter_room') {
            doTeleport('âš¡ A MAGICAL PORTAL ACTIVATES!', 'The room pulls you through...');
            return;
        } else if (trigType === 'enemies_cleared') {
            const hasEnemies = (room.contents?.enemies||[]).length > 0;
            if (!hasEnemies) {
                doTeleport('âš” ALL ENEMIES DEFEATED!', 'Victory opens the portal!');
                return;
            } else {
                termPrint(`ğŸŒ€ <span style="color:${flashHex}">Portal sealed</span> â€” defeat all enemies to activate.`, flashHex);
            }
        } else if (trigType === 'full_health') {
            if (simulator.hp >= simulator.maxHp) {
                doTeleport('â¤ PURE SOUL DETECTED!', 'The portal responds to your wholeness!');
                return;
            } else {
                termPrint(`ğŸŒ€ <span style="color:${flashHex}">Portal requires full health</span> â€” heal before entering again.`, flashHex);
            }
        } else if (trigType === 'no_keys') {
            if (!simulator.keys.length) {
                doTeleport('ğŸ— EMPTY HANDS DETECTED!', 'The keyless soul may pass!');
                return;
            } else {
                termPrint(`ğŸŒ€ <span style="color:${flashHex}">Portal sealed</span> â€” drop all keys first.`, flashHex);
            }
        } else if (trigType === 'lever') {
            termPrint(`ğŸ•¹ï¸ <span style="color:${flashHex}">You see a lever on the wall.</span> Type <strong>pull lever</strong> to activate.`, flashHex);
            simulator.leverRoom = simulator.floor + ':' + simulator.roomId;
        } else if (trigType === 'item_deposited') {
            const reqItem = staffTrigger.depositItem;
            termPrint(`ğŸ“¦ <span style="color:${flashHex}">Deposit pedestal:</span> Type <strong>deposit ${reqItem||'[item]'}</strong> to activate.`, flashHex);
        }
    }

    // Keys
    if(simulator.keys.length) termPrint(`ğŸ— Keys held: ${simulator.keys.join(', ')}`,'#e8b84a');
    if(simulator.inventory?.length) {
        const items = simulator.inventory.map(k => {
            if (typeof ITEMS !== 'undefined' && ITEMS[k]) return (ITEMS[k].icon||'ğŸ“¦') + ' ' + ITEMS[k].name;
            return k;
        });
        termPrint(`ğŸ’ Inventory: ${items.join(', ')}`, '#7dd3fc');
    }

    // Exits
    let exits=Object.keys(room.exits||[]);
    if(room.contents?.ladder) exits.push(room.contents.ladder.direction==='up'?'u':'d');
    termPrint(`Exits: <strong>${exits.length?exits.join(', '):'none'}</strong>`,'var(--dim)');
    document.getElementById('simFloorLbl').textContent='Floor '+simulator.floor;
}

function handleSimCmd(cmd){
    const room=dungeon.floors[simulator.floor]?.rooms?.[simulator.roomId]; if(!room) return;

    // pick command
    if(cmd.startsWith('pick')){
        const item=cmd.split(' ').slice(1).join('_');
        if(!item){termPrint('pick what? e.g. "pick iron_key" or "pick staff_piece_1"','var(--dim)');return;}
        // Check room drops from enemies
        let found=false;
        for(const e of (room.contents?.enemies||[])){
            const drop=typeof e==='string'?null:e.drop;
            if(drop&&(drop===item||drop===item+'_key')){
                const isKey = drop.endsWith('_key') || DROP_ITEMS[drop];
                if (isKey) {
                    if(!simulator.keys.includes(drop)){
                        simulator.keys.push(drop);
                        termPrint(`ğŸ— Picked up <span style="color:var(--gold)">${DROP_ITEMS[drop]||drop}</span>!`);
                    } else termPrint('You already have that.','var(--dim)');
                } else {
                    if (!simulator.inventory) simulator.inventory = [];
                    if (!simulator.inventory.includes(drop)) {
                        simulator.inventory.push(drop);
                        const iname = (typeof ITEMS!=='undefined'&&ITEMS[drop]) ? ((ITEMS[drop].icon||'ğŸ“¦')+' '+ITEMS[drop].name) : drop;
                        termPrint(`ğŸ“¦ Picked up <span style="color:#7dd3fc">${iname}</span>!`);
                    } else termPrint('You already have that.','var(--dim)');
                }
                found=true; break;
            }
        }
        // Also allow picking up staff pieces from room's static drops if configured
        if(!found && room.contents?.lootTable?.includes(item)){
            if(!simulator.inventory) simulator.inventory=[];
            if(!simulator.inventory.includes(item)){
                simulator.inventory.push(item);
                const iname=(typeof ITEMS!=='undefined'&&ITEMS[item])?((ITEMS[item].icon||'ğŸ“¦')+' '+ITEMS[item].name):item;
                termPrint(`ğŸ“¦ Picked up <span style="color:#7dd3fc">${iname}</span>!`);
            } else termPrint('You already have that.','var(--dim)');
            found=true;
        }
        if(!found) termPrint(`No "${item}" here to pick up.`,'var(--dim)');
        return;
    }

    // inv command
    if(cmd==='inv'||cmd==='inventory'){
        const keys = simulator.keys.length ? 'ğŸ— Keys: ' + simulator.keys.join(', ') : '';
        const items = (simulator.inventory||[]).map(k => {
            return (typeof ITEMS!=='undefined'&&ITEMS[k]) ? (ITEMS[k].icon||'ğŸ“¦')+' '+ITEMS[k].name : k;
        });
        const inv = items.length ? 'ğŸ’ Items: ' + items.join(', ') : '';
        if(!keys&&!inv) termPrint('Inventory is empty.','var(--dim)');
        else { if(keys) termPrint(keys,'#e8b84a'); if(inv) termPrint(inv,'#7dd3fc'); }
        return;
    }

    // pull lever
    if(cmd==='pull lever'||cmd==='pull'||cmd==='lever'){
        const st = room.contents?.staffTrigger;
        const leverKey = simulator.floor + ':' + simulator.roomId;
        if (st?.enabled && st?.triggerType === 'lever' && simulator.leverRoom === leverKey) {
            const FLASH_COLORS = {white:'255,255,255',purple:'168,85,247',gold:'232,184,74',red:'232,74,74',blue:'74,142,232',green:'0,200,150'};
            const flashRGB = FLASH_COLORS[st.flashColor||'white'] || '255,255,255';
            const flashHex = {white:'#ffffff',purple:'#a855f7',gold:'#e8b84a',red:'#e84a4a',blue:'#4a8ee8',green:'#00c896'}[st.flashColor||'white']||'#ffffff';
            termPrint('ğŸ•¹ï¸ You pull the lever with both hands...', flashHex);
            termPrint('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', flashHex);
            termPrint('  âš¡ THE LEVER CLICKS INTO PLACE!', '#ffffff');
            termPrint('  A brilliant flash erupts!', flashHex);
            termPrint('  You are TELEPORTED...', flashHex);
            termPrint('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', flashHex);
            simFlash(flashRGB);
            setTimeout(() => {
                simulator.floor  = st.targetFloor;
                simulator.roomId = st.targetRoom;
                simulator.leverRoom = null;
                document.getElementById('simFloorLbl').textContent = 'Floor ' + simulator.floor;
                enterSimRoom();
            }, 900);
        } else {
            termPrint('There is no lever here to pull.', 'var(--dim)');
        }
        return;
    }

    // deposit [item]
    if(cmd.startsWith('deposit ')){
        const itemKey = cmd.slice(8).trim().replace(/ /g,'_');
        const st = room.contents?.staffTrigger;
        if (st?.enabled && st?.triggerType === 'item_deposited') {
            const req = st.depositItem;
            if (!req) { termPrint('No item required by this pedestal.', 'var(--dim)'); return; }
            if (itemKey !== req && itemKey !== req.replace(/_/g,' ')) {
                termPrint(`The pedestal requires: ${req}`, '#e84a4a'); return;
            }
            const invIdx = (simulator.inventory||[]).indexOf(req);
            if (invIdx === -1) { termPrint(`You don't have ${req}.`, '#e84a4a'); return; }
            simulator.inventory.splice(invIdx, 1);
            const FLASH_COLORS = {white:'255,255,255',purple:'168,85,247',gold:'232,184,74',red:'232,74,74',blue:'74,142,232',green:'0,200,150'};
            const flashRGB = FLASH_COLORS[st.flashColor||'white'] || '255,255,255';
            const flashHex = {white:'#ffffff',purple:'#a855f7',gold:'#e8b84a',red:'#e84a4a',blue:'#4a8ee8',green:'#00c896'}[st.flashColor||'white']||'#ffffff';
            termPrint(`ğŸ“¦ You place ${req} on the pedestal...`, flashHex);
            termPrint('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', flashHex);
            termPrint('  âœ¨ THE PEDESTAL GLOWS!', '#ffffff');
            termPrint('  You are TELEPORTED...', flashHex);
            termPrint('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', flashHex);
            simFlash(flashRGB);
            setTimeout(() => {
                simulator.floor  = st.targetFloor;
                simulator.roomId = st.targetRoom;
                document.getElementById('simFloorLbl').textContent = 'Floor ' + simulator.floor;
                enterSimRoom();
            }, 900);
        } else {
            termPrint('There is no deposit pedestal here.', 'var(--dim)');
        }
        return;
    }

    // Ladder (u/d)
    if(cmd==='u'||cmd==='up'||cmd==='d'||cmd==='down'){
        const dir=(cmd==='u'||cmd==='up')?'up':'down';
        if(!room.contents?.ladder){termPrint('No ladder here.','var(--dim)');return;}
        if(room.contents.ladder.direction!==dir){termPrint('Ladder goes '+room.contents.ladder.direction+'.','var(--dim)');return;}
        rearmTraps(room);
        const lad=room.contents.ladder;
        simulator.floor=parseInt(lad.leadsTo.floor); simulator.roomId=lad.leadsTo.room;
        termPrint(`ğŸªœ You ${dir==='up'?'climb up':'descend'} the ladder...`,'#e8b84a');
        enterSimRoom(); return;
    }

    // Directional
    const target=room.exits?.[cmd];
    if(target){
        const door=room.contents?.doors?.[cmd];
        if(door?.locked){
            const haveKey=simulator.keys.includes(door.type+'_key')||simulator.keys.includes(door.type);
            if(!haveKey){const cfg=DOOR_TYPES[door.type]; termPrint(`ğŸ”’ ${cfg?.label||door.type} door is locked.`,'var(--red)');return;}
            termPrint(`ğŸ”“ Unlocked with ${door.type} key.`,'#e8b84a');
        }
        rearmTraps(room);
        simulator.roomId=target; enterSimRoom(); return;
    }

    termPrint(`No exit "${cmd}".`,'var(--dim)');
}

function rearmTraps(room){ (room.contents?.traps||[]).forEach(t=>{ if(t.resetOnLeave) t.triggered=false; }); }

function simFlash(rgb) {
    const col = rgb || '255,255,255';
    const overlay = document.createElement('div');
    overlay.style.cssText = [
        'position:fixed','inset:0','z-index:99999',
        'background:rgb(' + col + ')','opacity:0',
        'pointer-events:none','transition:opacity 0.15s ease-in'
    ].join(';');
    document.body.appendChild(overlay);
    // Ramp up
    requestAnimationFrame(() => {
        overlay.style.opacity = '1';
        setTimeout(() => {
            overlay.style.transition = 'opacity 0.7s ease-out';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 800);
        }, 180);
    });
}

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',function(e){
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
    if(e.ctrlKey&&e.key==='z'){e.preventDefault();undo();return;}
    if(e.ctrlKey&&e.key==='y'){e.preventDefault();redo();return;}
    if(e.ctrlKey&&e.key==='s'){e.preventDefault();exportDungeon();return;}
    if(e.key==='Escape'){editorState.connectBuffer=[];render();updateStatus('Cancelled.');}
    if(!e.ctrlKey&&!e.altKey&&!e.shiftKey){
        if(e.key==='a') setMode('add');
        if(e.key==='c') setMode('connect');
        if(e.key==='e') setMode('edit');
    }
});

window.addEventListener('beforeunload',function(e){
    if(!hasUnsaved) return; e.preventDefault(); e.returnValue='';
});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init(){
    populateEnemyDropdown(); // has built-in retry if ENEMIES not ready yet
    populateLadderFloors();
    document.getElementById('ladderFloor').addEventListener('change',populateLadderRooms);
    updateFloorTabs();
    setMode('add');
    render();
})();
</script>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- ENEMY EDITOR OVERLAY                                          -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="enemyEditorOverlay">
  <div id="enemyEditorModal">
    <div id="eeHeader">
      <h2>ğŸ‘¹ Enemy Database Editor</h2>
      <span id="eeHeaderSub" style="font-size:11px;color:var(--dim);"></span>
      <button class="btn-g" onclick="eeNewEnemy()" style="border-color:var(--accent);color:var(--accent);">+ New Enemy</button>
      <button onclick="eeClose()" style="border-color:var(--red);color:var(--red);margin-left:6px;">âœ• Close</button>
    </div>
    <div id="eeBody">
      <!-- LEFT: LIST -->
      <div id="eeList">
        <div id="eeListSearch">
          <input id="eeSearch" type="text" placeholder="ğŸ” Search by name or level (e.g. &quot;1&quot;)..." oninput="eeFilterList()">
          <select id="eeDropdown" onchange="eeDropdownSelect()" style="margin-top:6px;width:100%;background:#0a0e11;border:1px solid var(--border);color:var(--text);padding:5px 8px;font-family:'Courier New',monospace;font-size:12px;border-radius:3px;outline:none;cursor:pointer;" title="All matching enemies â€” click to select">
            <option value="">â€” select enemy â€”</option>
          </select>
        </div>
        <div id="eeListItems"></div>
        <div id="eeListActions">
          <button class="btn-d" onclick="eeDeleteCurrent()" style="width:100%;">Ã— Delete Selected Enemy</button>
        </div>
      </div>
      <!-- RIGHT: FORM -->
      <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
        <div id="eeForm">
          <div id="eeFormPlaceholder">â† Select an enemy to edit, or click <strong style="color:var(--accent)">+ New Enemy</strong></div>
          <div id="eeFormFields" style="display:none;flex-direction:column;gap:10px;">
            <div class="ee-section-title">ğŸ”‘ Identity</div>
            <div class="ee-form-grid">
              <div class="ee-field">
                <label>Key (unique ID) <span style="color:var(--red)">*</span></label>
                <input id="ee_key" type="text" placeholder="e.g. fire_goblin">
              </div>
              <div class="ee-field">
                <label>Name <span style="color:var(--red)">*</span></label>
                <input id="ee_name" type="text" placeholder="e.g. Fire Goblin">
              </div>
            </div>
            <div class="ee-field">
              <label>Description</label>
              <textarea id="ee_description" rows="2" placeholder="What the player sees when they encounter this enemy..."></textarea>
            </div>

            <div class="ee-section-title">âš” Core Stats</div>
            <div class="ee-form-grid three">
              <div class="ee-field"><label>Level</label><input id="ee_level" type="number" min="1" max="100" placeholder="1"></div>
              <div class="ee-field"><label>Base HP</label><input id="ee_baseHp" type="number" min="1" placeholder="30"></div>
              <div class="ee-field"><label>Base Defense</label><input id="ee_baseDefense" type="number" min="0" placeholder="3"></div>
            </div>
            <div class="ee-form-grid three">
              <div class="ee-field"><label>Base Damage</label><input id="ee_baseDamage" type="number" min="0" placeholder="8"></div>
              <div class="ee-field"><label>Min Damage</label><input id="ee_minDamage" type="number" min="0" placeholder="5"></div>
              <div class="ee-field"><label>Max Damage</label><input id="ee_maxDamage" type="number" min="0" placeholder="10"></div>
            </div>
            <div class="ee-form-grid">
              <div class="ee-field"><label>Base XP</label><input id="ee_baseXp" type="number" min="0" placeholder="20"></div>
              <div class="ee-field"><label>Base Gold</label><input id="ee_baseGold" type="number" min="0" placeholder="15"></div>
            </div>

            <div class="ee-section-title">ğŸ² Drop Rates (0.0â€“1.0)</div>
            <div class="ee-form-grid" style="grid-template-columns:1fr 1fr 1fr 1fr;">
              <div class="ee-field"><label>Common</label><input id="ee_drop_common" type="number" step="0.01" min="0" max="1" placeholder="0.40"></div>
              <div class="ee-field"><label>Uncommon</label><input id="ee_drop_uncommon" type="number" step="0.01" min="0" max="1" placeholder="0.20"></div>
              <div class="ee-field"><label>Rare</label><input id="ee_drop_rare" type="number" step="0.01" min="0" max="1" placeholder="0.05"></div>
              <div class="ee-field"><label>Epic</label><input id="ee_drop_epic" type="number" step="0.01" min="0" max="1" placeholder="0.01"></div>
            </div>

            <div class="ee-section-title" style="display:flex;align-items:center;justify-content:space-between;">
              <span>ğŸ“¦ Possible Drops</span>
              <button onclick="openItemEditor()" style="font-size:10px;padding:2px 8px;border-color:var(--gold);color:var(--gold);background:rgba(232,184,74,.08);">âš™ Add/Edit Items</button>
            </div>
            <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;">
              <select id="ee_itemPickerDrop" style="flex:1;background:#0a0e11;border:1px solid var(--border);color:var(--text);padding:5px 8px;font-family:'Courier New',monospace;font-size:12px;border-radius:3px;outline:none;">
                <option value="">â€” pick item to add â€”</option>
              </select>
              <button onclick="eeAddDropItem()" style="padding:4px 10px;border-color:var(--accent);color:var(--accent);background:rgba(0,200,150,.08);white-space:nowrap;">+ Add</button>
            </div>
            <div id="ee_dropsChips" style="display:flex;flex-wrap:wrap;gap:5px;min-height:28px;padding:4px;background:#0a0e11;border:1px solid var(--border);border-radius:3px;"></div>
            <input type="hidden" id="ee_possibleDrops">

            <div class="ee-section-title">âš™ Extra Properties <span style="color:var(--dim);font-size:10px;font-style:normal;">(optional JSON fields)</span></div>
            <div class="ee-field">
              <label>Raw JSON extras (merged on save â€” advanced users)</label>
              <textarea id="ee_extras" rows="3" placeholder='e.g. {"aggressive": true, "speed": 1.2, "immunities": ["poison"]}'></textarea>
            </div>
          </div>
        </div>
        <div id="eeFormActions" style="display:none;">
          <button class="btn-a" onclick="eeSaveCurrent()">ğŸ’¾ Save Enemy</button>
          <button onclick="eeRevertCurrent()" title="Undo unsaved changes">â†© Revert</button>
          <button onclick="eeDownloadJS()" style="border-color:var(--orange);color:var(--orange);background:rgba(232,135,74,.08);">â¬‡ Download Enemies JS</button>
          <button onclick="eeCopyToClipboard()" style="border-color:var(--purple);color:var(--purple);background:rgba(168,85,247,.08);">ğŸ“‹ Copy JS</button>
          <span id="eeStatus"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- ITEM EDITOR SUB-MODAL                                          -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<style>
#itemEditorOverlay {
    display:none; position:fixed; inset:0; z-index:10000;
    background:rgba(0,0,0,0.72); backdrop-filter:blur(2px);
    align-items:center; justify-content:center;
}
#itemEditorOverlay.open { display:flex; }
#itemEditorModal {
    background:#13161a; border:2px solid var(--gold);
    border-radius:8px; width:88vw; max-width:940px;
    height:82vh; display:flex; flex-direction:column;
    box-shadow:0 0 50px rgba(232,184,74,0.3); overflow:hidden;
    position:relative;
}
#itemEditorModal::before {
    content:''; position:absolute; inset:0; pointer-events:none;
    border-radius:6px; box-shadow:inset 0 0 0 3px rgba(232,184,74,0.08);
}
#ieHeader {
    background:#100f08; border-bottom:2px solid var(--gold);
    padding:9px 14px; display:flex; align-items:center; gap:8px; flex-shrink:0;
}
#ieHeader h2 { font-size:13px; color:var(--gold); letter-spacing:2px; text-transform:uppercase; flex:1; }
#ieBody { display:flex; flex:1; overflow:hidden; }
#ieList {
    width:250px; min-width:250px; border-right:1px solid var(--border);
    display:flex; flex-direction:column; overflow:hidden;
}
#ieListSearch { padding:7px; border-bottom:1px solid var(--border); flex-shrink:0; }
#ieListSearch input {
    width:100%; background:#0a0e11; border:1px solid var(--border);
    color:var(--text); padding:4px 7px; font-family:'Courier New',monospace;
    font-size:12px; border-radius:3px; outline:none;
}
#ieListSearch input:focus { border-color:var(--gold); }
#ieListSearch select {
    margin-top:5px; width:100%; background:#0a0e11; border:1px solid var(--border);
    color:var(--text); padding:4px 7px; font-family:'Courier New',monospace;
    font-size:12px; border-radius:3px; outline:none; cursor:pointer;
}
#ieListItems { flex:1; overflow-y:auto; }
#ieListItems::-webkit-scrollbar { width:5px; }
#ieListItems::-webkit-scrollbar-thumb { background:#333; border-radius:3px; }
.ie-list-item {
    padding:7px 11px; cursor:pointer; border-bottom:1px solid #1a1f24;
    display:flex; flex-direction:column; gap:2px; transition:background 0.1s;
}
.ie-list-item:hover { background:#1a1f24; }
.ie-list-item.active { background:rgba(232,184,74,.13); border-left:3px solid var(--gold); }
.ie-list-item .ie-item-name { font-size:12px; color:var(--bright); }
.ie-list-item .ie-item-sub { font-size:10px; color:var(--dim); }
#ieListActions { padding:7px; border-top:1px solid var(--border); flex-shrink:0; }
#ieForm { flex:1; overflow-y:auto; padding:14px; display:flex; flex-direction:column; gap:9px; }
#ieForm::-webkit-scrollbar { width:5px; }
#ieForm::-webkit-scrollbar-thumb { background:#333; border-radius:3px; }
#ieFormPlaceholder { color:var(--dim); font-size:13px; margin:auto; text-align:center; }
.ie-form-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.ie-form-grid.three { grid-template-columns:1fr 1fr 1fr; }
.ie-field label { display:block; font-size:10px; color:var(--dim); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:3px; }
.ie-field input, .ie-field textarea, .ie-field select {
    width:100%; background:#0a0e11; border:1px solid var(--border);
    color:var(--text); padding:5px 7px; font-family:'Courier New',monospace;
    font-size:12px; border-radius:3px; outline:none;
}
.ie-field input:focus, .ie-field textarea:focus, .ie-field select:focus { border-color:var(--gold); }
.ie-section-title {
    font-size:11px; color:var(--gold); text-transform:uppercase;
    letter-spacing:1px; border-bottom:1px solid #2a2210; padding-bottom:4px; margin-top:4px;
}
#ieFormActions {
    display:flex; gap:7px; padding:10px 14px; border-top:1px solid var(--border);
    flex-shrink:0; background:#100f08; flex-wrap:wrap;
}
#ieStatus { font-size:11px; color:var(--dim); margin-left:auto; align-self:center; }
/* Drop chip styles */
.drop-chip {
    display:inline-flex; align-items:center; gap:4px;
    background:#1a2228; border:1px solid var(--border);
    border-radius:12px; padding:3px 8px 3px 10px;
    font-size:11px; color:var(--text); cursor:default;
}
.drop-chip .chip-remove {
    cursor:pointer; color:var(--red); font-size:13px; line-height:1;
    padding:0 1px; border:none; background:none; font-family:inherit;
}
.drop-chip .chip-remove:hover { color:#ff8888; }
</style>

<div id="itemEditorOverlay">
  <div id="itemEditorModal">
    <div id="ieHeader">
      <h2>ğŸ“¦ Item Database Editor</h2>
      <span id="ieHeaderSub" style="font-size:11px;color:var(--dim);"></span>
      <button onclick="ieNewItem()" style="border-color:var(--accent);color:var(--accent);font-size:11px;padding:3px 9px;">+ New Item</button>
      <button onclick="ieClose()" style="border-color:var(--red);color:var(--red);font-size:11px;padding:3px 9px;margin-left:4px;">âœ• Close</button>
    </div>
    <div id="ieBody">
      <!-- LEFT LIST -->
      <div id="ieList">
        <div id="ieListSearch">
          <input id="ieSearch" type="text" placeholder="ğŸ” Search items..." oninput="ieFilterList()">
          <select id="ieDropdown" onchange="ieDropdownSelect()">
            <option value="">â€” select item â€”</option>
          </select>
        </div>
        <div id="ieListItems"></div>
        <div id="ieListActions">
          <button class="btn-d" onclick="ieDeleteCurrent()" style="width:100%;font-size:11px;">Ã— Delete Selected Item</button>
        </div>
      </div>
      <!-- RIGHT FORM -->
      <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
        <div id="ieForm">
          <div id="ieFormPlaceholder">â† Select an item to edit, or click <strong style="color:var(--accent)">+ New Item</strong></div>
          <div id="ieFormFields" style="display:none;flex-direction:column;gap:9px;">
            <div class="ie-section-title">ğŸ”‘ Identity</div>
            <div class="ie-form-grid">
              <div class="ie-field"><label>Key (unique ID) <span style="color:var(--red)">*</span></label><input id="ie_key" type="text" placeholder="e.g. fire_scroll"></div>
              <div class="ie-field"><label>Name <span style="color:var(--red)">*</span></label><input id="ie_name" type="text" placeholder="e.g. Fire Scroll"></div>
            </div>
            <div class="ie-form-grid">
              <div class="ie-field">
                <label>Subtype</label>
                <select id="ie_subtype">
                  <option value="heal_hp">heal_hp â€” Heals HP</option>
                  <option value="heal_mp">heal_mp â€” Heals MP</option>
                  <option value="full_restore">full_restore â€” Full HP/MP</option>
                  <option value="buff_xp">buff_xp â€” XP Boost</option>
                  <option value="buff_gold">buff_gold â€” Gold Boost</option>
                  <option value="buff_str">buff_str â€” Strength Buff</option>
                  <option value="buff_def">buff_def â€” Defense Buff</option>
                  <option value="buff_speed">buff_speed â€” Speed Buff</option>
                  <option value="buff_crit">buff_crit â€” Crit Buff</option>
                  <option value="buff_magic">buff_magic â€” Magic Buff</option>
                  <option value="buff_damage">buff_damage â€” Damage Buff</option>
                  <option value="buff_invuln">buff_invuln â€” Damage Reduction</option>
                  <option value="buff_luck">buff_luck â€” Luck Buff</option>
                  <option value="buff_regen">buff_regen â€” HP Regen</option>
                  <option value="dungeon_key">dungeon_key â€” Door Key</option>
                  <option value="material">material â€” Crafting Material</option>
                  <option value="quest">quest â€” Quest Item</option>
                  <option value="recall">recall â€” Recall / Teleport</option>
                  <option value="misc">misc â€” Miscellaneous</option>
                </select>
              </div>
              <div class="ie-field"><label>Icon (emoji)</label><input id="ie_icon" type="text" placeholder="ğŸ§ª" maxlength="4"></div>
            </div>
            <div class="ie-field"><label>Description</label><textarea id="ie_description" rows="2" placeholder="What the player sees..."></textarea></div>

            <div class="ie-section-title">ğŸ’° Economy</div>
            <div class="ie-form-grid three">
              <div class="ie-field"><label>Cost (buy price)</label><input id="ie_cost" type="number" min="0" placeholder="50"></div>
              <div class="ie-field"><label>Sell Value</label><input id="ie_sellValue" type="number" min="0" placeholder="25"></div>
              <div class="ie-field"><label>Max Stack</label><input id="ie_maxStack" type="number" min="1" placeholder="99"></div>
            </div>

            <div class="ie-section-title">âš¡ Effect</div>
            <div class="ie-form-grid">
              <div class="ie-field"><label>Power (effect amount)</label><input id="ie_power" type="number" placeholder="50"></div>
              <div class="ie-field"><label>Duration (ms, 0 = instant)</label><input id="ie_duration" type="number" min="0" placeholder="300000"></div>
            </div>

            <div class="ie-section-title">âš™ Extra Properties <span style="color:var(--dim);font-size:10px;font-style:normal;">(optional JSON)</span></div>
            <div class="ie-field">
              <textarea id="ie_extras" rows="2" placeholder='e.g. {"keyType": "ruby", "lore": "A sip of ancient magic."}'></textarea>
            </div>
          </div>
        </div>
        <div id="ieFormActions" style="display:none;">
          <button class="btn-a" onclick="ieSaveCurrent()" style="font-size:11px;">ğŸ’¾ Save Item</button>
          <button onclick="ieRevertCurrent()" style="font-size:11px;" title="Undo unsaved changes">â†© Revert</button>
          <button onclick="ieDownloadJS()" style="border-color:var(--orange);color:var(--orange);background:rgba(232,135,74,.08);font-size:11px;">â¬‡ Download Items JS</button>
          <button onclick="ieCopyToClipboard()" style="border-color:var(--purple);color:var(--purple);background:rgba(168,85,247,.08);font-size:11px;">ğŸ“‹ Copy JS</button>
          <span id="ieStatus"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENEMY EDITOR  â€“  in-memory edits to the live ENEMIES object
//  Generates updated JS that can be downloaded / copy-pasted back.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ ITEMS working copy (populated from ITEMS global if present) â”€â”€â”€
let ieWorkingCopy  = {};
let ieCurrentKey   = null;
let ieOriginalData = null;

function ieGetItemsSource() {
    return (typeof ITEMS !== 'undefined') ? ITEMS : {};
}

// â”€â”€ ENEMY EDITOR STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let eeCurrentKey   = null;   // which enemy is loaded in the form
let eeOriginalData = null;   // snapshot for revert
let eeWorkingCopy  = {};     // our editable clone of ENEMIES

// â”€â”€ Populate the item picker dropdown in the enemy form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function eePopulateItemPicker() {
    const sel = document.getElementById('ee_itemPickerDrop');
    if (!sel) return;
    const prev = sel.value;
    sel.innerHTML = '<option value="">â€” pick item to add â€”</option>';
    const items = Object.entries(ieWorkingCopy).length ? ieWorkingCopy : ieGetItemsSource();
    const sorted = Object.entries(items).sort((a,b) => (a[1].name||a[0]).localeCompare(b[1].name||b[0]));
    sorted.forEach(([k,v]) => {
        const o = document.createElement('option');
        o.value = k;
        o.textContent = (v.icon ? v.icon + ' ' : '') + (v.name || k) + ' [' + (v.subtype||'') + ']';
        sel.appendChild(o);
    });
    if (prev) sel.value = prev;
}

// â”€â”€ Drop chips (possible drops UI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let eeCurrentDrops = [];   // array of item key strings

function eeRenderDropChips() {
    const container = document.getElementById('ee_dropsChips');
    container.innerHTML = '';
    const items = Object.keys(ieWorkingCopy).length ? ieWorkingCopy : ieGetItemsSource();
    eeCurrentDrops.forEach((key, idx) => {
        const data  = items[key];
        const label = data ? ((data.icon ? data.icon + ' ' : '') + data.name) : key;
        const chip  = document.createElement('span');
        chip.className = 'drop-chip';
        chip.innerHTML = `${label} <button class="chip-remove" onclick="eeRemoveDropItem(${idx})" title="Remove">Ã—</button>`;
        container.appendChild(chip);
    });
    // keep hidden field in sync
    document.getElementById('ee_possibleDrops').value = eeCurrentDrops.join(',');
}

function eeAddDropItem() {
    const sel = document.getElementById('ee_itemPickerDrop');
    const key = sel.value;
    if (!key) return;
    if (!eeCurrentDrops.includes(key)) {
        eeCurrentDrops.push(key);
        eeRenderDropChips();
    }
    sel.value = '';
}

function eeRemoveDropItem(idx) {
    eeCurrentDrops.splice(idx, 1);
    eeRenderDropChips();
}

function openEnemyEditor() {
    // Clone current ENEMIES into working copy
    eeWorkingCopy = JSON.parse(JSON.stringify(getEnemyList() || {}));
    // Init items working copy from live ITEMS
    if (!Object.keys(ieWorkingCopy).length) {
        ieWorkingCopy = JSON.parse(JSON.stringify(ieGetItemsSource()));
    }
    eeCurrentKey  = null;
    eeOriginalData = null;
    eeRefreshList();
    eePopulateItemPicker();
    document.getElementById('enemyEditorOverlay').classList.add('open');
    document.getElementById('eeHeaderSub').textContent =
        Object.keys(eeWorkingCopy).length + ' enemies loaded';
    eeShowPlaceholder();
    document.getElementById('eeSearch').value = '';
    document.getElementById('eeDropdown').value = '';
    document.getElementById('eeSearch').focus();
}

function eeClose() {
    document.getElementById('enemyEditorOverlay').classList.remove('open');
    // Re-sync live ENEMIES object from working copy so room dropdowns stay fresh
    Object.keys(ENEMIES).forEach(k => { if (!eeWorkingCopy[k]) delete ENEMIES[k]; });
    Object.assign(ENEMIES, eeWorkingCopy);
    populateEnemyDropdown();
    updateStatus('Enemy database updated. ' + Object.keys(ENEMIES).length + ' enemies active.');
}

// â”€â”€ LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function eeGetSortedEntries() {
    return Object.entries(eeWorkingCopy)
        .map(([k,v]) => ({ key:k, data:v }))
        .sort((a,b) => {
            const la = a.data.level || 999, lb = b.data.level || 999;
            if (la !== lb) return la - lb;
            return (a.data.name||a.key).localeCompare(b.data.name||b.key);
        });
}

function eeMatchesFilter(name, key, level, ft) {
    if (!ft) return true;
    const numQuery = ft.match(/^\d+$/);
    if (numQuery) return String(level) === ft;
    return name.toLowerCase().includes(ft) || key.toLowerCase().includes(ft);
}

function eeRefreshList(filterText) {
    const container = document.getElementById('eeListItems');
    container.innerHTML = '';
    const ft = (filterText || '').toLowerCase().trim();
    const entries = eeGetSortedEntries();

    let shown = 0;
    entries.forEach(({ key, data }) => {
        const name  = data.name || key;
        const level = data.level ?? '?';
        if (!eeMatchesFilter(name, key, level, ft)) return;
        shown++;
        const div = document.createElement('div');
        div.className = 'ee-list-item' + (key === eeCurrentKey ? ' active' : '');
        div.dataset.key = key;
        div.innerHTML = `<span class="ee-item-name">ğŸ‘¹ ${name}</span>
                         <span class="ee-item-sub">Key: ${key} &nbsp;|&nbsp; Lv ${level} &nbsp;|&nbsp; HP ${data.baseHp ?? '?'}</span>`;
        div.onclick = () => eeSelectEnemy(key);
        container.appendChild(div);
    });

    const dd = document.getElementById('eeDropdown');
    const prevVal = dd.value;
    dd.innerHTML = '<option value="">â€” select enemy â€”</option>';
    entries.forEach(({ key, data }) => {
        const name  = data.name || key;
        const level = data.level ?? '?';
        if (!eeMatchesFilter(name, key, level, ft)) return;
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = `Lv ${String(level).padStart(2,' ')}  ${name}`;
        if (key === (prevVal || eeCurrentKey)) opt.selected = true;
        dd.appendChild(opt);
    });

    const total = Object.keys(eeWorkingCopy).length;
    document.getElementById('eeHeaderSub').textContent =
        ft ? `${shown} of ${total} enemies matched` : `${total} enemies loaded`;
}

function eeFilterList() {
    eeRefreshList(document.getElementById('eeSearch').value);
}

function eeDropdownSelect() {
    const key = document.getElementById('eeDropdown').value;
    if (!key) return;
    eeSelectEnemy(key);
    const item = document.querySelector(`.ee-list-item[data-key="${CSS.escape(key)}"]`);
    if (item) item.scrollIntoView({ block:'nearest' });
}

function eeSelectEnemy(key) {
    if (eeCurrentKey && eeCurrentKey !== key) {
        const dirty = eeFormIsDirty();
        if (dirty && !confirm('You have unsaved changes to "' + eeCurrentKey + '". Discard them?')) return;
    }
    eeCurrentKey   = key;
    eeOriginalData = JSON.parse(JSON.stringify(eeWorkingCopy[key]));
    eeLoadForm(key, eeWorkingCopy[key]);
    document.querySelectorAll('.ee-list-item').forEach(el => {
        el.classList.toggle('active', el.dataset.key === key);
    });
    const dd = document.getElementById('eeDropdown');
    if (dd) dd.value = key;
}

// â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function eeShowPlaceholder() {
    document.getElementById('eeFormPlaceholder').style.display = '';
    document.getElementById('eeFormFields').style.display = 'none';
    document.getElementById('eeFormActions').style.display = 'none';
    eeSetStatus('');
}

function eeLoadForm(key, data) {
    document.getElementById('eeFormPlaceholder').style.display = 'none';
    document.getElementById('eeFormFields').style.display = 'flex';
    document.getElementById('eeFormActions').style.display = 'flex';

    document.getElementById('ee_key').value          = key;
    document.getElementById('ee_name').value         = data.name || '';
    document.getElementById('ee_description').value  = data.description || '';
    document.getElementById('ee_level').value        = data.level ?? '';
    document.getElementById('ee_baseHp').value       = data.baseHp ?? '';
    document.getElementById('ee_baseDefense').value  = data.baseDefense ?? '';
    document.getElementById('ee_baseDamage').value   = data.baseDamage ?? '';
    document.getElementById('ee_minDamage').value    = data.minDamage ?? '';
    document.getElementById('ee_maxDamage').value    = data.maxDamage ?? '';
    document.getElementById('ee_baseXp').value       = data.baseXp ?? '';
    document.getElementById('ee_baseGold').value     = data.baseGold ?? '';

    const dr = data.dropRates || {};
    document.getElementById('ee_drop_common').value    = dr.common    ?? '';
    document.getElementById('ee_drop_uncommon').value  = dr.uncommon  ?? '';
    document.getElementById('ee_drop_rare').value      = dr.rare      ?? '';
    document.getElementById('ee_drop_epic').value      = dr.epic      ?? '';

    // Load drops as chips
    eeCurrentDrops = Array.isArray(data.possibleDrops) ? [...data.possibleDrops] : [];
    eeRenderDropChips();

    const KNOWN = ['name','description','level','baseHp','baseDefense','baseDamage',
                   'minDamage','maxDamage','baseXp','baseGold','dropRates','possibleDrops'];
    const extras = {};
    Object.keys(data).forEach(k => { if (!KNOWN.includes(k)) extras[k] = data[k]; });
    document.getElementById('ee_extras').value = Object.keys(extras).length
        ? JSON.stringify(extras, null, 2) : '';

    eeSetStatus('');
}

function eeFormToObject() {
    const num = (id, fallback) => {
        const v = document.getElementById(id).value;
        return v === '' ? fallback : parseFloat(v);
    };
    const newKey = document.getElementById('ee_key').value.trim().replace(/\s+/g,'_').toLowerCase();
    if (!newKey) throw new Error('Key is required.');
    if (!document.getElementById('ee_name').value.trim()) throw new Error('Name is required.');

    const obj = {
        name:        document.getElementById('ee_name').value.trim(),
        baseHp:      num('ee_baseHp', 30),
        baseDamage:  num('ee_baseDamage', 8),
        minDamage:   num('ee_minDamage', 5),
        maxDamage:   num('ee_maxDamage', 10),
        baseDefense: num('ee_baseDefense', 3),
        baseXp:      num('ee_baseXp', 20),
        baseGold:    num('ee_baseGold', 15),
        level:       num('ee_level', 1),
        description: document.getElementById('ee_description').value.trim(),
    };

    const drCommon   = document.getElementById('ee_drop_common').value;
    const drUncommon = document.getElementById('ee_drop_uncommon').value;
    const drRare     = document.getElementById('ee_drop_rare').value;
    const drEpic     = document.getElementById('ee_drop_epic').value;
    if (drCommon || drUncommon || drRare || drEpic) {
        obj.dropRates = {};
        if (drCommon)   obj.dropRates.common   = parseFloat(drCommon);
        if (drUncommon) obj.dropRates.uncommon  = parseFloat(drUncommon);
        if (drRare)     obj.dropRates.rare      = parseFloat(drRare);
        if (drEpic)     obj.dropRates.epic      = parseFloat(drEpic);
    }

    // Use chips array
    if (eeCurrentDrops.length) obj.possibleDrops = [...eeCurrentDrops];

    const extRaw = document.getElementById('ee_extras').value.trim();
    if (extRaw) {
        try {
            const extras = JSON.parse(extRaw);
            Object.assign(obj, extras);
        } catch(e) {
            throw new Error('Extras JSON is invalid: ' + e.message);
        }
    }

    return { newKey, obj };
}

function eeFormIsDirty() {
    if (!eeCurrentKey || !eeOriginalData) return false;
    try {
        const { newKey, obj } = eeFormToObject();
        if (newKey !== eeCurrentKey) return true;
        return JSON.stringify(obj) !== JSON.stringify(eeOriginalData);
    } catch(e) { return true; }
}

function eeSaveCurrent() {
    try {
        const { newKey, obj } = eeFormToObject();
        const oldKey = eeCurrentKey;

        if (newKey !== oldKey && eeWorkingCopy[newKey]) {
            if (!confirm(`Key "${newKey}" already exists. Overwrite?`)) return;
        }
        if (newKey !== oldKey && oldKey) {
            delete eeWorkingCopy[oldKey];
        }

        eeWorkingCopy[newKey] = obj;
        eeCurrentKey   = newKey;
        eeOriginalData = JSON.parse(JSON.stringify(obj));

        eeRefreshList(document.getElementById('eeSearch').value);
        document.querySelectorAll('.ee-list-item').forEach(el => {
            el.classList.toggle('active', el.dataset.key === newKey);
        });
        eeSetStatus('âœ” Saved in memory! Use â¬‡ Download to persist.');
    } catch(e) {
        eeSetStatus('âš  ' + e.message);
    }
}

function eeRevertCurrent() {
    if (!eeCurrentKey || !eeOriginalData) return;
    eeCurrentDrops = Array.isArray(eeOriginalData.possibleDrops) ? [...eeOriginalData.possibleDrops] : [];
    eeLoadForm(eeCurrentKey, eeOriginalData);
    eeSetStatus('Reverted.');
}

function eeNewEnemy() {
    if (eeCurrentKey && eeFormIsDirty()) {
        if (!confirm('Discard unsaved changes to "' + eeCurrentKey + '"?')) return;
    }
    const key = 'new_enemy_' + Date.now();
    eeWorkingCopy[key] = {
        name: 'New Enemy', baseHp:30, baseDamage:8, minDamage:5, maxDamage:10,
        baseDefense:3, baseXp:20, baseGold:15, level:1,
        description: '',
        possibleDrops:[], dropRates:{ common:0.4, uncommon:0.2, rare:0.05, epic:0.01 }
    };
    eeRefreshList(document.getElementById('eeSearch').value);
    eeSelectEnemy(key);
    document.getElementById('ee_key').select();
}

function eeDeleteCurrent() {
    if (!eeCurrentKey) { eeSetStatus('No enemy selected.'); return; }
    const name = eeWorkingCopy[eeCurrentKey]?.name || eeCurrentKey;
    if (!confirm(`Delete "${name}" (${eeCurrentKey}) from the database? This cannot be undone.`)) return;
    delete eeWorkingCopy[eeCurrentKey];
    eeCurrentKey   = null;
    eeOriginalData = null;
    eeCurrentDrops = [];
    eeRefreshList(document.getElementById('eeSearch').value);
    eeShowPlaceholder();
}

function eeGenerateJS(filename) {
    const fn = filename || 'monsters-expanded.js';
    const lines = [
        `// ${fn} - Enemy Database`,
        '// Generated by Dungeon Editor on ' + new Date().toLocaleString(),
        '//',
        "// Safe declaration - won't crash if loaded twice",
        "if (typeof ENEMIES === 'undefined') var ENEMIES = {};",
        'Object.assign(ENEMIES, {'
    ];

    const sorted = Object.entries(eeWorkingCopy).sort((a,b) => {
        const la = a[1].level || 999, lb = b[1].level || 999;
        if (la !== lb) return la - lb;
        return (a[1].name||a[0]).localeCompare(b[1].name||b[0]);
    });

    sorted.forEach(([key, data], i) => {
        const comma = i < sorted.length - 1 ? ',' : '';
        lines.push('    ' + key + ': ' + JSON.stringify(data, null, 4)
            .replace(/\n/g, '\n    ') + comma);
    });

    lines.push('});');
    return lines.join('\n');
}

function eeDownloadJS() {
    let filename = prompt('Save enemies file as:', 'monsters-expanded.js');
    if (!filename) return;
    if (!filename.endsWith('.js')) filename += '.js';
    const js = eeGenerateJS(filename);
    const blob = new Blob([js], { type: 'text/javascript' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
    eeSetStatus('âœ” Downloaded as ' + filename);
}

function eeCopyToClipboard() {
    const js = eeGenerateJS();
    navigator.clipboard.writeText(js).then(() => {
        eeSetStatus('âœ” JS copied to clipboard!');
    }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = js; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        eeSetStatus('âœ” JS copied!');
    });
}

function eeSetStatus(msg) {
    const el = document.getElementById('eeStatus');
    if (el) el.textContent = msg;
}

document.getElementById('enemyEditorOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        if (eeCurrentKey && eeFormIsDirty()) {
            if (!confirm('You have unsaved changes. Close anyway?')) return;
        }
        eeClose();
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ITEM EDITOR  â€“  sub-modal inside enemy editor
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openItemEditor() {
    // Ensure working copy is populated
    if (!Object.keys(ieWorkingCopy).length) {
        ieWorkingCopy = JSON.parse(JSON.stringify(ieGetItemsSource()));
    }
    ieCurrentKey   = null;
    ieOriginalData = null;
    ieRefreshList();
    document.getElementById('itemEditorOverlay').classList.add('open');
    document.getElementById('ieHeaderSub').textContent =
        Object.keys(ieWorkingCopy).length + ' items loaded';
    ieShowPlaceholder();
    document.getElementById('ieSearch').value = '';
    document.getElementById('ieSearch').focus();
}

function ieClose() {
    document.getElementById('itemEditorOverlay').classList.remove('open');
    // Sync live ITEMS if it exists
    if (typeof ITEMS !== 'undefined') {
        Object.keys(ITEMS).forEach(k => { if (!ieWorkingCopy[k]) delete ITEMS[k]; });
        Object.assign(ITEMS, ieWorkingCopy);
    }
    // Refresh the drop picker in the enemy editor
    eePopulateItemPicker();
    eeRenderDropChips();
}

// â”€â”€ ITEM LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ieGetSortedEntries(filterText) {
    const ft = (filterText || '').toLowerCase().trim();
    return Object.entries(ieWorkingCopy)
        .map(([k,v]) => ({ key:k, data:v }))
        .filter(({ key, data }) => {
            if (!ft) return true;
            return (data.name||key).toLowerCase().includes(ft)
                || key.toLowerCase().includes(ft)
                || (data.subtype||'').toLowerCase().includes(ft);
        })
        .sort((a,b) => (a.data.name||a.key).localeCompare(b.data.name||b.key));
}

function ieRefreshList(filterText) {
    const container = document.getElementById('ieListItems');
    container.innerHTML = '';
    const ft = filterText || '';
    const entries = ieGetSortedEntries(ft);

    entries.forEach(({ key, data }) => {
        const name = data.name || key;
        const div  = document.createElement('div');
        div.className = 'ie-list-item' + (key === ieCurrentKey ? ' active' : '');
        div.dataset.key = key;
        div.innerHTML = `<span class="ie-item-name">${data.icon||'ğŸ“¦'} ${name}</span>
                         <span class="ie-item-sub">${key} &nbsp;|&nbsp; ${data.subtype||'misc'}</span>`;
        div.onclick = () => ieSelectItem(key);
        container.appendChild(div);
    });

    // Sync dropdown
    const dd = document.getElementById('ieDropdown');
    const prevVal = dd.value;
    dd.innerHTML = '<option value="">â€” select item â€”</option>';
    entries.forEach(({ key, data }) => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = (data.icon ? data.icon + ' ' : 'ğŸ“¦ ') + (data.name || key);
        if (key === (prevVal || ieCurrentKey)) opt.selected = true;
        dd.appendChild(opt);
    });

    const total = Object.keys(ieWorkingCopy).length;
    document.getElementById('ieHeaderSub').textContent =
        ft ? `${entries.length} of ${total} items matched` : `${total} items loaded`;
}

function ieFilterList() {
    ieRefreshList(document.getElementById('ieSearch').value);
}

function ieDropdownSelect() {
    const key = document.getElementById('ieDropdown').value;
    if (!key) return;
    ieSelectItem(key);
    const item = document.querySelector(`.ie-list-item[data-key="${CSS.escape(key)}"]`);
    if (item) item.scrollIntoView({ block:'nearest' });
}

function ieSelectItem(key) {
    if (ieCurrentKey && ieCurrentKey !== key && ieFormIsDirty()) {
        if (!confirm('Discard unsaved changes to "' + ieCurrentKey + '"?')) return;
    }
    ieCurrentKey   = key;
    ieOriginalData = JSON.parse(JSON.stringify(ieWorkingCopy[key]));
    ieLoadForm(key, ieWorkingCopy[key]);
    document.querySelectorAll('.ie-list-item').forEach(el => {
        el.classList.toggle('active', el.dataset.key === key);
    });
    const dd = document.getElementById('ieDropdown');
    if (dd) dd.value = key;
}

// â”€â”€ ITEM FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ieShowPlaceholder() {
    document.getElementById('ieFormPlaceholder').style.display = '';
    document.getElementById('ieFormFields').style.display = 'none';
    document.getElementById('ieFormActions').style.display = 'none';
    ieSetStatus('');
}

function ieLoadForm(key, data) {
    document.getElementById('ieFormPlaceholder').style.display = 'none';
    document.getElementById('ieFormFields').style.display = 'flex';
    document.getElementById('ieFormActions').style.display = 'flex';

    document.getElementById('ie_key').value         = key;
    document.getElementById('ie_name').value        = data.name || '';
    document.getElementById('ie_description').value = data.description || '';
    document.getElementById('ie_icon').value        = data.icon || '';
    document.getElementById('ie_cost').value        = data.cost ?? '';
    document.getElementById('ie_sellValue').value   = data.sellValue ?? '';
    document.getElementById('ie_maxStack').value    = data.maxStack ?? '';
    document.getElementById('ie_power').value       = data.power ?? '';
    document.getElementById('ie_duration').value    = data.duration ?? '';

    const sub = document.getElementById('ie_subtype');
    sub.value = data.subtype || 'misc';
    if (!sub.value) sub.value = 'misc';

    const KNOWN = ['name','description','icon','cost','sellValue','maxStack','power','duration','subtype'];
    const extras = {};
    Object.keys(data).forEach(k => { if (!KNOWN.includes(k)) extras[k] = data[k]; });
    document.getElementById('ie_extras').value = Object.keys(extras).length
        ? JSON.stringify(extras, null, 2) : '';

    ieSetStatus('');
}

function ieFormToObject() {
    const num = (id) => {
        const v = document.getElementById(id).value;
        return v === '' ? undefined : parseFloat(v);
    };
    const newKey = document.getElementById('ie_key').value.trim().replace(/\s+/g,'_').toLowerCase();
    if (!newKey) throw new Error('Key is required.');
    if (!document.getElementById('ie_name').value.trim()) throw new Error('Name is required.');

    const obj = { name: document.getElementById('ie_name').value.trim() };
    const subtype = document.getElementById('ie_subtype').value;
    if (subtype) obj.subtype = subtype;
    const icon = document.getElementById('ie_icon').value.trim();
    if (icon) obj.icon = icon;
    const desc = document.getElementById('ie_description').value.trim();
    if (desc) obj.description = desc;

    const cost = num('ie_cost'); if (cost !== undefined) obj.cost = cost;
    const sell = num('ie_sellValue'); if (sell !== undefined) obj.sellValue = sell;
    const stack = num('ie_maxStack'); if (stack !== undefined) obj.maxStack = stack;
    const power = num('ie_power'); if (power !== undefined) obj.power = power;
    const dur   = num('ie_duration'); if (dur !== undefined) obj.duration = dur;

    const extRaw = document.getElementById('ie_extras').value.trim();
    if (extRaw) {
        try { Object.assign(obj, JSON.parse(extRaw)); }
        catch(e) { throw new Error('Extras JSON invalid: ' + e.message); }
    }
    return { newKey, obj };
}

function ieFormIsDirty() {
    if (!ieCurrentKey || !ieOriginalData) return false;
    try {
        const { newKey, obj } = ieFormToObject();
        if (newKey !== ieCurrentKey) return true;
        return JSON.stringify(obj) !== JSON.stringify(ieOriginalData);
    } catch(e) { return true; }
}

function ieSaveCurrent() {
    try {
        const { newKey, obj } = ieFormToObject();
        const oldKey = ieCurrentKey;

        if (newKey !== oldKey && ieWorkingCopy[newKey]) {
            if (!confirm(`Key "${newKey}" already exists. Overwrite?`)) return;
        }
        if (newKey !== oldKey && oldKey) delete ieWorkingCopy[oldKey];

        ieWorkingCopy[newKey] = obj;
        ieCurrentKey   = newKey;
        ieOriginalData = JSON.parse(JSON.stringify(obj));

        ieRefreshList(document.getElementById('ieSearch').value);
        document.querySelectorAll('.ie-list-item').forEach(el => {
            el.classList.toggle('active', el.dataset.key === newKey);
        });
        ieSetStatus('âœ” Saved in memory! Use â¬‡ Download to persist.');
    } catch(e) {
        ieSetStatus('âš  ' + e.message);
    }
}

function ieRevertCurrent() {
    if (!ieCurrentKey || !ieOriginalData) return;
    ieLoadForm(ieCurrentKey, ieOriginalData);
    ieSetStatus('Reverted.');
}

function ieNewItem() {
    if (ieCurrentKey && ieFormIsDirty()) {
        if (!confirm('Discard unsaved changes to "' + ieCurrentKey + '"?')) return;
    }
    const key = 'new_item_' + Date.now();
    ieWorkingCopy[key] = { name:'New Item', subtype:'misc', power:0, cost:0, description:'' };
    ieRefreshList(document.getElementById('ieSearch').value);
    ieSelectItem(key);
    document.getElementById('ie_key').select();
}

function ieDeleteCurrent() {
    if (!ieCurrentKey) { ieSetStatus('No item selected.'); return; }
    const name = ieWorkingCopy[ieCurrentKey]?.name || ieCurrentKey;
    if (!confirm(`Delete "${name}" (${ieCurrentKey})? This cannot be undone.`)) return;
    delete ieWorkingCopy[ieCurrentKey];
    ieCurrentKey = null; ieOriginalData = null;
    ieRefreshList(document.getElementById('ieSearch').value);
    ieShowPlaceholder();
}

function ieGenerateJS(filename) {
    const fn = filename || 'items.js';
    const lines = [
        '// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        `// ${fn} - Items Database`,
        '// Generated by Dungeon Editor on ' + new Date().toLocaleString(),
        '// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '',
        'const ITEMS = {'
    ];

    const sorted = Object.entries(ieWorkingCopy)
        .sort((a,b) => (a[1].name||a[0]).localeCompare(b[1].name||b[0]));

    sorted.forEach(([key, data], i) => {
        const comma = i < sorted.length - 1 ? ',' : '';
        lines.push('    ' + key + ': ' + JSON.stringify(data, null, 4)
            .replace(/\n/g, '\n    ') + comma);
    });

    lines.push('};');
    lines.push('');
    lines.push("console.log('âœ… Items loaded:', Object.keys(ITEMS).length, 'items');");
    return lines.join('\n');
}

function ieDownloadJS() {
    let filename = prompt('Save items file as:', 'items.js');
    if (!filename) return;
    if (!filename.endsWith('.js')) filename += '.js';
    const js = ieGenerateJS(filename);
    const blob = new Blob([js], { type: 'text/javascript' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
    ieSetStatus('âœ” Downloaded as ' + filename);
}

function ieCopyToClipboard() {
    const js = ieGenerateJS();
    navigator.clipboard.writeText(js).then(() => {
        ieSetStatus('âœ” Copied to clipboard!');
    }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = js; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        ieSetStatus('âœ” Copied!');
    });
}

function ieSetStatus(msg) {
    const el = document.getElementById('ieStatus');
    if (el) el.textContent = msg;
}

document.getElementById('itemEditorOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        if (ieCurrentKey && ieFormIsDirty()) {
            if (!confirm('Unsaved item changes. Close anyway?')) return;
        }
        ieClose();
    }
});
</script>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- VERSION EDITOR OVERLAY                                             -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<style>
.db-overlay {
    display:none; position:fixed; inset:0; z-index:10500;
    background:rgba(0,0,0,0.82); backdrop-filter:blur(3px);
    align-items:center; justify-content:center;
}
.db-overlay.open { display:flex; }
.db-modal {
    background:#111417; border-radius:8px;
    width:96vw; max-width:1050px; height:88vh;
    display:flex; flex-direction:column; overflow:hidden;
}
.db-header {
    padding:9px 14px; display:flex; align-items:center; gap:8px; flex-shrink:0;
}
.db-header h2 { font-size:13px; letter-spacing:2px; text-transform:uppercase; flex:1; margin:0; }
.db-body { display:flex; flex:1; overflow:hidden; }
.db-list-panel {
    width:260px; min-width:260px; border-right:1px solid var(--border);
    display:flex; flex-direction:column; overflow:hidden;
}
.db-list-search { padding:7px; border-bottom:1px solid var(--border); flex-shrink:0; }
.db-list-search input, .db-list-search select {
    width:100%; background:#0a0e11; border:1px solid var(--border);
    color:var(--text); padding:4px 7px; font-family:'Courier New',monospace;
    font-size:12px; border-radius:3px; outline:none;
}
.db-list-items { flex:1; overflow-y:auto; }
.db-list-items::-webkit-scrollbar { width:5px; }
.db-list-items::-webkit-scrollbar-thumb { background:#333; border-radius:3px; }
.db-list-item {
    padding:7px 11px; cursor:pointer; border-bottom:1px solid #1a1f24;
    transition:background 0.1s;
}
.db-list-item:hover { background:#1a1f24; }
.db-list-item.active { border-left:3px solid currentColor; }
.db-list-item-name { font-size:12px; color:var(--bright); }
.db-list-item-sub  { font-size:10px; color:var(--dim); margin-top:2px; }
.db-list-actions { padding:7px; border-top:1px solid var(--border); flex-shrink:0; }
.db-form-panel { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.db-form-scroll { flex:1; overflow-y:auto; padding:14px; display:flex; flex-direction:column; gap:9px; }
.db-form-scroll::-webkit-scrollbar { width:5px; }
.db-form-scroll::-webkit-scrollbar-thumb { background:#333; border-radius:3px; }
.db-placeholder { color:var(--dim); font-size:13px; margin:auto; text-align:center; }
.db-form-actions {
    display:flex; gap:7px; padding:10px 14px; border-top:1px solid var(--border);
    flex-shrink:0; flex-wrap:wrap;
}
.db-status { font-size:11px; color:var(--dim); margin-left:auto; align-self:center; }
.db-grid { display:grid; gap:8px; }
.db-grid-2 { grid-template-columns:1fr 1fr; }
.db-grid-3 { grid-template-columns:1fr 1fr 1fr; }
.db-grid-4 { grid-template-columns:1fr 1fr 1fr 1fr; }
.db-field label { display:block; font-size:10px; color:var(--dim); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:3px; }
.db-field input, .db-field textarea, .db-field select {
    width:100%; background:#0a0e11; border:1px solid var(--border);
    color:var(--text); padding:5px 7px; font-family:'Courier New',monospace;
    font-size:12px; border-radius:3px; outline:none;
}
.db-field textarea { resize:vertical; min-height:50px; }
.db-section-title {
    font-size:11px; text-transform:uppercase; letter-spacing:1px;
    border-bottom:1px solid var(--border); padding-bottom:4px; margin-top:4px;
}
</style>

<!-- VERSION EDITOR -->
<div id="versionEditorOverlay" class="db-overlay">
  <div class="db-modal" style="border:2px solid var(--accent);box-shadow:0 0 50px rgba(0,200,150,0.2);">
    <div class="db-header" style="background:#0a1a14;border-bottom:2px solid var(--accent);">
      <h2 style="color:var(--accent);">ğŸ“‹ Game Version Editor</h2>
      <span id="veHeaderSub" style="font-size:11px;color:var(--dim);"></span>
      <button onclick="veNewEntry()" style="border-color:var(--accent);color:var(--accent);font-size:11px;padding:3px 9px;">+ New Entry</button>
      <button onclick="veClose()" style="border-color:var(--red);color:var(--red);font-size:11px;padding:3px 9px;margin-left:4px;">âœ• Close</button>
    </div>
    <div class="db-body">
      <div class="db-list-panel">
        <div class="db-list-search">
          <input id="veSearch" type="text" placeholder="ğŸ” Search versions..." oninput="veFilterList()">
          <select id="veDropdown" onchange="veDropdownSelect()" style="margin-top:5px;cursor:pointer;">
            <option value="">â€” select version â€”</option>
          </select>
        </div>
        <div id="veListItems" class="db-list-items"></div>
        <div class="db-list-actions">
          <button class="btn-d" onclick="veDeleteCurrent()" style="width:100%;font-size:11px;">Ã— Delete Selected</button>
        </div>
      </div>
      <div class="db-form-panel">
        <div id="veForm" class="db-form-scroll">
          <div id="veFormPlaceholder" class="db-placeholder">â† Select a version entry to edit<br>or click <strong style="color:var(--accent)">+ New Entry</strong></div>
          <div id="veFormFields" style="display:none;flex-direction:column;gap:9px;">
            <div class="db-section-title" style="color:var(--accent);">ğŸ”‘ Version Info</div>
            <div class="db-grid db-grid-2">
              <div class="db-field"><label>Version String *</label><input id="ve_version" type="text" placeholder="2025.02.19-r30"></div>
              <div class="db-field"><label>Date</label><input id="ve_date" type="text" placeholder="Feb 19, 2025"></div>
            </div>
            <div class="db-field"><label>Summary</label><input id="ve_summary" type="text" placeholder="Short one-line summary of this patch"></div>
            <div class="db-section-title" style="color:var(--accent);">ğŸ“ Changes (one per line)</div>
            <div class="db-field"><textarea id="ve_changes" rows="8" placeholder="Fixed: something&#10;Added: something else&#10;Changed: another thing"></textarea></div>
            <div class="db-field">
              <label>Mark as Current Version?</label>
              <label style="display:flex;align-items:center;gap:6px;margin-top:4px;text-transform:none;letter-spacing:0;font-size:12px;color:var(--text);">
                <input type="checkbox" id="ve_isCurrent" style="width:auto;">
                Set this as GAME_VERSION (the active version players see)
              </label>
            </div>
          </div>
        </div>
        <div id="veFormActions" class="db-form-actions" style="display:none;">
          <button class="btn-a" onclick="veSaveCurrent()" style="font-size:11px;">ğŸ’¾ Save Entry</button>
          <button onclick="veRevertCurrent()" style="font-size:11px;">â†© Revert</button>
          <button onclick="veDownloadJS()" style="border-color:var(--orange);color:var(--orange);font-size:11px;">â¬‡ Download gameversion.js</button>
          <button onclick="veCopyJS()" style="border-color:var(--purple);color:var(--purple);font-size:11px;">ğŸ“‹ Copy JS</button>
          <span id="veStatus" class="db-status"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SPELL EDITOR -->
<div id="spellEditorOverlay" class="db-overlay">
  <div class="db-modal" style="border:2px solid var(--blue);box-shadow:0 0 50px rgba(74,142,232,0.2);">
    <div class="db-header" style="background:#080a14;border-bottom:2px solid var(--blue);">
      <h2 style="color:var(--blue);">âœ¨ Class Spell Editor</h2>
      <span id="seHeaderSub" style="font-size:11px;color:var(--dim);"></span>
      <button onclick="seNewSpell()" style="border-color:var(--accent);color:var(--accent);font-size:11px;padding:3px 9px;">+ New Spell</button>
      <button onclick="seClose()" style="border-color:var(--red);color:var(--red);font-size:11px;padding:3px 9px;margin-left:4px;">âœ• Close</button>
    </div>
    <div class="db-body">
      <div class="db-list-panel">
        <div class="db-list-search">
          <input id="seSearch" type="text" placeholder="ğŸ” Search spells..." oninput="seFilterList()">
          <select id="seClassFilter" onchange="seFilterList()" style="margin-top:5px;cursor:pointer;">
            <option value="">â€” all classes â€”</option>
          </select>
          <select id="seDropdown" onchange="seDropdownSelect()" style="margin-top:5px;cursor:pointer;">
            <option value="">â€” select spell â€”</option>
          </select>
        </div>
        <div id="seListItems" class="db-list-items"></div>
        <div class="db-list-actions">
          <button class="btn-d" onclick="seDeleteCurrent()" style="width:100%;font-size:11px;">Ã— Delete Spell</button>
        </div>
      </div>
      <div class="db-form-panel">
        <div id="seForm" class="db-form-scroll">
          <div id="seFormPlaceholder" class="db-placeholder">â† Select a spell or click <strong style="color:var(--accent)">+ New Spell</strong></div>
          <div id="seFormFields" style="display:none;flex-direction:column;gap:9px;">
            <div class="db-section-title" style="color:var(--blue);">ğŸ”‘ Identity</div>
            <div class="db-grid db-grid-3">
              <div class="db-field"><label>Class *</label>
                <select id="se_class">
                  <option value="mage">mage</option><option value="paladin">paladin</option>
                  <option value="acolyte">acolyte</option><option value="cleric">cleric</option>
                  <option value="warlock">warlock</option><option value="archer">archer</option>
                  <option value="hunter">hunter</option><option value="rogue">rogue</option>
                  <option value="warrior">warrior</option>
                </select>
              </div>
              <div class="db-field"><label>Spell Key *</label><input id="se_key" type="text" placeholder="fireball_1"></div>
              <div class="db-field"><label>Name *</label><input id="se_name" type="text" placeholder="Fireball"></div>
            </div>
            <div class="db-field"><label>Description</label><input id="se_description" type="text" placeholder="What this spell does..."></div>
            <div class="db-section-title" style="color:var(--blue);">âš¡ Spell Stats</div>
            <div class="db-grid db-grid-3">
              <div class="db-field"><label>Level Required</label><input id="se_level" type="number" min="1" placeholder="1"></div>
              <div class="db-field"><label>MP Cost</label><input id="se_mpCost" type="number" min="0" placeholder="15"></div>
              <div class="db-field"><label>Gold Cost (buy)</label><input id="se_cost" type="number" min="0" placeholder="0"></div>
            </div>
            <div class="db-grid db-grid-4">
              <div class="db-field"><label>Min Power</label><input id="se_minPower" type="number" min="0" placeholder="8"></div>
              <div class="db-field"><label>Max Power</label><input id="se_maxPower" type="number" min="0" placeholder="40"></div>
              <div class="db-field"><label>Lifesteal %</label><input id="se_lifestealPercent" type="number" min="0" max="100" placeholder="0"></div>
              <div class="db-field"><label>Type</label>
                <select id="se_type">
                  <option value="damage">damage</option><option value="heal">heal</option>
                  <option value="lifesteal">lifesteal</option><option value="buff">buff</option>
                  <option value="debuff">debuff</option><option value="dot">dot</option>
                </select>
              </div>
            </div>
            <div class="db-section-title" style="color:var(--blue);">ğŸ”— Tree Links</div>
            <div class="db-grid db-grid-2">
              <div class="db-field"><label>Requires (spell key)</label><input id="se_requires" type="text" placeholder="fireball_1"></div>
              <div class="db-field"><label>Upgrades To (spell key)</label><input id="se_upgradesTo" type="text" placeholder="fireball_2"></div>
            </div>
            <div class="db-section-title" style="color:var(--blue);">âš™ Extras (JSON)</div>
            <div class="db-field"><textarea id="se_extras" rows="2" placeholder='{"aoeTargets":3}'></textarea></div>
          </div>
        </div>
        <div id="seFormActions" class="db-form-actions" style="display:none;">
          <button class="btn-a" onclick="seSaveCurrent()" style="font-size:11px;">ğŸ’¾ Save Spell</button>
          <button onclick="seRevertCurrent()" style="font-size:11px;">â†© Revert</button>
          <button onclick="seDownloadJS()" style="border-color:var(--orange);color:var(--orange);font-size:11px;">â¬‡ Download class-spells.js</button>
          <button onclick="seCopyJS()" style="border-color:var(--purple);color:var(--purple);font-size:11px;">ğŸ“‹ Copy JS</button>
          <span id="seStatus" class="db-status"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- WEAPON EDITOR -->
<div id="weaponEditorOverlay" class="db-overlay">
  <div class="db-modal" style="border:2px solid var(--red);box-shadow:0 0 50px rgba(232,74,74,0.2);">
    <div class="db-header" style="background:#140808;border-bottom:2px solid var(--red);">
      <h2 style="color:var(--red);">âš” Weapon Editor</h2>
      <span id="weHeaderSub" style="font-size:11px;color:var(--dim);"></span>
      <button onclick="weNewWeapon()" style="border-color:var(--accent);color:var(--accent);font-size:11px;padding:3px 9px;">+ New Weapon</button>
      <button onclick="weClose()" style="border-color:var(--red);color:var(--red);font-size:11px;padding:3px 9px;margin-left:4px;">âœ• Close</button>
    </div>
    <div class="db-body">
      <div class="db-list-panel">
        <div class="db-list-search">
          <input id="weSearch" type="text" placeholder="ğŸ” Search weapons..." oninput="weFilterList()">
          <select id="weDropdown" onchange="weDropdownSelect()" style="margin-top:5px;cursor:pointer;">
            <option value="">â€” select weapon â€”</option>
          </select>
        </div>
        <div id="weListItems" class="db-list-items"></div>
        <div class="db-list-actions">
          <button class="btn-d" onclick="weDeleteCurrent()" style="width:100%;font-size:11px;">Ã— Delete Weapon</button>
        </div>
      </div>
      <div class="db-form-panel">
        <div id="weForm" class="db-form-scroll">
          <div id="weFormPlaceholder" class="db-placeholder">â† Select a weapon or click <strong style="color:var(--accent)">+ New Weapon</strong></div>
          <div id="weFormFields" style="display:none;flex-direction:column;gap:9px;">
            <div class="db-section-title" style="color:var(--red);">ğŸ”‘ Identity</div>
            <div class="db-grid db-grid-2">
              <div class="db-field"><label>Key *</label><input id="we_key" type="text" placeholder="iron_sword"></div>
              <div class="db-field"><label>Name *</label><input id="we_name" type="text" placeholder="Iron Sword"></div>
            </div>
            <div class="db-field"><label>Description</label><input id="we_description" type="text" placeholder="A sturdy iron blade..."></div>
            <div class="db-section-title" style="color:var(--red);">âš” Stats</div>
            <div class="db-grid db-grid-4">
              <div class="db-field"><label>Level</label><input id="we_level" type="number" min="1" placeholder="1"></div>
              <div class="db-field"><label>Base Damage</label><input id="we_baseDamage" type="number" min="0" placeholder="8"></div>
              <div class="db-field"><label>Max Damage</label><input id="we_maxDamage" type="number" min="0" placeholder="14"></div>
              <div class="db-field"><label>Magic Damage</label><input id="we_baseMagicDamage" type="number" min="0" placeholder="0"></div>
            </div>
            <div class="db-grid db-grid-3">
              <div class="db-field"><label>Cost</label><input id="we_cost" type="number" min="0" placeholder="100"></div>
              <div class="db-field"><label>Quality</label>
                <select id="we_quality">
                  <option value="poor">poor</option><option value="normal">normal</option>
                  <option value="rare">rare</option><option value="epic">epic</option>
                  <option value="legendary">legendary</option><option value="godly">godly</option>
                </select>
              </div>
              <div class="db-field"><label>Type</label>
                <select id="we_type">
                  <option value="sword">sword</option><option value="dagger">dagger</option>
                  <option value="axe">axe</option><option value="mace">mace</option>
                  <option value="bow">bow</option><option value="staff">staff</option>
                  <option value="wand">wand</option><option value="unarmed">unarmed</option>
                  <option value="misc">misc</option>
                </select>
              </div>
            </div>
            <div class="db-grid db-grid-2">
              <div class="db-field"><label>Class Restriction</label><input id="we_classRestriction" type="text" placeholder="rogue  (blank = any class)"></div>
              <div class="db-field"><label>Slot</label><input id="we_slot" type="text" placeholder="weapon" value="weapon"></div>
            </div>
            <div class="db-section-title" style="color:var(--red);">âš™ Extras (JSON)</div>
            <div class="db-field"><textarea id="we_extras" rows="2" placeholder='{"modifier":"fire","modifierValue":10}'></textarea></div>
          </div>
        </div>
        <div id="weFormActions" class="db-form-actions" style="display:none;">
          <button class="btn-a" onclick="weSaveCurrent()" style="font-size:11px;">ğŸ’¾ Save Weapon</button>
          <button onclick="weRevertCurrent()" style="font-size:11px;">â†© Revert</button>
          <button onclick="weDownloadJS()" style="border-color:var(--orange);color:var(--orange);font-size:11px;">â¬‡ Download weapons.js</button>
          <button onclick="weCopyJS()" style="border-color:var(--purple);color:var(--purple);font-size:11px;">ğŸ“‹ Copy JS</button>
          <span id="weStatus" class="db-status"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ARMOR EDITOR -->
<div id="armorEditorOverlay" class="db-overlay">
  <div class="db-modal" style="border:2px solid var(--purple);box-shadow:0 0 50px rgba(168,85,247,0.2);">
    <div class="db-header" style="background:#0e0814;border-bottom:2px solid var(--purple);">
      <h2 style="color:var(--purple);">ğŸ›¡ Armor Editor</h2>
      <span id="aeHeaderSub" style="font-size:11px;color:var(--dim);"></span>
      <button onclick="aeNewArmor()" style="border-color:var(--accent);color:var(--accent);font-size:11px;padding:3px 9px;">+ New Armor</button>
      <button onclick="aeClose()" style="border-color:var(--red);color:var(--red);font-size:11px;padding:3px 9px;margin-left:4px;">âœ• Close</button>
    </div>
    <div class="db-body">
      <div class="db-list-panel">
        <div class="db-list-search">
          <input id="aeSearch" type="text" placeholder="ğŸ” Search armor..." oninput="aeFilterList()">
          <select id="aeDropdown" onchange="aeDropdownSelect()" style="margin-top:5px;cursor:pointer;">
            <option value="">â€” select armor â€”</option>
          </select>
        </div>
        <div id="aeListItems" class="db-list-items"></div>
        <div class="db-list-actions">
          <button class="btn-d" onclick="aeDeleteCurrent()" style="width:100%;font-size:11px;">Ã— Delete Armor</button>
        </div>
      </div>
      <div class="db-form-panel">
        <div id="aeForm" class="db-form-scroll">
          <div id="aeFormPlaceholder" class="db-placeholder">â† Select a piece or click <strong style="color:var(--accent)">+ New Armor</strong></div>
          <div id="aeFormFields" style="display:none;flex-direction:column;gap:9px;">
            <div class="db-section-title" style="color:var(--purple);">ğŸ”‘ Identity</div>
            <div class="db-grid db-grid-2">
              <div class="db-field"><label>Key *</label><input id="ae_key" type="text" placeholder="leather_vest"></div>
              <div class="db-field"><label>Name *</label><input id="ae_name" type="text" placeholder="Leather Vest"></div>
            </div>
            <div class="db-field"><label>Description</label><input id="ae_description" type="text" placeholder="Basic leather protection..."></div>
            <div class="db-section-title" style="color:var(--purple);">ğŸ›¡ Stats</div>
            <div class="db-grid db-grid-4">
              <div class="db-field"><label>Level</label><input id="ae_level" type="number" min="1" placeholder="1"></div>
              <div class="db-field"><label>Base Defense</label><input id="ae_baseDefense" type="number" min="0" placeholder="2"></div>
              <div class="db-field"><label>Magic Defense</label><input id="ae_magicDefense" type="number" min="0" placeholder="0"></div>
              <div class="db-field"><label>Cost</label><input id="ae_cost" type="number" min="0" placeholder="80"></div>
            </div>
            <div class="db-grid db-grid-2">
              <div class="db-field"><label>Quality</label>
                <select id="ae_quality">
                  <option value="poor">poor</option><option value="normal">normal</option>
                  <option value="rare">rare</option><option value="epic">epic</option>
                  <option value="legendary">legendary</option><option value="godly">godly</option>
                </select>
              </div>
              <div class="db-field"><label>Slot</label><input id="ae_slot" type="text" value="armor" placeholder="armor"></div>
            </div>
            <div class="db-section-title" style="color:var(--purple);">âš™ Extras (JSON)</div>
            <div class="db-field"><textarea id="ae_extras" rows="2" placeholder='{"classRestriction":"paladin"}'></textarea></div>
          </div>
        </div>
        <div id="aeFormActions" class="db-form-actions" style="display:none;">
          <button class="btn-a" onclick="aeSaveCurrent()" style="font-size:11px;">ğŸ’¾ Save Armor</button>
          <button onclick="aeRevertCurrent()" style="font-size:11px;">â†© Revert</button>
          <button onclick="aeDownloadJS()" style="border-color:var(--orange);color:var(--orange);font-size:11px;">â¬‡ Download armor-new.js</button>
          <button onclick="aeCopyJS()" style="border-color:var(--purple);color:var(--purple);font-size:11px;">ğŸ“‹ Copy JS</button>
          <span id="aeStatus" class="db-status"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHARED DB EDITOR HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dbDownload(js, defaultFilename) {
    let fn = prompt('Save file as:', defaultFilename);
    if (!fn) return fn; // cancelled
    if (!fn.endsWith('.js')) fn += '.js';
    const blob = new Blob([js], {type:'text/javascript'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = fn; a.click();
    URL.revokeObjectURL(url);
    return fn;
}
function dbCopy(js, statusFn) {
    navigator.clipboard.writeText(js).then(() => statusFn('âœ” Copied!')).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = js; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        statusFn('âœ” Copied!');
    });
}
function dbClose(overlayId) {
    document.getElementById(overlayId).classList.remove('open');
}
function dbBuildList(containerEl, entries, currentKey, accentColor, onClickFn) {
    containerEl.innerHTML = '';
    entries.forEach(({key, label, sub}) => {
        const d = document.createElement('div');
        d.className = 'db-list-item' + (key === currentKey ? ' active' : '');
        d.dataset.key = key;
        d.style.color = accentColor;
        d.innerHTML = `<div class="db-list-item-name">${label}</div><div class="db-list-item-sub">${sub||''}</div>`;
        d.onclick = () => onClickFn(key);
        containerEl.appendChild(d);
    });
}
function dbBuildDropdown(ddEl, entries, currentKey) {
    const prev = ddEl.value;
    ddEl.innerHTML = '<option value="">â€” select â€”</option>';
    entries.forEach(({key, label}) => {
        const o = document.createElement('option');
        o.value = key; o.textContent = label;
        if (key === (prev || currentKey)) o.selected = true;
        ddEl.appendChild(o);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VERSION EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let veHistory = [], veCurrentIdx = null, veOriginal = null;
const VE_DEFAULT_VER = typeof GAME_VERSION !== 'undefined' ? GAME_VERSION : '2025.01.01-r0';

function veGetRevHistory() {
    return (typeof REVISION_HISTORY !== 'undefined') ? REVISION_HISTORY : [];
}

function openVersionEditor() {
    // Clone history array
    const src = veGetRevHistory();
    veHistory = src.map(e => JSON.parse(JSON.stringify(e)));
    veCurrentIdx = null; veOriginal = null;
    veRefreshList();
    document.getElementById('versionEditorOverlay').classList.add('open');
    veShowPlaceholder();
    document.getElementById('veSearch').value = '';
    document.getElementById('veSearch').focus();
}
function veClose() {
    dbClose('versionEditorOverlay');
}
function veShowPlaceholder() {
    document.getElementById('veFormPlaceholder').style.display = '';
    document.getElementById('veFormFields').style.display = 'none';
    document.getElementById('veFormActions').style.display = 'none';
}
function veRefreshList(ft) {
    const filter = (ft||'').toLowerCase();
    const entries = veHistory
        .map((e,i) => ({key:String(i), label:e.version, sub:e.date + ' â€” ' + (e.summary||'')}))
        .filter(e => !filter || e.label.toLowerCase().includes(filter) || e.sub.toLowerCase().includes(filter));
    dbBuildList(document.getElementById('veListItems'), entries, String(veCurrentIdx), 'var(--accent)', k => veSelectEntry(parseInt(k)));
    dbBuildDropdown(document.getElementById('veDropdown'), entries, String(veCurrentIdx));
    document.getElementById('veHeaderSub').textContent = veHistory.length + ' version entries';
}
function veFilterList() { veRefreshList(document.getElementById('veSearch').value); }
function veDropdownSelect() {
    const v = document.getElementById('veDropdown').value;
    if (v !== '') veSelectEntry(parseInt(v));
}
function veSelectEntry(idx) {
    veCurrentIdx = idx; veOriginal = JSON.parse(JSON.stringify(veHistory[idx]));
    const e = veHistory[idx];
    document.getElementById('ve_version').value  = e.version || '';
    document.getElementById('ve_date').value     = e.date    || '';
    document.getElementById('ve_summary').value  = e.summary || '';
    document.getElementById('ve_changes').value  = (e.changes||[]).join('\n');
    document.getElementById('ve_isCurrent').checked = (e.version === VE_DEFAULT_VER);
    document.getElementById('veFormPlaceholder').style.display = 'none';
    document.getElementById('veFormFields').style.display = 'flex';
    document.getElementById('veFormActions').style.display = 'flex';
    veSetStatus('');
    document.querySelectorAll('#veListItems .db-list-item').forEach(el => el.classList.toggle('active', el.dataset.key === String(idx)));
    document.getElementById('veDropdown').value = String(idx);
}
function veNewEntry() {
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    const dateStr = `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}`;
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const newEntry = {
        version: dateStr + '-r' + (veHistory.length),
        date: months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear(),
        summary: 'New patch',
        changes: ['Added: something new']
    };
    veHistory.unshift(newEntry);
    veRefreshList(document.getElementById('veSearch').value);
    veSelectEntry(0);
    document.getElementById('ve_version').select();
}
function veSaveCurrent() {
    if (veCurrentIdx === null) return;
    const v = document.getElementById('ve_version').value.trim();
    if (!v) { veSetStatus('âš  Version string required.'); return; }
    veHistory[veCurrentIdx] = {
        version: v,
        date:    document.getElementById('ve_date').value.trim(),
        summary: document.getElementById('ve_summary').value.trim(),
        changes: document.getElementById('ve_changes').value.split('\n').map(s=>s.trim()).filter(Boolean)
    };
    veRefreshList(document.getElementById('veSearch').value);
    veSetStatus('âœ” Saved in memory! Download to persist.');
}
function veRevertCurrent() {
    if (veCurrentIdx === null || !veOriginal) return;
    veHistory[veCurrentIdx] = JSON.parse(JSON.stringify(veOriginal));
    veSelectEntry(veCurrentIdx);
    veSetStatus('Reverted.');
}
function veDeleteCurrent() {
    if (veCurrentIdx === null) { veSetStatus('Nothing selected.'); return; }
    if (!confirm('Delete version entry "' + veHistory[veCurrentIdx].version + '"?')) return;
    veHistory.splice(veCurrentIdx, 1);
    veCurrentIdx = null; veOriginal = null;
    veRefreshList(document.getElementById('veSearch').value);
    veShowPlaceholder();
}
function veGenerateJS() {
    const currentVer = document.getElementById('ve_isCurrent')?.checked
        ? (veCurrentIdx !== null ? veHistory[veCurrentIdx].version : VE_DEFAULT_VER)
        : VE_DEFAULT_VER;
    const lines = [
        '// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '// GAME VERSION FILE â€” gameversion.js',
        '// Generated by Dungeon Editor on ' + new Date().toLocaleString(),
        '// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '',
        "const GAME_VERSION = '" + currentVer + "';",
        '',
        'function checkGameVersion() {',
        '    const stored = localStorage.getItem(\'dq_game_version\');',
        '    if (stored && stored !== GAME_VERSION) {',
        '        const existing = document.getElementById(\'versionBanner\');',
        '        if (existing) return;',
        '        const banner = document.createElement(\'div\');',
        '        banner.id = \'versionBanner\';',
        '        banner.innerHTML = `<div style="position:fixed;top:0;left:0;right:0;z-index:99999;background:#220000;border-bottom:3px solid #ff0000;padding:10px 16px;font-family:\'VT323\',monospace;display:flex;align-items:center;justify-content:space-between;gap:10px;box-sizing:border-box;"><div><span style="color:#ff4444;font-size:18px;font-weight:bold;">âš  OUTDATED VERSION DETECTED</span><br><span style="color:#ff8888;font-size:14px;">You are running <strong style="color:#ffaaaa;">v${stored}</strong> â€” latest is <strong style="color:#00ff88;">v${GAME_VERSION}</strong>. Refresh now!</span></div><button onclick="location.reload(true)" style="background:#ff0000;color:#fff;border:2px solid #ff4444;padding:8px 16px;font-family:\'VT323\',monospace;font-size:16px;cursor:pointer;">ğŸ”„ REFRESH NOW</button></div>`;',
        '        document.body.prepend(banner);',
        '    }',
        '    localStorage.setItem(\'dq_game_version\', GAME_VERSION);',
        '}',
        '',
        'const REVISION_HISTORY = ['
    ];
    veHistory.forEach((e, i) => {
        const comma = i < veHistory.length - 1 ? ',' : '';
        lines.push('    ' + JSON.stringify(e, null, 4).replace(/\n/g, '\n    ') + comma);
    });
    lines.push('];');
    return lines.join('\n');
}
function veDownloadJS() {
    const fn = dbDownload(veGenerateJS(), 'gameversion.js');
    if (fn) veSetStatus('âœ” Downloaded as ' + fn);
}
function veCopyJS() { dbCopy(veGenerateJS(), veSetStatus); }
function veSetStatus(m) { const el = document.getElementById('veStatus'); if(el) el.textContent = m; }
document.getElementById('versionEditorOverlay').addEventListener('click', e => { if(e.target===e.currentTarget) veClose(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPELL EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let seWorkingCopy = {}, seCurrentClass = null, seCurrentKey = null, seOriginal = null;

function seGetSource() { return (typeof CLASS_SPELL_TREES !== 'undefined') ? CLASS_SPELL_TREES : {}; }

function openSpellEditor() {
    seWorkingCopy = JSON.parse(JSON.stringify(seGetSource()));
    seCurrentClass = null; seCurrentKey = null; seOriginal = null;
    // Populate class filter
    const cf = document.getElementById('seClassFilter');
    const curClass = cf.value;
    cf.innerHTML = '<option value="">â€” all classes â€”</option>';
    Object.keys(seWorkingCopy).forEach(cls => {
        const o = document.createElement('option');
        o.value = cls; o.textContent = cls;
        cf.appendChild(o);
    });
    if (curClass) cf.value = curClass;
    seRefreshList();
    document.getElementById('spellEditorOverlay').classList.add('open');
    seShowPlaceholder();
    document.getElementById('seSearch').value = '';
}
function seClose() { dbClose('spellEditorOverlay'); }
function seShowPlaceholder() {
    document.getElementById('seFormPlaceholder').style.display = '';
    document.getElementById('seFormFields').style.display = 'none';
    document.getElementById('seFormActions').style.display = 'none';
}
function seGetFlatSpells(filter, classFilter) {
    const ft = (filter||'').toLowerCase();
    const cf = classFilter || document.getElementById('seClassFilter')?.value || '';
    const result = [];
    Object.entries(seWorkingCopy).forEach(([cls, clsData]) => {
        if (cf && cls !== cf) return;
        const tree = clsData.spellTree || {};
        Object.entries(tree).forEach(([key, spell]) => {
            const label = '[' + cls + '] ' + (spell.name || key);
            const sub   = 'Lv' + (spell.level||'?') + ' â€¢ ' + (spell.type||'?') + ' â€¢ key: ' + key;
            if (!ft || label.toLowerCase().includes(ft) || key.toLowerCase().includes(ft)) {
                result.push({key: cls+':'+key, spellKey:key, cls, label, sub, spell});
            }
        });
    });
    return result.sort((a,b) => {
        if (a.cls !== b.cls) return a.cls.localeCompare(b.cls);
        return (a.spell.level||0) - (b.spell.level||0);
    });
}
function seRefreshList() {
    const entries = seGetFlatSpells(document.getElementById('seSearch').value);
    const curComposite = seCurrentClass ? seCurrentClass + ':' + seCurrentKey : null;
    dbBuildList(document.getElementById('seListItems'), entries.map(e=>({key:e.key,label:e.label,sub:e.sub})), curComposite, 'var(--blue)', k => { const [cls,key] = k.split(':'); seSelectSpell(cls, key); });
    dbBuildDropdown(document.getElementById('seDropdown'), entries.map(e=>({key:e.key,label:e.label})), curComposite);
    const total = Object.values(seWorkingCopy).reduce((n,c)=>n+Object.keys(c.spellTree||{}).length,0);
    document.getElementById('seHeaderSub').textContent = total + ' spells across ' + Object.keys(seWorkingCopy).length + ' classes';
}
function seFilterList() { seRefreshList(); }
function seDropdownSelect() {
    const v = document.getElementById('seDropdown').value;
    if (!v) return;
    const [cls, key] = v.split(':');
    seSelectSpell(cls, key);
    const item = document.querySelector('#seListItems .db-list-item[data-key="' + CSS.escape(v) + '"]');
    if (item) item.scrollIntoView({block:'nearest'});
}
function seSelectSpell(cls, key) {
    seCurrentClass = cls; seCurrentKey = key;
    const spell = seWorkingCopy[cls]?.spellTree?.[key];
    if (!spell) return;
    seOriginal = JSON.parse(JSON.stringify(spell));
    document.getElementById('se_class').value       = cls;
    document.getElementById('se_key').value         = key;
    document.getElementById('se_name').value        = spell.name || '';
    document.getElementById('se_description').value = spell.description || '';
    document.getElementById('se_level').value       = spell.level ?? '';
    document.getElementById('se_mpCost').value      = spell.mpCost ?? '';
    document.getElementById('se_cost').value        = spell.cost ?? '';
    document.getElementById('se_minPower').value    = spell.minPower ?? '';
    document.getElementById('se_maxPower').value    = spell.maxPower ?? '';
    document.getElementById('se_lifestealPercent').value = spell.lifestealPercent ?? '';
    document.getElementById('se_type').value        = spell.type || 'damage';
    document.getElementById('se_requires').value    = spell.requires || '';
    document.getElementById('se_upgradesTo').value  = spell.upgradesTo || '';
    const KNOWN = ['name','description','level','mpCost','cost','minPower','maxPower','lifestealPercent','type','requires','upgradesTo'];
    const extras = {};
    Object.keys(spell).forEach(k => { if (!KNOWN.includes(k)) extras[k] = spell[k]; });
    document.getElementById('se_extras').value = Object.keys(extras).length ? JSON.stringify(extras,null,2) : '';
    document.getElementById('seFormPlaceholder').style.display = 'none';
    document.getElementById('seFormFields').style.display = 'flex';
    document.getElementById('seFormActions').style.display = 'flex';
    seSetStatus('');
    document.querySelectorAll('#seListItems .db-list-item').forEach(el => el.classList.toggle('active', el.dataset.key === cls+':'+key));
    document.getElementById('seDropdown').value = cls + ':' + key;
}
function seSaveCurrent() {
    const newKey   = document.getElementById('se_key').value.trim();
    const newClass = document.getElementById('se_class').value;
    if (!newKey || !newClass) { seSetStatus('âš  Key and Class required.'); return; }
    const n = v => { const s = document.getElementById(v).value; return s==='' ? undefined : parseFloat(s); };
    const obj = { name: document.getElementById('se_name').value.trim() };
    const lv = n('se_level'); if(lv!==undefined) obj.level = lv;
    const mp = n('se_mpCost'); if(mp!==undefined) obj.mpCost = mp;
    const co = n('se_cost'); if(co!==undefined) obj.cost = co;
    const mi = n('se_minPower'); if(mi!==undefined) obj.minPower = mi;
    const mx = n('se_maxPower'); if(mx!==undefined) obj.maxPower = mx;
    const ls = n('se_lifestealPercent'); if(ls!==undefined) obj.lifestealPercent = ls;
    obj.type = document.getElementById('se_type').value;
    const desc = document.getElementById('se_description').value.trim(); if(desc) obj.description = desc;
    const req  = document.getElementById('se_requires').value.trim(); if(req) obj.requires = req;
    const upto = document.getElementById('se_upgradesTo').value.trim(); if(upto) obj.upgradesTo = upto;
    const ext  = document.getElementById('se_extras').value.trim();
    if (ext) { try { Object.assign(obj, JSON.parse(ext)); } catch(e) { seSetStatus('âš  Extras JSON invalid.'); return; } }
    // Ensure class/spellTree exist
    if (!seWorkingCopy[newClass]) seWorkingCopy[newClass] = { spellTree: {} };
    if (!seWorkingCopy[newClass].spellTree) seWorkingCopy[newClass].spellTree = {};
    // Handle key rename or class move
    if ((seCurrentClass && seCurrentClass !== newClass) || (seCurrentKey && seCurrentKey !== newKey)) {
        if (seCurrentClass && seCurrentKey) delete seWorkingCopy[seCurrentClass].spellTree[seCurrentKey];
    }
    seWorkingCopy[newClass].spellTree[newKey] = obj;
    seCurrentClass = newClass; seCurrentKey = newKey; seOriginal = JSON.parse(JSON.stringify(obj));
    seRefreshList();
    seSetStatus('âœ” Saved! Download to persist.');
}
function seRevertCurrent() {
    if (!seCurrentClass || !seCurrentKey || !seOriginal) return;
    seSelectSpell(seCurrentClass, seCurrentKey);
    seSetStatus('Reverted.');
}
function seNewSpell() {
    const cls = document.getElementById('seClassFilter').value || 'mage';
    const key = 'new_spell_' + Date.now();
    if (!seWorkingCopy[cls]) seWorkingCopy[cls] = { spellTree: {} };
    seWorkingCopy[cls].spellTree[key] = { name:'New Spell', level:1, mpCost:10, minPower:5, maxPower:20, type:'damage', cost:0, description:'' };
    seRefreshList();
    seSelectSpell(cls, key);
    document.getElementById('se_key').select();
}
function seDeleteCurrent() {
    if (!seCurrentClass || !seCurrentKey) { seSetStatus('Nothing selected.'); return; }
    if (!confirm('Delete spell "' + seCurrentKey + '" from ' + seCurrentClass + '?')) return;
    delete seWorkingCopy[seCurrentClass].spellTree[seCurrentKey];
    seCurrentClass = null; seCurrentKey = null; seOriginal = null;
    seRefreshList(); seShowPlaceholder();
}
function seGenerateJS() {
    const lines = [
        '// CLASS-SPECIFIC SPELL PROGRESSION SYSTEM',
        '// Generated by Dungeon Editor on ' + new Date().toLocaleString(),
        '',
        'const CLASS_SPELL_TREES = {'
    ];
    Object.entries(seWorkingCopy).forEach(([cls, clsData], ci) => {
        const comma = ci < Object.keys(seWorkingCopy).length - 1 ? ',' : '';
        const treeEntries = Object.entries(clsData.spellTree || {});
        lines.push('    ' + cls + ': {');
        lines.push('        startingSpell: ' + JSON.stringify(clsData.startingSpell||'') + ',');
        lines.push('        spellTree: {');
        treeEntries.forEach(([k,v], i) => {
            const c2 = i < treeEntries.length - 1 ? ',' : '';
            lines.push('            ' + k + ': ' + JSON.stringify(v,null,4).replace(/\n/g,'\n            ') + c2);
        });
        lines.push('        }');
        lines.push('    }' + comma);
    });
    lines.push('};');
    lines.push("if (typeof module !== 'undefined' && module.exports) { module.exports = { CLASS_SPELL_TREES }; }");
    return lines.join('\n');
}
function seDownloadJS() { const fn = dbDownload(seGenerateJS(), 'class-spells.js'); if(fn) seSetStatus('âœ” Downloaded as '+fn); }
function seCopyJS() { dbCopy(seGenerateJS(), seSetStatus); }
function seSetStatus(m) { const el = document.getElementById('seStatus'); if(el) el.textContent = m; }
document.getElementById('spellEditorOverlay').addEventListener('click', e => { if(e.target===e.currentTarget) seClose(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEAPON EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let weWorkingCopy = {}, weCurrentKey = null, weOriginal = null;

function weGetSource() { return (typeof WEAPONS !== 'undefined') ? WEAPONS : {}; }

function openWeaponEditor() {
    weWorkingCopy = JSON.parse(JSON.stringify(weGetSource()));
    weCurrentKey = null; weOriginal = null;
    weRefreshList(); weShowPlaceholder();
    document.getElementById('weaponEditorOverlay').classList.add('open');
    document.getElementById('weSearch').value = '';
}
function weClose() { dbClose('weaponEditorOverlay'); }
function weShowPlaceholder() {
    document.getElementById('weFormPlaceholder').style.display='';
    document.getElementById('weFormFields').style.display='none';
    document.getElementById('weFormActions').style.display='none';
}
function weGetEntries(ft) {
    const f = (ft||'').toLowerCase();
    return Object.entries(weWorkingCopy)
        .filter(([k,v]) => !f || k.toLowerCase().includes(f) || (v.name||'').toLowerCase().includes(f))
        .sort((a,b) => (a[1].level||0)-(b[1].level||0) || a[0].localeCompare(b[0]))
        .map(([k,v]) => ({key:k, label:(v.name||k), sub:'Lv'+(v.level||'?')+' â€¢ '+(v.type||'?')+' â€¢ '+(v.quality||'')}));
}
function weRefreshList(ft) {
    const entries = weGetEntries(ft);
    dbBuildList(document.getElementById('weListItems'), entries, weCurrentKey, 'var(--red)', k => weSelectWeapon(k));
    dbBuildDropdown(document.getElementById('weDropdown'), entries, weCurrentKey);
    document.getElementById('weHeaderSub').textContent = Object.keys(weWorkingCopy).length + ' weapons';
}
function weFilterList() { weRefreshList(document.getElementById('weSearch').value); }
function weDropdownSelect() {
    const v = document.getElementById('weDropdown').value;
    if (v) { weSelectWeapon(v); const el = document.querySelector('#weListItems .db-list-item[data-key="'+CSS.escape(v)+'"]'); if(el) el.scrollIntoView({block:'nearest'}); }
}
function weSelectWeapon(key) {
    weCurrentKey = key;
    const w = weWorkingCopy[key]; if (!w) return;
    weOriginal = JSON.parse(JSON.stringify(w));
    document.getElementById('we_key').value           = key;
    document.getElementById('we_name').value          = w.name || '';
    document.getElementById('we_description').value   = w.description || '';
    document.getElementById('we_level').value         = w.level ?? '';
    document.getElementById('we_baseDamage').value    = w.baseDamage ?? '';
    document.getElementById('we_maxDamage').value     = w.maxDamage ?? '';
    document.getElementById('we_baseMagicDamage').value = w.baseMagicDamage ?? '';
    document.getElementById('we_cost').value          = w.cost ?? '';
    document.getElementById('we_quality').value       = w.quality || 'normal';
    document.getElementById('we_type').value          = w.type || 'sword';
    document.getElementById('we_classRestriction').value = w.classRestriction || '';
    document.getElementById('we_slot').value          = w.slot || 'weapon';
    const KNOWN = ['name','description','level','baseDamage','maxDamage','baseMagicDamage','cost','quality','type','classRestriction','slot'];
    const extras = {};
    Object.keys(w).forEach(k => { if(!KNOWN.includes(k)) extras[k]=w[k]; });
    document.getElementById('we_extras').value = Object.keys(extras).length ? JSON.stringify(extras,null,2) : '';
    document.getElementById('weFormPlaceholder').style.display='none';
    document.getElementById('weFormFields').style.display='flex';
    document.getElementById('weFormActions').style.display='flex';
    weSetStatus('');
    document.querySelectorAll('#weListItems .db-list-item').forEach(el=>el.classList.toggle('active',el.dataset.key===key));
    document.getElementById('weDropdown').value = key;
}
function weSaveCurrent() {
    const newKey = document.getElementById('we_key').value.trim().replace(/\s+/g,'_').toLowerCase();
    if (!newKey || !document.getElementById('we_name').value.trim()) { weSetStatus('âš  Key and Name required.'); return; }
    const n = id => { const v=document.getElementById(id).value; return v===''?undefined:parseFloat(v); };
    const obj = {
        name: document.getElementById('we_name').value.trim(),
        slot: document.getElementById('we_slot').value.trim() || 'weapon',
        quality: document.getElementById('we_quality').value,
        type: document.getElementById('we_type').value,
    };
    const lv=n('we_level'); if(lv!==undefined) obj.level=lv;
    const bd=n('we_baseDamage'); if(bd!==undefined) obj.baseDamage=bd;
    const md=n('we_maxDamage'); if(md!==undefined) obj.maxDamage=md;
    const mg=n('we_baseMagicDamage'); if(mg!==undefined) obj.baseMagicDamage=mg;
    const co=n('we_cost'); if(co!==undefined) obj.cost=co;
    const cr=document.getElementById('we_classRestriction').value.trim(); if(cr) obj.classRestriction=cr;
    const desc=document.getElementById('we_description').value.trim(); if(desc) obj.description=desc;
    const ext=document.getElementById('we_extras').value.trim();
    if(ext){try{Object.assign(obj,JSON.parse(ext));}catch(e){weSetStatus('âš  Extras JSON invalid.');return;}}
    if (newKey !== weCurrentKey && weCurrentKey) delete weWorkingCopy[weCurrentKey];
    weWorkingCopy[newKey] = obj;
    weCurrentKey = newKey; weOriginal = JSON.parse(JSON.stringify(obj));
    weRefreshList(document.getElementById('weSearch').value);
    weSetStatus('âœ” Saved! Download to persist.');
}
function weRevertCurrent() { if(!weCurrentKey||!weOriginal)return; weSelectWeapon(weCurrentKey); weSetStatus('Reverted.'); }
function weNewWeapon() {
    const key = 'new_weapon_' + Date.now();
    weWorkingCopy[key] = { name:'New Weapon', baseDamage:5, maxDamage:8, baseMagicDamage:0, level:1, quality:'normal', type:'sword', cost:0, slot:'weapon' };
    weRefreshList(); weSelectWeapon(key);
    document.getElementById('we_key').select();
}
function weDeleteCurrent() {
    if(!weCurrentKey){weSetStatus('Nothing selected.');return;}
    if(!confirm('Delete weapon "'+weCurrentKey+'"?'))return;
    delete weWorkingCopy[weCurrentKey];
    weCurrentKey=null; weOriginal=null;
    weRefreshList(); weShowPlaceholder();
}
function weGenerateJS() {
    const sorted = Object.entries(weWorkingCopy).sort((a,b)=>(a[1].level||0)-(b[1].level||0)||a[0].localeCompare(b[0]));
    const lines = [
        '// WEAPONS DATABASE',
        '// Generated by Dungeon Editor on ' + new Date().toLocaleString(),
        '',
        'const QUALITY_CONFIG = {',
        "    poor:      { bonusPct: 0.00, color: '#808080', name: 'Poor'      },",
        "    normal:    { bonusPct: 0.10, color: '#00FF00', name: 'Normal'    },",
        "    rare:      { bonusPct: 0.25, color: '#0099FF', name: 'Rare'      },",
        "    epic:      { bonusPct: 0.40, color: '#9933FF', name: 'Epic'      },",
        "    legendary: { bonusPct: 0.60, color: '#FF9900', name: 'Legendary' },",
        "    godly:     { bonusPct: 0.85, color: '#FF0000', name: 'Godly'     }",
        '};',
        '',
        'const WEAPONS = {'
    ];
    sorted.forEach(([k,v],i) => {
        const comma = i < sorted.length-1 ? ',' : '';
        lines.push('    '+k+': '+JSON.stringify(v,null,4).replace(/\n/g,'\n    ')+comma);
    });
    lines.push('};');
    lines.push("console.log('âœ… Weapons loaded with damage ranges:', Object.keys(WEAPONS).length, 'weapons');");
    return lines.join('\n');
}
function weDownloadJS() { const fn = dbDownload(weGenerateJS(), 'weapons.js'); if(fn) weSetStatus('âœ” Downloaded as '+fn); }
function weCopyJS() { dbCopy(weGenerateJS(), weSetStatus); }
function weSetStatus(m) { const el = document.getElementById('weStatus'); if(el) el.textContent = m; }
document.getElementById('weaponEditorOverlay').addEventListener('click', e => { if(e.target===e.currentTarget) weClose(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ARMOR EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let aeWorkingCopy = {}, aeCurrentKey = null, aeOriginal = null;

function aeGetSource() { return (typeof ARMOR !== 'undefined') ? ARMOR : {}; }

function openArmorEditor() {
    aeWorkingCopy = JSON.parse(JSON.stringify(aeGetSource()));
    aeCurrentKey = null; aeOriginal = null;
    aeRefreshList(); aeShowPlaceholder();
    document.getElementById('armorEditorOverlay').classList.add('open');
    document.getElementById('aeSearch').value = '';
}
function aeClose() { dbClose('armorEditorOverlay'); }
function aeShowPlaceholder() {
    document.getElementById('aeFormPlaceholder').style.display='';
    document.getElementById('aeFormFields').style.display='none';
    document.getElementById('aeFormActions').style.display='none';
}
function aeGetEntries(ft) {
    const f = (ft||'').toLowerCase();
    return Object.entries(aeWorkingCopy)
        .filter(([k,v]) => !f || k.toLowerCase().includes(f) || (v.name||'').toLowerCase().includes(f))
        .sort((a,b) => (a[1].level||0)-(b[1].level||0) || a[0].localeCompare(b[0]))
        .map(([k,v]) => ({key:k, label:(v.name||k), sub:'Lv'+(v.level||'?')+' â€¢ DEF:'+(v.baseDefense||0)+' MDEF:'+(v.magicDefense||0)+' â€¢ '+(v.quality||'')}));
}
function aeRefreshList(ft) {
    const entries = aeGetEntries(ft);
    dbBuildList(document.getElementById('aeListItems'), entries, aeCurrentKey, 'var(--purple)', k => aeSelectArmor(k));
    dbBuildDropdown(document.getElementById('aeDropdown'), entries, aeCurrentKey);
    document.getElementById('aeHeaderSub').textContent = Object.keys(aeWorkingCopy).length + ' armor pieces';
}
function aeFilterList() { aeRefreshList(document.getElementById('aeSearch').value); }
function aeDropdownSelect() {
    const v = document.getElementById('aeDropdown').value;
    if (v) { aeSelectArmor(v); const el = document.querySelector('#aeListItems .db-list-item[data-key="'+CSS.escape(v)+'"]'); if(el) el.scrollIntoView({block:'nearest'}); }
}
function aeSelectArmor(key) {
    aeCurrentKey = key;
    const a = aeWorkingCopy[key]; if(!a) return;
    aeOriginal = JSON.parse(JSON.stringify(a));
    document.getElementById('ae_key').value         = key;
    document.getElementById('ae_name').value        = a.name || '';
    document.getElementById('ae_description').value = a.description || '';
    document.getElementById('ae_level').value       = a.level ?? '';
    document.getElementById('ae_baseDefense').value = a.baseDefense ?? '';
    document.getElementById('ae_magicDefense').value = a.magicDefense ?? '';
    document.getElementById('ae_cost').value        = a.cost ?? '';
    document.getElementById('ae_quality').value     = a.quality || 'normal';
    document.getElementById('ae_slot').value        = a.slot || 'armor';
    const KNOWN = ['name','description','level','baseDefense','magicDefense','cost','quality','slot'];
    const extras = {};
    Object.keys(a).forEach(k => { if(!KNOWN.includes(k)) extras[k]=a[k]; });
    document.getElementById('ae_extras').value = Object.keys(extras).length ? JSON.stringify(extras,null,2) : '';
    document.getElementById('aeFormPlaceholder').style.display='none';
    document.getElementById('aeFormFields').style.display='flex';
    document.getElementById('aeFormActions').style.display='flex';
    aeSetStatus('');
    document.querySelectorAll('#aeListItems .db-list-item').forEach(el=>el.classList.toggle('active',el.dataset.key===key));
    document.getElementById('aeDropdown').value = key;
}
function aeSaveCurrent() {
    const newKey = document.getElementById('ae_key').value.trim().replace(/\s+/g,'_').toLowerCase();
    if (!newKey || !document.getElementById('ae_name').value.trim()) { aeSetStatus('âš  Key and Name required.'); return; }
    const n = id => { const v=document.getElementById(id).value; return v===''?undefined:parseFloat(v); };
    const obj = {
        name: document.getElementById('ae_name').value.trim(),
        slot: document.getElementById('ae_slot').value.trim() || 'armor',
        quality: document.getElementById('ae_quality').value,
    };
    const lv=n('ae_level'); if(lv!==undefined) obj.level=lv;
    const bd=n('ae_baseDefense'); if(bd!==undefined) obj.baseDefense=bd;
    const md=n('ae_magicDefense'); if(md!==undefined) obj.magicDefense=md;
    const co=n('ae_cost'); if(co!==undefined) obj.cost=co;
    const desc=document.getElementById('ae_description').value.trim(); if(desc) obj.description=desc;
    const ext=document.getElementById('ae_extras').value.trim();
    if(ext){try{Object.assign(obj,JSON.parse(ext));}catch(e){aeSetStatus('âš  Extras JSON invalid.');return;}}
    if (newKey !== aeCurrentKey && aeCurrentKey) delete aeWorkingCopy[aeCurrentKey];
    aeWorkingCopy[newKey] = obj;
    aeCurrentKey = newKey; aeOriginal = JSON.parse(JSON.stringify(obj));
    aeRefreshList(document.getElementById('aeSearch').value);
    aeSetStatus('âœ” Saved! Download to persist.');
}
function aeRevertCurrent() { if(!aeCurrentKey||!aeOriginal)return; aeSelectArmor(aeCurrentKey); aeSetStatus('Reverted.'); }
function aeNewArmor() {
    const key = 'new_armor_' + Date.now();
    aeWorkingCopy[key] = { name:'New Armor', baseDefense:2, magicDefense:0, level:1, quality:'normal', cost:0, slot:'armor', description:'' };
    aeRefreshList(); aeSelectArmor(key);
    document.getElementById('ae_key').select();
}
function aeDeleteCurrent() {
    if(!aeCurrentKey){aeSetStatus('Nothing selected.');return;}
    if(!confirm('Delete armor "'+aeCurrentKey+'"?'))return;
    delete aeWorkingCopy[aeCurrentKey];
    aeCurrentKey=null; aeOriginal=null;
    aeRefreshList(); aeShowPlaceholder();
}
function aeGenerateJS() {
    const sorted = Object.entries(aeWorkingCopy).sort((a,b)=>(a[1].level||0)-(b[1].level||0)||a[0].localeCompare(b[0]));
    const lines = [
        '// armor-new.js - Armor Database',
        '// Generated by Dungeon Editor on ' + new Date().toLocaleString(),
        '',
        'const ARMOR = {'
    ];
    sorted.forEach(([k,v],i) => {
        const comma = i < sorted.length-1 ? ',' : '';
        lines.push('    '+k+': '+JSON.stringify(v,null,4).replace(/\n/g,'\n    ')+comma);
    });
    lines.push('};');
    lines.push("if (typeof module !== 'undefined' && module.exports) { module.exports = { ARMOR }; }");
    return lines.join('\n');
}
function aeDownloadJS() { const fn = dbDownload(aeGenerateJS(), 'armor-new.js'); if(fn) aeSetStatus('âœ” Downloaded as '+fn); }
function aeCopyJS() { dbCopy(aeGenerateJS(), aeSetStatus); }
function aeSetStatus(m) { const el = document.getElementById('aeStatus'); if(el) el.textContent = m; }
document.getElementById('armorEditorOverlay').addEventListener('click', e => { if(e.target===e.currentTarget) aeClose(); });
</script>
</body>
</html>
